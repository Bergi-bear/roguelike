gg_rct_R1 = nil
function InitGlobals()
end

function CreateRegions()
    local we
    gg_rct_R1 = Rect(-3008.0, 1472.0, -1728.0, 2752.0)
end

--CUSTOM_CODE
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 12.02.2021 16:08
---

do
    TimerStart(CreateTimer(), .1, false, function()
    CreationPeonsForAllPlayer()
        --InitWASD(hero) --переместить в первый выбор героя
    end)
end

function CreationPeonsForAllPlayer()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        if IsPlayerSlotState(Player(i),PLAYER_SLOT_STATE_PLAYING) and GetPlayerController(Player(i))==MAP_CONTROL_USER then
            local x,y=GetPlayerStartLocationX(Player(i)),GetPlayerStartLocationY(Player(i))
            local hero=CreateUnit(Player(i),HeroID,x,y,0)
            UnitAddAbility(hero,FourCC("abun"))
            UnitAddAbility(hero,FourCC("Abun"))
            UnitAddAbility(hero,FourCC("AInv"))
            UnitAddForceSimple(hero, 0, 10, 10)
            BlzSetUnitMaxHP(hero,10000)
            HealUnit(hero,10000)
            --print("создан пеон")
            SelectUnitForPlayerSingle(hero,Player(i))
            InitWASD(hero)
        end
    end
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 14.02.2021 2:37
---

function SpellSlashQ(data)
    local hero=data.UnitHero
    local x,y=MoveXY(GetUnitX(hero),GetUnitY(hero),80,GetUnitFacing(hero))
    DestroyEffect(AddSpecialEffect("SystemGeneric\\ThunderclapCasterClassic",x,y))
    UnitDamageArea(hero,250,x,y,200)
    --[[
    local path="replaceabletextures\\selection\\rangeindicator"
    local radius=400
    local timed=3
    local CircleImage=CreateImage(path,radius,radius,radius,OutPoint,OutPoint,0,0,0,0,4)
    SetImageColor(CircleImage,0,255,0,255)
    SetImageRenderAlways(CircleImage, true)
    ShowImage(CircleImage,false)

    local xs,ys=x-radius/2-16,y-radius/2-16
    SetImagePosition(CircleImage,xs,ys,0)

    TimerStart(CreateTimer(), TIMER_PERIOD, true, function()


        if GetLocalPlayer()==GetOwningPlayer(hero) then
            ShowImage(CircleImage,true)
        end

        if timed then
            timed=timed-TIMER_PERIOD
            if timed <=1 then
                SetImageColor(CircleImage,0,255,0,math.floor(255*timed))
            end
        end

            if timed <=0 then
                SetImagePosition(CircleImage,OutPoint,OutPoint,0)
                DestroyImage(CircleImage)
                DestroyTimer(GetExpiredTimer())
            end
    end)
    ]]
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 13.02.2021 22:18
---
function StartAndReleaseSpin(data)
    local hero=data.UnitHero
    local a=0
    local sec=0
    TimerStart(CreateTimer(),TIMER_PERIOD, true, function()
        local x,y=GetUnitXY(hero)
        local eff=nil
        BlzSetUnitFacingEx(hero,a)
        a=a-20
        sec=sec+TIMER_PERIOD
        if sec>=0.1 then
            eff=AddSpecialEffect("Hive\\Culling Slash\\Culling Slash\\Culling Slash",x,y)
            DestroyEffect(eff)
            BlzSetSpecialEffectScale(eff,0.5)
            sec=0
            if UnitDamageArea(hero,25,x,y,150) then
                normal_sound("Sound\\Units\\Combat\\MetalMediumBashStone"..GetRandomInt(1,3),GetUnitXY(data.UnitHero))
            end
        end

        local t=CreateTimer()
        local sec2=0
        TimerStart(t,TIMER_PERIOD64, true, function()
            sec2=sec2+TIMER_PERIOD
            if sec2>=1 then
                PauseTimer(t)
                DestroyTimer(t)
            end
            BlzSetSpecialEffectPosition(eff,GetUnitX(hero),GetUnitY(hero),BlzGetUnitZ(hero)+30)
        end)
        if not data.isSpined then
            --print("stopspin")
            DestroyTimer(GetExpiredTimer())

        end
    end)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 14.02.2021 23:57
---

do
    TimerStart(CreateTimer(), 1, false, function()
        TempEnemyID={FourCC("nsko"),FourCC("nsog"),FourCC("nsoc"),FourCC("nsko"),FourCC("nsog"),FourCC("nsoc")}
        effPenta="Hive\\Magic CirclePentagram\\Magic CirclePentagram Fire\\MagicCircle_Fire.mdl"
        --print("start")
        LiveOnWave={}
        StartWave(1,10)

    end)
end

function CreateCreepDelay(id,x,y,delay,k)
    local eff=AddSpecialEffect(effPenta,x,y)
    TimerStart(CreateTimer(),delay, false, function()
        --print("create new")
        local new=CreateUnit(Player(1),id,x,y,GetRandomInt(0,360))
        IssueTargetOrder(new,"attack",HERO[0].UnitHero)
        DestroyEffect(eff)
        TimerStart(CreateTimer(),delay, true, function()
            if not UnitAlive(new) then
                DestroyTimer(GetExpiredTimer())
                LiveOnWave[k]=LiveOnWave[k]-1
                --print(LiveOnWave[k])
            end
        end)
    end)
end

function StartWave(k,max)
   -- print("start wave "..max)
    LiveOnWave[k]=max
    --print(0)
    for i = 0, max do
        --print(1)
        local loc=GetRandomLocInRect(gg_rct_R1)
        --print(2)
        local x,y=GetLocationX(loc),GetLocationY(loc)
        --print(i)
        CreateCreepDelay(TempEnemyID[k],x,y,1.5,k)
    end
    TimerStart(CreateTimer(),1, true, function()
        if LiveOnWave[k]<0 then
            --print("все убиты, стартуем новую волну")
            DestroyTimer(GetExpiredTimer())
            StartWave(k+1,10)
        end
    end)
end
function OnPostDamage()
	local damage     = GetEventDamage() -- число урона
	local damageType = BlzGetEventDamageType()
	if damage < 1 then return end
	local target= GetTriggerUnit() -- тот кто получил урон
	local caster= GetEventDamageSource() -- тот кто нанёс урон

	if GetUnitTypeId(target)==HeroID and false then -- какое нибудь условие наличие пассивки
		--print("Герой получил урон")
		local data=HERO[GetPlayerId(GetOwningPlayer(target))]
		if data.CustomAbilities[1].Ready then --Q
			--print("Есть способность уворот")
			if not data.FrameTable[9].OnCD then
				StarFrameCooldown(data.FrameTable[9],data.CustomAbilities[1].CD)
				data.EvasionState=true

				PhaseEvade(data)
			else
				AddSpeedToFrameCD(data.FrameTable[9],1)
			end
			if data.EvasionState then
				BlzSetEventDamage(0)
				FlyTextTagMiss(target,"Промах",GetOwningPlayer(target))
				if IsUnitEnemy(caster,GetOwningPlayer(target)) then
					FlyTextTagMiss(target,"Промах",GetOwningPlayer(caster))
				end
			end
		end
	end

	if GetUnitTypeId(caster)==HeroID and false then
		local mainData=HERO[GetPlayerId(GetOwningPlayer(caster))]
		local data=mainData.FrameTable[6] --пассивка крит
		if damage>=10 then
			if not data.OnCD then
				StarFrameCooldown(data,mainData.CustomAbilities[5].CD) --
				BlzFrameSetVisible(data.ReadyIndicator,false)
				--print("критический удар")
				FlyTextTagCriticalStrike(target,R2I(damage*5).."!",GetOwningPlayer(caster))
				BlzSetEventDamage(damage*5)
			else
				AddSpeedToFrameCD(data,1)
			end
		end
	end
		--любой получил урон

end


function InitDamage()
	local DamageTrigger = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		--TriggerRegisterPlayerUnitEvent(DamageTrigger, Player(i), EVENT_PLAYER_UNIT_DAMAGING) -- До вычета брони
		TriggerRegisterPlayerUnitEvent(DamageTrigger, Player(i), EVENT_PLAYER_UNIT_DAMAGED) -- После вычета брони
	end
	TriggerAddAction(DamageTrigger, OnPostDamage)
end



function UnitDamageAreaOld(u,damage,x,y,range,ZDamageSource,EffectModel)
	local isdamage=false
	local e=nil
	local hero=nil
	GroupEnumUnitsInRange(perebor,x,y,range,nil)
	while true do
		e = FirstOfGroup(perebor)
		if e == nil then break end
		if UnitAlive(e) and UnitAlive(u) and IsUnitEnemy(e,GetOwningPlayer(u))  and true then --and IsUnitZCollision(e,ZDamageSource)  -- момент урона
			--print("вызов проблемной функции "..GetPlayerName(GetOwningPlayer(u)).." "..GetUnitName(u).." "..damage)
			if EffectModel~=nil then
				--print("эффект"..EffectModel)
				local DE=AddSpecialEffect(EffectModel,GetUnitX(e),GetUnitY(e))
				BlzSetSpecialEffectZ(DE,ZDamageSource)
				DestroyEffect(DE)
			end
			UnitDamageTarget( u, e, damage, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS )
			--print("урон прошёл для "..GetUnitName(e))
			isdamage=true
			hero=e
		end
		GroupRemoveUnit(perebor,e)
	end
	--DestroyGroup(mperebor)
	--mperebor=nil
	if PointContentDestructable(x,y,range,true,1+damage/4,u) then	isdamage=true	end
	return isdamage, hero
end




GlobalRect=Rect(0,0,0,0)
function PointContentDestructable (x,y,range,iskill,damage,hero)
	local content=false
	local unitZ=GetUnitZ(hero)
	if range==nil then range=80 end
	if iskill==nil then iskill=false end
	--print(GetUnitName(hero))
	SetRect(GlobalRect, x - range, y - range, x + range, y +range)
	EnumDestructablesInRect(GlobalRect,nil,function ()
		local d=GetEnumDestructable()
		if GetDestructableLife(d)>0 and unitZ<=GetTerrainZ(x,y)+50 then
			content=true
			if iskill then
				if not IsDestructableInvulnerable(d) then
					SetDestructableLife(d,GetDestructableLife(d)-damage)
				end
				if GetDestructableLife(d)>=1 then
					SetDestructableAnimation(d,"Stand Hit")
				else
				end
			end
		else
		end
	end)
	return content
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 16.01.2020 23:40
---

GetPlayerMouseX = {}
GetPlayerMouseY = {}
function InitMouseMoveTrigger()
	local MouseMoveTrigger = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		local player = Player(i)
		--if GetPlayerSlotState(player) == PLAYER_SLOT_STATE_PLAYING and GetPlayerController(player) == MAP_CONTROL_USER then
		TriggerRegisterPlayerEvent(MouseMoveTrigger, player, EVENT_PLAYER_MOUSE_MOVE)
		GetPlayerMouseX[i] = 0
		GetPlayerMouseY[i] = 0
		--end
	end

	TriggerAddAction(MouseMoveTrigger, function()
		--print("ismove")
		--print("x="..BlzGetTriggerPlayerMouseX().." y="..BlzGetTriggerPlayerMouseY())
		local FocusUnit=BlzGetMouseFocusUnit()
		--print("фокус юнит"..GetUnitName(FocusUnit))
		local id = GetPlayerId(GetTriggerPlayer())
		if FocusUnit==HERO[id].UnitHero then
			if not HERO[id].IsMainHeroOnHit then
				--	print("Херо он фокус")
			end
			HERO[id].IsMainHeroOnHit=true
		else
			if HERO[id].IsMainHeroOnHit then
				--print("потеря фокуса")
			end
			HERO[id].IsMainHeroOnHit=false
		end


		if BlzGetTriggerPlayerMouseX() ~= 0 then
			GetPlayerMouseX[id] = BlzGetTriggerPlayerMouseX()
			GetPlayerMouseY[id] = BlzGetTriggerPlayerMouseY()
		end
	end)
end

do
	TimerStart(CreateTimer(), 0.1, false, function()
		--InitMouseMoveTriggerFocus()
	end)
end


function InitMouseMoveTriggerFocus()
	local MouseMoveTrigger = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		local player = Player(i)
		--if GetPlayerSlotState(player) == PLAYER_SLOT_STATE_PLAYING and GetPlayerController(player) == MAP_CONTROL_USER then
		TriggerRegisterPlayerEvent(MouseMoveTrigger, player, EVENT_PLAYER_MOUSE_MOVE)
	end
	local FocusOnAnyUnit=false
	local effShield=AddSpecialEffect("Shield",OutPoint,OutPoint)
	local effAttack=AddSpecialEffect("Attack",OutPoint,OutPoint)
	local tShield = CreateTextTag()
	local tAttack = CreateTextTag()

	SetTextTagPos(tShield, OutPoint, OutPoint, 0)
	SetTextTagColor(tShield, 200, 200, 255, 200)
	SetTextTagFadepoint(tShield, 2)
	SetTextTagPermanent(tShield, true)
	BlzSetSpecialEffectScale(effShield,0.3)
	BlzSetSpecialEffectTimeScale(effShield,0)

	SetTextTagPos(tAttack, OutPoint, OutPoint, 0)
	SetTextTagColor(tAttack, 200, 200, 255, 200)
	SetTextTagFadepoint(tAttack, 2)
	SetTextTagPermanent(tAttack, true)
	BlzSetSpecialEffectScale(effAttack,0.3)
	BlzSetSpecialEffectTimeScale(effAttack,0)

	TriggerAddAction(MouseMoveTrigger, function()
		local FocusUnit=BlzGetMouseFocusUnit()
		local id = GetPlayerId(GetTriggerPlayer())

		if not FocusUnit then
			--print("нет фокуса")
			FocusOnAnyUnit=false
			BlzSetSpecialEffectPosition(effShield,OutPoint,OutPoint,0)
			BlzSetSpecialEffectPosition(effAttack,OutPoint,OutPoint,0)
			SetTextTagPos(tShield, OutPoint, OutPoint, 0)
			SetTextTagPos(tAttack, OutPoint, OutPoint, 0)
		end
		if FocusUnit then
			--print("фокус на юните "..GetUnitName(FocusUnit))
			FocusOnAnyUnit=true
			local x,y=GetUnitXY(FocusUnit)
			x=x+48
			y=y-64
			local z=GetTerrainZ(x,y)+25

			BlzSetSpecialEffectPosition(effShield,x,y,z)
			SetTextTagText(tShield, ""..math.floor(BlzGetUnitArmor(FocusUnit)), 0.024)
			SetTextTagPos(tShield, x+32,y-24,z)

			BlzSetSpecialEffectPosition(effAttack,x,y-48,z)
			SetTextTagText(tAttack, ""..math.floor(BlzGetUnitBaseDamage(FocusUnit,0)), 0.024)
			SetTextTagPos(tAttack, x+32,y-24-48,z)
		end
	end)
end

HeroID = FourCC("opeo")
NextPoint=0.039
OutPoint=6000

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 10.01.2020 22:05
--
---Глобалки
TIMER_PERIOD = 0.03125
HERO = {}
do
	local InitGlobalsOrigin = InitGlobals
	function InitGlobals()
		InitGlobalsOrigin()
		perebor = CreateGroup() --1 едиснвенная глобальная группа на всю игру, никакие Destroy Привет гуишники
		--InitSpellTrigger() -- Инициализация функции кастов
		InitHEROTable() -- Инициализация таблицы героев
		--KeyRegistration() -- инициализация отлова нажатия клавиш
		--InitSelectionRegister() -- инициализация выбора
		--print("пост инициализация выбора")
		InitMouseMoveTrigger() -- Запуск отслеживания положения мыши
		InitDamage()
		--InitSoundsA() --Создаём звуки
		--InitUnitDeath() --инициализация смерти
		--CreateGlue()
		TimerStart(CreateTimer(), 0.1, false, function()

			--InitMainFrameTable(HERO[0]) -- мульти создаётся здесь
			--print("заполнение таблицы таблицы")
		end)
	end
end

do
	-- Автоочистка таймеров
	local DestroyTimer_Original = DestroyTimer
	function DestroyTimer(whichTimer)
		PauseTimer(whichTimer)
		DestroyTimer_Original(whichTimer)
	end

end

function InitHEROTable()
	EnableDragSelect(false, false)
	if BlzLoadTOCFile("SystemGeneric\\Main.toc") then
	else
		print("ошибка загрузки SystemGeneric\\Main.toc")
	end
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		HERO[i] = {
			pid = i,
			UnitHero = nil,
			IsInterface = false,
			IsMainHeroOnHit = false,
			EvasionState=false,
			FirePillarState=false,
			StartDrawing=false,
			DestroyDrawing=false,
			effDrawing=nil,
			DrawingTimer=nil,
			CustomAbilities = { -- статичные данные, но менять можно и муи
				[1] = {
					Ready = true,
					CD=10,
					Name="Фазовый сдвиг".." (|cffffcc00".."Пассивная".."|r)",
					Description="При получении урона герой смещается между пространствами и избегает этого урона а также любого последующего в течении 0.5 сек. Атаки по герою уменьшают перезарядку способности на 1 секунду",
					SizeTooltip=7,
				},
				[2] = {
					Ready = true,
					CD=15,
					Name="Огненный столб".." (|cffffcc00".."W ‡ ‡".."|r)",
					Description="Выпускает поток огня впереди себя",
					SizeTooltip=4,
				},
				[3] = {
					Ready = true,
					CD=0.1,
					Name="Поле кактусов".." (|cffffcc00".."E".."|r)",
					Description="Сажает кактусы в указанной точке, сажайте кактусы по 1 или удерживайте левую кнопку мыши зажатой, для массовм посадки. Способность имеет 10 зарядов, перезарядка заряда - 7 секунд ",
					MaxCharges=999,
					ManaCost=10,
					SizeTooltip=9,
				},
				[4] = {
					Ready = true,
					CD=7,
					Name="Массовое вытягивание жизни".." (|cffffcc00".."R".."|r)",
					Description="Отманиает у врагов жизни и передаёт их герою, герой неуязвим во время действия способности, пока испытывает нехватку здоровья и не может вытянуть больше здоровья чем у него недостаёт. Способность может быть отменена. Длительность: 5",
					ManaCost=50,
					SizeTooltip=10,
				},
				[5] = {
					Ready = true,
					CD=20,
					Name="Критический удар".." (|cffffcc00".."Пассивная".."|r)",
					Description="Когда способность готова, герой наносит увеличенный 5 кратный урон следующим любым источником урона, атаки с руки уменьшают перезарядку на 1 секунду",
					SizeTooltip=7,
				},
				[6] = {
					Ready = true,
					CD=20,
					Name="Движение".." (|cffffcc00".."ПКМ".."|r)",
					Description="Отдаёт юниту приказ движения в указанную точку, со скорость ".."|cffffcc00".."ms".."|r",
					SizeTooltip=5,
					Updatable=true
				},
				[7] = {
					Ready = true,
					CD=20,
					Name="Стоп".." (|cffffcc00".."S".."|r)",
					Description="Прерывает все текущие действия",
					SizeTooltip=4,
					Updatable=true
				},
				[8] = {
					Ready = true,
					CD=20,
					Name="Удерживать позицию".." (|cffffcc00".."H".."|r)",
					Description="Закрепляет текущую позицию как постоянную, но юнит может продолжать атаковать врагов в зоне дальности атаки ".."|cffffcc00".."ar".."|r",
					SizeTooltip=6,
					Updatable=true
				},
				[9] = {
					Ready = true,
					CD=20,
					Name="Атака".." (|cffffcc00".."A".."|r)",
					Description="Атакует указанное существо или первое существо, что попадётся на пути. Сила атаки: ap, Скорость атаки: as",
					SizeTooltip=6,
					Updatable=true
				},
				D = {},
				F = {}
			},
			FrameTable = {},
			ReleaseQ=false,
			ReleaseW=false,
			ReleaseE=false,
			ReleaseR=false,
			ReleaseLMB=false,
			ReleaseRMB=false,
			ReleaseESC=false,
			ReleaseTAB=false,
		}
	end
end


function InitMainFrameTable(data)
	--	local frames={}
	local k = 0
	local k2 = 1
	local greed = 0.0045
	for i = 1, 12 do -- заполнение таблицы пустышек
		data.FrameTable[i] = {
			SelfFrame = nil, -- Основной фрейм
			IconFrame = nil, -- Его иконка
			CdIndicatorFrame = nil, -- Фрейм перезарядки
			ToolTip=nil, -- фрейм подскизки, общий
			ChargesFrame=nil, -- фрейм зарядов
			ChargesFrameText=nil, --Число зарядов
			Number = i, -- номер фрейма 1-12 сверху вниз слева направо
			PosX = 0, -- координаты на сетке
			PosY = 0,
			OnCD = false, -- на кд
			CurrentCDTime = 0,  --время кд
			Timer = nil, --???
			PercentAmount = 0, -- фрейм показывающий число процентов для перезарядки
			OnPaused = false, -- кд на паузе
			Full = 0, --???
			CurrentCD = 0, -- Кд фрейма в момент его старта
			MouseOnFrame = false, -- мышка на кнопке
			HotKeyPos=0, -- номер фрейма по порядку QWER
			Charges=0, -- число зарядов
		}
		local data2 = data.FrameTable[i] --заполенеие ячеек, не трогать никогда
		k = k + 1
		if k == 5 then
			k = 1
			k2 = k2 + 1
		end
		data2.PosX = 0.637 + ((NextPoint + greed) * (k - 1))
		data2.PosY = 0.113 - ((NextPoint + greed) * (k2 - 1))
	end
	return data.FrameTable
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 20.05.2020 0:33
---

function KeyRegistration()


	-----------------------------------------------------------------LMB and Any Mouse
	local TrigPressLMB = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		TriggerRegisterPlayerEvent(TrigPressLMB, Player(i), EVENT_PLAYER_MOUSE_DOWN)
	end
	TriggerAddAction(TrigPressLMB, function()
		--print("any")
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.MarkIsActivated = false
		if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_LEFT then
			--это леваый клик всё внутри LMB
			data.ReleaseLMB = true
			if data.IsMainHeroOnHit then
				--print("123")
				if not data.IsInterface and data.UnitHero then
				--	print("SetInterfaceToQuinOfPaint".." через более быстрый выбор")
					--print(111)
					ChangeInterfaceToQuin(data)
					data.IsInterface=true
				end
			end
		end
		if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_RIGHT then
			data.ReleaseRMB = true
			if data.StartDrawing then
				DestroyEatingCactus(data,data.FrameTable[11],false)
				TimerStart(CreateTimer(), 0.001, false, function()
					if IssueImmediateOrder(data.UnitHero,"stop") then
						--print("stop?")
					end
				end)
				--data.DestroyDrawing=true
				--print("Нажал правую, отменяем маркер")
			end
		end
	end)
	local TrigDePressLMB = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		TriggerRegisterPlayerEvent(TrigDePressLMB, Player(i), EVENT_PLAYER_MOUSE_UP)
	end

	TriggerAddAction(TrigDePressLMB, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_LEFT then

			data.ReleaseLMB = false
		end
		if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_RIGHT then
			--data.ReleaseRMB = false
		end
	end)


	-----------------------------------------------------------------OSKEY_Q
	local gg_trg_EventUpQ = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpQ, Player(i), OSKEY_Q, 0, true)
	end
	TriggerAddAction(gg_trg_EventUpQ, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		if not data.ReleaseQ then
			data.ReleaseQ = true

			--data.MarkIsActivated=false
			--print("Q is Pressed Mark Creation")
			--MarkCreatorQ(data)
		end
	end)
	local TrigDepressQ = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressQ, Player(i), OSKEY_Q, 0, false)
	end
	TriggerAddAction(TrigDepressQ, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.ReleaseQ = false
	end)
	-----------------------------------------------------------------OSKEY_W --в это карте это якорь
	local gg_trg_EventUpW = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpW, Player(i), OSKEY_W, 0, true)

	end
	TriggerAddAction(gg_trg_EventUpW, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		if not data.ReleaseW then
			data.ReleaseW = true
			--print("кнопка W нажата, нужен огонь")
			--if not data.FrameTable[10].OnCD then --TODO реал реди
			if CustomAbilityIsReady(data,data.FrameTable[10]) then
				StarFrameCooldown(data.FrameTable[10],10)
				data.FirePillarState=true
				StartFirePillar(data)
			end
			--MarkCreatorW(data)
		end
	end)
	local TrigDepressW = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressW, Player(i), OSKEY_W, 0, false)
	end
	TriggerAddAction(TrigDepressW, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.ReleaseW = false
	end)
	-----------------------------------------------------------------OSKEY_E
	local gg_trg_EventUpE = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpE, Player(i), OSKEY_E, 0, true)
	end
	TriggerAddAction(gg_trg_EventUpE, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		if not data.ReleaseE then
			data.ReleaseE = true
			if CustomAbilityIsReady(data,data.FrameTable[11]) and not data.StartDrawing then
				EatingCactus(data)
				data.StartDrawing=true
				data.DestroyDrawing=false
			end
		end
	end)
	local TrigDepressE = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressE, Player(i), OSKEY_E, 0, false)
	end
	TriggerAddAction(TrigDepressE, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.ReleaseE = false
	end)
	-----------------------------------------------------------------OSKEY_R
	local gg_trg_EventUpR = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpR, Player(i), OSKEY_R, 0, true)
	end
	TriggerAddAction(gg_trg_EventUpR, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		if not data.ReleaseR then
			data.ReleaseR = true
			if CustomAbilityIsReady(data,data.FrameTable[12]) and not data.StartDrawing then
				--print("запуск высасывания черех хоткей")
				UnitUsedLifeStealAbility(data,data.FrameTable[12])
			end
		end
	end)
	local TrigDepressR = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressR, Player(i), OSKEY_R, 0, false)
	end
	TriggerAddAction(TrigDepressR, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.ReleaseR = false
	end)

	-----------------------------------------------------------------OSKEY_ESC
	local gg_trg_EventUpESC = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpESC, Player(i), OSKEY_ESCAPE, 0, true)
	end
	TriggerAddAction(gg_trg_EventUpESC, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		if not data.ReleaseESC then
			data.ReleaseESC = true
			if data.StartDrawing then
				DestroyEatingCactus(data,data.FrameTable[11],false)
			end
			--data.MarkIsActivated=false
			--print("Q is Pressed Mark Creation")
			data.MarkIsActivated = false
		end
	end)
	local TrigDepressESC = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressESC, Player(i), OSKEY_ESCAPE, 0, false)
	end
	TriggerAddAction(TrigDepressESC, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.ReleaseESC = false
	end)
	-----------------------------------------------------------------OSKEY_TAB
	local gg_trg_EventUpTAB = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpTAB, Player(i), OSKEY_TAB, 0, true)
	end
	TriggerAddAction(gg_trg_EventUpTAB, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		local u = GetMainSelectedUnit(GetSelectedUnitIndex())
		if u==data.UnitHero then
			--print(222)
			ChangeInterfaceToQuin(data)
		else
			--print("юнит не выбран через TAB")
			--if not data.IsMainHeroOnHit then
				ResetInterfaceToDefault(data)
		--	end
		end



		if not data.ReleaseTAB then
			data.ReleaseTAB = true
			--data.MarkIsActivated=false
			--print("Q is Pressed Mark Creation")
			data.MarkIsActivated = false
		end
	end)
	local TrigDepressTAB = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressESC, Player(i), OSKEY_TAB, 0, false)
	end
	TriggerAddAction(TrigDepressESC, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		local data = HERO[pid]
		data.ReleaseTAB = false
	end)
end-- do not copyend
------------------------------------------------------------------------------------------- EVENT_PLAYER_UNIT_SELECTED
function InitSelectionRegister()
	local this = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		TriggerRegisterPlayerUnitEvent(this, Player(i), EVENT_PLAYER_UNIT_SELECTED, nil)
	end
	TriggerAddAction(this, function()
		local hero = GetTriggerUnit()
		local data = HERO[GetPlayerId(GetTriggerPlayer())]

		if (IsUnitType(hero, UNIT_TYPE_HERO) and GetOwningPlayer(hero) == GetTriggerPlayer() and GetUnitTypeId(hero) == HeroID) or true then
			--print("hero is select")
			if not data.UnitHero then --первый выбор героя
				data.UnitHero = hero
				--AddQuest(hero,0,0,"Доберитесь до указанной точки")
				--BlzSetUnitIntegerField(hero,UNIT_IF_MOVE_TYPE,1)
				--print(" смена типа движения ")
				--CreateAbilityFrame(5)
				--print("создание кнопок интерфейса ")
				CreateAbilityFrame(data,9,"ReplaceableTextures\\PassiveButtons\\PASBTNEvasion", "passive",1)
				CreateAbilityFrame(data,10,"ReplaceableTextures\\CommandButtons\\BTNFireForTheCannon", "active",2)
				CreateAbilityFrame(data,11,"ReplaceableTextures\\CommandButtons\\BTNReplenishHealth", "active",3)
				CreateAbilityFrame(data,12,"ReplaceableTextures\\CommandButtons\\BTNLifeDrain", "active",4)
				CreateAbilityFrame(data,6,"ReplaceableTextures\\PassiveButtons\\PASBTNCriticalStrike", "passive",5)

				CreateAbilityFrame(data,1,"ReplaceableTextures\\CommandButtons\\btnmove", "active",6) --move
				CreateAbilityFrame(data,2,"ReplaceableTextures\\CommandButtons\\btnstop", "active",7)
				CreateAbilityFrame(data,3,"ReplaceableTextures\\CommandButtons\\btnholdposition", "active",8)
				CreateAbilityFrame(data,4,"ReplaceableTextures\\CommandButtons\\btnattack", "active",9)

				--CreateAbilityFrame(data,9,"ReplaceableTextures\\PassiveButtons\\PASBTNEvasion", "passive",1)
				TimerStart(CreateTimer(), 0.01, true, function()
					local u = GetMainSelectedUnit(GetSelectedUnitIndex())
					if u==data.UnitHero then
						--print(333)
						ChangeInterfaceToQuin(data)
					else
						--print("юнит не выбран")
						if not data.IsMainHeroOnHit then
							ResetInterfaceToDefault(data)
						end
					end
				end)

			end
			if not data.IsInterface then
				--print("SetInterfaceToQuinOfPaint")
				--print(444)
				ChangeInterfaceToQuin(data)
				data.IsInterface=true
			end
		else
			--print("ResetInterfaceToDefault")
			ResetInterfaceToDefault(data)
			data.IsInterface=false
		end

	end)
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 27.05.2020 23:15
---
local realTimerStart = TimerStart
TimerStart = function(timer, duration, repeating, callback)
	local pcallback = function()
		if callback == nil then return end
		local status, err = pcall(callback)
		if not status then
			print(err)
		end
	end
	realTimerStart(timer, duration, repeating, pcallback)
end

local realTriggerAddAction = TriggerAddAction
TriggerAddAction = function(trig, callback)
	local pcallback = function()
		local status, err = pcall(callback)
		if not status then
			print(err)
		end
	end
	realTriggerAddAction(trig, pcallback)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 06.02.2020 12:47
---
function CreateAndForceBullet(hero, angle, speed, effectmodel, xs, ys, damage,maxDistance)
	local CollisionRange = 80
	if not damage then
		damage = 200
	end
	if not xs then
		xs,ys=GetUnitXY(hero)
	end
	if not maxDistance then
		maxDistance=1000
	end
	local zhero = GetUnitZ(hero) + 60
	local bullet = AddSpecialEffect(effectmodel, xs, ys)
	BlzSetSpecialEffectYaw(bullet, math.rad(angle))
	local CollisionEnemy = false
	local CollisisonDestr = false
	local DamagingUnit = nil
	if effectmodel == "Abilities\\Weapons\\FireBallMissile\\FireBallMissile" then
		--print("Пуля из мушкета капитана")
		BlzSetSpecialEffectScale(bullet, 2)
		--zhero = GetUnitZ(hero) + 120
	end

	BlzSetSpecialEffectZ(bullet, zhero)
	local angleCurrent = angle
	local heroCurrent = hero
	local dist = 0
	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		dist = dist + speed
		local x, y, z = BlzGetLocalSpecialEffectX(bullet), BlzGetLocalSpecialEffectY(bullet), BlzGetLocalSpecialEffectZ(bullet)
		local zGround = GetTerrainZ(MoveX(x, speed * 2, angleCurrent), MoveY(y, speed * 2, angleCurrent))
		BlzSetSpecialEffectYaw(bullet, math.rad(angleCurrent))
		BlzSetSpecialEffectPosition(bullet, MoveX(x, speed, angleCurrent), MoveY(y, speed, angleCurrent), z - 2)

		SetFogStateRadius(GetOwningPlayer(heroCurrent), FOG_OF_WAR_VISIBLE, x, y, 400, true)-- Небольгая подсветка

		local ZBullet = BlzGetLocalSpecialEffectZ(bullet)

		CollisionEnemy, DamagingUnit = UnitDamageArea(heroCurrent, 0, x, y, CollisionRange)

		CollisisonDestr = PointContentDestructable(x, y, CollisionRange, false,0,hero)
		local PerepadZ = zGround - z
		if dist > maxDistance or CollisionEnemy or CollisisonDestr or IsUnitType(DamagingUnit, UNIT_TYPE_STRUCTURE) or PerepadZ > 20 then
			PointContentDestructable(x, y, CollisionRange, true,0,hero)
			UnitDamageArea(hero, damage, x, y, CollisionRange)
			if DamagingUnit  and IsUnitType(hero,UNIT_TYPE_HERO) then
				-- тут был показ урона
			end
			DestroyEffect(bullet)
			DestroyTimer(GetExpiredTimer())


			if not DamagingUnit then
				DestroyEffect(bullet)
				DestroyTimer(GetExpiredTimer())
			end
		end
	end)
end



---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 30.06.2020 12:49
---
function CustomAbilityIsReady(mainData,data)
	local isReady=false
	local hero= mainData.UnitHero

	if mainData.CustomAbilities[data.HotKeyPos].Ready -- список условий ограничивающих каст этой способности
			and not mainData.OnCD
			and UnitAlive(hero)
			--and GetUnitState(hero,UNIT_STATE_MANA)>=BlzGetUnitAbilityManaCost(hero,abiID,GetUnitAbilityLevel(hero,abiID)-1)
			and IsUnitSelected(hero,GetOwningPlayer(hero))
	then
		isReady=true
	end
	return isReady
end


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 29.06.2020 23:06
---
cactusModel = "Doodads\\Barrens\\Plants\\Cactus\\Cactus" .. "" --0-9
function DestroyEatingCactus(mainData,data,WCD)
	mainData.StartDrawing=false
	local hero=mainData.UnitHero
	DestroyTimer(mainData.DrawingTimer)
	BlzSetSpecialEffectPosition(mainData.effDrawing, OutPoint, OutPoint, 0)
	DestroyEffect(mainData.effDrawing)
	mainData.effDrawing = nil

	--CreateCactus(mainData, x, y, r,curAngle)
	if WCD then
		--print("отмена с кд")
		--StarFrameCooldown(data,0)
		SelectUnitForPlayerSingle(hero,GetOwningPlayer(hero))
	else
	--	print("одиночный клик?")
	end
	EnableSelect(true,true)
	return WCD
end


function EatingCactus(mainData)
	--print("курсор превращается в кактус")
	local hero = mainData.UnitHero
	local lastX, lastY = GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid]
	local r = GetRandomInt(0, 9)

	mainData.effDrawing = AddSpecialEffect(cactusModel .. r, lastX, lastY)
	BlzSetSpecialEffectAlpha(mainData.effDrawing,60)
	BlzSetSpecialEffectYaw(mainData.effDrawing, math.rad(GetRandomReal(0, 360)))


	local lastDistance = 0
	local range=80
	local angleCast = AngleBetweenXY(GetUnitX(hero), GetUnitY(hero), GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid]) / bj_DEGTORAD
	local curAngle = angleCast
	local distance = DistanceBetweenXY(GetUnitX(hero), GetUnitY(hero), GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid])
	local cutDistance = distance
	local starDrawing=false
	local data=mainData.FrameTable[11]
	EnableSelect(false,false)
	SelectUnitForPlayerSingle(hero,GetOwningPlayer(hero))
	mainData.DrawingTimer=CreateTimer()


	TimerStart(mainData.DrawingTimer, TIMER_PERIOD, true, function()
		distance = DistanceBetweenXY(GetUnitX(hero), GetUnitY(hero), GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid])
		cutDistance = math.lerp(cutDistance, distance, TIMER_PERIOD * 16)
		angleCast = AngleBetweenXY(GetUnitX(hero), GetUnitY(hero), GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid]) / bj_DEGTORAD
		curAngle = lerpTheta(curAngle, angleCast, TIMER_PERIOD * 16)

		local xp, yp = GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid]
		local x, y = MoveXY(GetUnitX(hero), GetUnitY(hero), cutDistance, curAngle)
		local distanceMove = DistanceBetweenXY(xp, yp, lastX, lastY)

		if IsPointCanCreatedCactus(mainData,x,y)  then
			BlzSetSpecialEffectColor(mainData.effDrawing,255,255,255)
			BlzSetSpecialEffectAlpha(mainData.effDrawing,60)
		else
			BlzSetSpecialEffectColor(mainData.effDrawing,255,0,0)
			BlzSetSpecialEffectAlpha(mainData.effDrawing,128)
		end

		if mainData.ReleaseLMB  then-- кнопка хажата
			starDrawing=true
			lastDistance = lastDistance + distanceMove
		else
			if starDrawing or mainData.DestroyDrawing then
				if DestroyEatingCactus(mainData,data,true) then
					CreateCactus(mainData, x, y, r,curAngle)
				end

				return
			end
		end
		if lastDistance > range then
			DestroyEatingCactus(mainData,data,false)

			if CustomAbilityIsReady(mainData,data) then
				EatingCactus(mainData)
			end

			if lastDistance>range*2 then
				local int = R2I(lastDistance / range)
				for i = 0, int do
					local angle = AngleBetweenXY(lastX, lastY, xp, yp) / bj_DEGTORAD
					--print(angle)
					r = GetRandomInt(0, 9)
					local nx, ny = MoveXY(lastX, lastY, range * i, angle)
					--AddSpecialEffect(cactusModel..r,nx,ny)
					CreateCactus(mainData, nx, ny, r,angle)
					--print("рисуем недостающие кактусы "..i)
				end
			else
				CreateCactus(mainData, x, y, r,curAngle)
			end
		end
		lastX, lastY = x, y
		local z = GetTerrainZ(x, y)
		if mainData.effDrawing then
			BlzSetSpecialEffectPosition(mainData.effDrawing, x, y, z)
			BlzSetSpecialEffectYaw(mainData.effDrawing, math.rad(curAngle))
		end
	end)
end

function CreateCactus(mainData, x, y, r,angle)
	local eff=nil
	local timeLife = CreateTimer()
	local data=mainData.FrameTable[11]
	if data.Charges>0 then
		if IsPointCanCreatedCactus(mainData, x, y) then
			data.Charges=data.Charges-1
			eff = AddSpecialEffect(cactusModel .. r, x, y)
			BlzSetSpecialEffectYaw(eff, math.rad(angle))
		end
	else
		mainData.ReleaseLMB=false
		mainData.DestroyDrawing=true
		--print("Зарядов больше нет")
	end

	TimerStart(timeLife, TIMER_PERIOD, true, function()
		-- урон и отталкивание
		--Кактус пикает группу вокруг себя
		local e=nil
		GroupEnumUnitsInRange(perebor,x,y,80,nil)
		while true do
			e = FirstOfGroup(perebor)

			if e == nil then break end
			if UnitAlive(e) and IsUnitEnemy(e,GetOwningPlayer(mainData.UnitHero)) then
				local angleBU=AngleBetweenXY(x,y,GetUnitXY(e))/ bj_DEGTORAD
				if onForces[GetHandleId(e)] or onForces[GetHandleId(e)]==nil then
					--print("урон?")
					UnitDamageTarget( mainData.UnitHero, e, 20, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS )
				end
				UnitAddForceSimple(e,angleBU,30,180)
			end
			GroupRemoveUnit(perebor,e)
		end

	end)
	TimerStart(CreateTimer(), 10, false, function()
		DestroyTimer(GetExpiredTimer())
		DestroyTimer(timeLife)
		BlzSetSpecialEffectPosition(eff, OutPoint, OutPoint, 0)
		DestroyEffect(eff)
	end)
end

function IsPointCanCreatedCactus(mainData,x,y)
	return not (IsTerrainPathable(x, y,PATHING_TYPE_WALKABILITY)
			or not IsVisibleToPlayer(x, y,GetOwningPlayer(mainData.UnitHero))
			or DistanceBetweenXY(x,y,GetUnitXY(mainData.UnitHero))>=1000
	)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 25.06.2020 22:27
---
function PhaseEvade(data)
	local hero=data.UnitHero
	local duration=0.5
	local sx,sy=GetUnitXY(hero)
	--local angle=0
	local speed=80
	local IsTurn=1
	local maxRange=speed/2

	local eff=AddSpecialEffect("units\\demon\\Demoness\\Demoness",GetUnitXY(hero))
	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		duration=duration-TIMER_PERIOD
		local angle=GetUnitFacing(hero)-90
		local z,x,y=GetUnitZ(hero),MoveXY(GetUnitX(hero),GetUnitY(hero),speed*IsTurn,angle)

		BlzSetSpecialEffectPosition(eff,x,y,z)
		BlzSetSpecialEffectYaw(eff,math.rad(GetUnitFacing(hero)))
		--SetUnitX(hero,x)
		--SetUnitY(hero,y)

		--speed=speed-10
		--maxRange=maxRange-10
		--print(maxRange)
		if  DistanceBetweenXY(x,y,GetUnitXY(hero))>=maxRange then
			IsTurn=-IsTurn
		end
		if duration<=0 then
			data.EvasionState=false
			DestroyTimer(GetExpiredTimer())
			BlzSetSpecialEffectPosition(eff,OutPoint,OutPoint,0)
			DestroyEffect(eff)
			--SetUnitPositionSmooth(hero,sx,sy)
		end
	end)
end


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 26.06.2020 14:56
---
function StartFirePillar(data)
	local effModel="Abilities\\Weapons\\FireBallMissile\\FireBallMissile"
	local hero=data.UnitHero
	local angleCast = GetUnitFacing(hero)--AngleBetweenXY(GetUnitX(hero), GetUnitY(hero), GetPlayerMouseX[data.pid], GetPlayerMouseY[data.pid]) / bj_DEGTORAD
	local curAngle=angleCast

	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		angleCast = AngleBetweenXY(GetUnitX(hero), GetUnitY(hero), GetPlayerMouseX[data.pid], GetPlayerMouseY[data.pid]) / bj_DEGTORAD
		curAngle = lerpTheta(curAngle, angleCast, TIMER_PERIOD * 8)
		--angle=GetUnitFacing(hero)
		if not data.FrameTable[10].OnCD then
			data.FirePillarState=false
		end

		if data.FirePillarState then
			local x,y=MoveXY(GetUnitX(hero),GetUnitY(hero),50,curAngle)
			CreateAndForceBullet(hero,curAngle,50,effModel,x,y,5,250)
		else
			DestroyTimer(GetExpiredTimer())
		end
		if not UnitAlive(hero) then -- и прочие услоия прерывания огнемёта
			DestroyTimer(GetExpiredTimer())
		end
	end)
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 06.07.2020 22:54
---
---
function UnitUsedLifeStealAbility(mainData,data)
	if StartLifeStealArea(mainData,data,500) then
		StarFrameCooldown(data,12)
		CallingBarCreate(mainData.UnitHero,5,"Высасывание жизни",false)
	else
		--print("Нет целей, показать радиус способности")
		CreateVisualMarkerRadius(data,1000,mainData.UnitHero,nil,nil,data.Number,0.5)
	end
end



function StartLifeStealArea (mainData,data,area)
	local hero=mainData.UnitHero
	local x,y=GetUnitXY(hero)
	local e=nil
	GroupEnumUnitsInRange(perebor,x,y,area,nil)
	local hasUnit=false
	while true do
		e = FirstOfGroup(perebor)

		if e == nil then break end
		if UnitAlive(e) and IsUnitEnemy(e,GetOwningPlayer(hero)) and not IsUnitType(e,UNIT_TYPE_STRUCTURE) then
			--print(GetUnitName(e))
			--StartLifeStealUnit(hero,e)
			MoveEffFrom2Unit(hero,e)
			hasUnit=true
		end
		GroupRemoveUnit(perebor,e)
	end
	return hasUnit
end


function MoveEffFrom2Unit(hero,e)
	local duration=5
	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		duration=duration-TIMER_PERIOD
		if duration<=0 then
			DestroyTimer(GetExpiredTimer())
		end
		local eff= AddSpecialEffect("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",GetUnitXY(e))
		TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
			local z, x,y=GetUnitZ(hero)+100,GetUnitXY(hero)
			local ze,xe,ye=GetUnitZ(e)+50,GetUnitXY(e)

			local effX,effY=BlzGetLocalSpecialEffectX(eff),BlzGetLocalSpecialEffectY(eff)
			local angle=AngleBetweenXY(effX,effY,x,y) / bj_DEGTORAD
			local nx,ny=MoveXY(effX,effY,15,angle)
			BlzSetSpecialEffectPosition(eff, nx,ny, 50)
			BlzSetSpecialEffectYaw(eff,math.rad(angle))
			local dist=DistanceBetweenXY(x,y,nx,ny)
			--print(dist)
			if dist<=30 then

				--print("эффект долетел")
				DestroyTimer(GetExpiredTimer())
				BlzSetSpecialEffectPosition(eff, OutPoint, OutPoint, 0)
				DestroyEffect(eff)
			end
		end)
	end)
end





function StartLifeStealUnitOLD(hero,e)
	local  eff=CreateEffectLighting3D(0,0,0,0,0,0,20,"Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",100)
	for i=1,#eff do
		BlzSetSpecialEffectScale(eff[i],0.1)
	end
	local maxDuration=60
	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		maxDuration=maxDuration-TIMER_PERIOD
		--print("сосем каждый тик")
		local z, x,y=GetUnitZ(hero)+100,GetUnitXY(hero)
		local ze,xe,ye=GetUnitZ(e)+50,GetUnitXY(e)
		MoveEffectLighting3D(x,y,z,xe,ye,ze,40,eff,nil,true)
		--UnitDamageTarget(hero, e, 1, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS )
		if maxDuration<=0 or not UnitAlive(e) then
			--	print("окончено")
			DestroyTimer(GetExpiredTimer())
			DestroyEffectLighting3D(eff)
		end
	end)
end


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 11.08.2020 0:58
---

do --Инициализация
	TimerStart(CreateTimer(), 0.2, false, function()
	--	ChangePointer()
	end)
end

function ChangePointer()
	local pointer=BlzFrameGetChild(BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0),13)
	--BlzFrameSetTexture(pointer, "UI\\Widgets\\tooltips\\Human\\tooltipmanaicon", 0, true)
	BlzFrameSetModel(pointer , "SystemGeneric\\selecter3.mdx", 0)
	local fakePointer=AddSpecialEffect("Attack",OutPoint,OutPoint)
	local lastX,lastY=GetPlayerMouseX[0],GetPlayerMouseY[0]
	local angleCast = AngleBetweenXY(lastX,lastY, GetPlayerMouseX[0],GetPlayerMouseY[0]) / bj_DEGTORAD
	local curAngle = angleCast
	local distance = DistanceBetweenXY(lastX,lastY, GetPlayerMouseX[0],GetPlayerMouseY[0])
	local cutDistance = distance
	local moving=0


	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		distance = DistanceBetweenXY(lastX,lastY, GetPlayerMouseX[0],GetPlayerMouseY[0])
		cutDistance = math.lerp(cutDistance, distance, TIMER_PERIOD * 16)
		angleCast = AngleBetweenXY(lastX,lastY, GetPlayerMouseX[0],GetPlayerMouseY[0]) / bj_DEGTORAD
		curAngle = lerpTheta(curAngle, angleCast, TIMER_PERIOD * 16)

		--print(cutDistance)
		--local xp, yp = GetPlayerMouseX[mainData.pid], GetPlayerMouseY[mainData.pid]
		local speed=cutDistance/5
		local x, y = MoveXY(GetPlayerMouseX[0],GetPlayerMouseY[0], speed, curAngle)
		--local distanceMove = DistanceBetweenXY(xp, yp, lastX, lastY)

		lastX, lastY = GetPlayerMouseX[0],GetPlayerMouseY[0]
		local z = GetTerrainZ(x, y)
		--BlzSetSpecialEffectPosition(mainData.effDrawing, x, y, z)
		if moving<=cutDistance then
			moving=moving+speed
			BlzSetSpecialEffectPosition(fakePointer,x,y,z)
		else
			moving=0
		--	print("перелёт")
		end

	end)



	--FrameSET
	BlzFrameSetAlpha(pointer,100)
	--print("mmm "..k)
end


function ForceMouse2Point(x,y,nx,ny)

	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		currentdistance = currentdistance + speed
		--print(currentdistance)
		local x, y = GetUnitX(hero), GetUnitY(hero)
		local newX, newY = MoveX(x, speed, angle), MoveY(y, speed, angle)

		SetUnitPositionSmooth(hero, newX, newY)

		if currentdistance >= distance then
			--or (data.OnWater and data.OnTorrent==false)
			--data.IsDisabled=false
			--data.OnWater=false
			DestroyTimer(GetExpiredTimer())
			onForces[GetHandleId(hero)]=true
			--print("stop cur="..currentdistance.." dist="..distance)
		end

	end)
end


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 29.06.2020 16:21
---
function CreateAbilityToolTip(mainData,data)
	data.ToolTip=BlzCreateFrame("DemoBoxTooltip", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), 0, 0)
	local size=mainData.CustomAbilities[data.HotKeyPos].SizeTooltip
	BlzFrameSetSize(data.ToolTip,0.29,0.012*size)
	--BlzFrameSetAbsPoint(data.ToolTip,FRAMEPOINT_CENTER,0.655,0.25)

	BlzFrameSetPoint(data.ToolTip, FRAMEPOINT_BOTTOM, BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), FRAMEPOINT_BOTTOM, 0.25, 0.16)

	local contaiter=BlzFrameGetChild(data.ToolTip,1)
	local title=BlzFrameGetChild(contaiter,0)
	local description=BlzFrameGetChild(contaiter,1)
	BlzFrameSetText(title,mainData.CustomAbilities[data.HotKeyPos].Name)
	BlzFrameSetText(description,mainData.CustomAbilities[data.HotKeyPos].Description)
	BlzFrameSetVisible(data.ToolTip,false)
	local k=0
	if mainData.CustomAbilities[data.HotKeyPos].ManaCost then
		BlzFrameSetText(title,mainData.CustomAbilities[data.HotKeyPos].Name.."\n    ".."|cffffff00"..mainData.CustomAbilities[data.HotKeyPos].ManaCost.."|r") -- |cffffff00TEXT|r
		--print("способность имеет ману")
		local res= BlzCreateFrameByType("BACKDROP", "Face",data.ToolTip, "", 0)
		BlzFrameSetTexture(res, "UI\\Widgets\\tooltips\\Human\\tooltipmanaicon", 0, true)
		BlzFrameSetSize(res, 0.01, 0.01)
		BlzFrameSetPoint(res, FRAMEPOINT_TOPLEFT, data.ToolTip, FRAMEPOINT_TOPLEFT, 0.005,-0.017)
		k=0.01
	end
	BlzFrameSetText(title,BlzFrameGetText(title).."\n ") --вставка сеператора
	local separator=BlzCreateFrameByType("BACKDROP", "Face",data.ToolTip, "", 0)
	BlzFrameSetTexture(separator, "UI\\Widgets\\tooltips\\Human\\horizontalseparator", 0, true)
	BlzFrameSetSize(separator, 0.28, 1/16*0.01)
	BlzFrameSetPoint(separator, FRAMEPOINT_TOPLEFT, data.ToolTip, FRAMEPOINT_TOPLEFT, 0.005,-0.02-k)
	--print(mainData.CustomAbilities[data.HotKeyPos].Name)
	--Динамическо обновление
	if mainData.CustomAbilities[data.HotKeyPos].Updatable then --Обновление текста в тултипах
		TimerStart(CreateTimer(), TIMER_PERIOD, true, function() --TODO сделать всё на 1 таймере, а не это вот всё
			local NativeString=mainData.CustomAbilities[data.HotKeyPos].Description
			NativeString =string.gsub(NativeString,'ms',math.floor(GetUnitMoveSpeed(mainData.UnitHero)))
			NativeString =string.gsub(NativeString,'ar',math.floor(BlzGetUnitWeaponRealField(mainData.UnitHero,UNIT_WEAPON_RF_ATTACK_RANGE,0)))
			NativeString =string.gsub(NativeString,'ap',math.floor(BlzGetUnitBaseDamage(mainData.UnitHero,0)))
			NativeString =string.gsub(NativeString,'as',BlzGetUnitAttackCooldown(mainData.UnitHero,0))
			BlzFrameSetText(description,NativeString)
		end)
	end

end
function ShowAbilityTooltip (mainData,data,isShow)
	if isShow then
		if GetLocalPlayer()==Player(mainData.pid) then
			--print(mainData.CustomAbilities[data.HotKeyPos].Name.." Шоу тултип вызван")
			BlzFrameSetVisible(data.ToolTip,true)
		end
	end
	return isShow
end

function HideAllToolTips(mainData)
	--print("способности скрыты")
	for i=1,12 do
		local data=mainData.FrameTable[i]
	BlzFrameSetVisible(data.ToolTip,false)
	end
end


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 23.06.2020 13:25
---
do
	--by Tasyen
	-- returns the local current main selected unit, using it in a sync gamestate relevant manner breaks the game.
	function GetMainSelectedUnitEx()
		return GetMainSelectedUnit(GetSelectedUnitIndex())
	end


	local containerFrame
	local frames = {}
	local group
	local units = {}
	local filter = Filter(function()
		local unit = GetFilterUnit()
		local prio = BlzGetUnitRealField(unit, UNIT_RF_PRIORITY)
		local found = false
		-- compare the current unit with allready found, to place it in the right slot
		for index, value in ipairs(units) do
			-- higher prio than this take it's slot
			if BlzGetUnitRealField(value, UNIT_RF_PRIORITY) < prio then
				table.insert(units, index, unit)
				found = true
				break
				-- equal prio and better colisions Value
			elseif BlzGetUnitRealField(value, UNIT_RF_PRIORITY) == prio and GetUnitOrderValue(value) > GetUnitOrderValue(unit) then
				table.insert( units, index, unit)
				found = true
				break
			end
		end
		-- not found add it at the end
		if not found then
			table.insert(units, unit)
		end

		unit = nil
		return false
	end)


	function GetSelectedUnitIndex()
		-- local player is in group selection?
		if BlzFrameIsVisible(containerFrame) then
			-- find the first visible yellow Background Frame
			for int = 0, #frames do
				if BlzFrameIsVisible(frames[int]) then
					return int
				end
			end
		end

		return nil
	end

	function GetUnitOrderValue(unit)
		--heroes use the handleId
		if IsUnitType(unit, UNIT_TYPE_HERO) then
			return GetHandleId(unit)
		else
			--units use unitCode
			return GetUnitTypeId(unit)
		end
	end


	function GetMainSelectedUnit(index)
		if index then
			GroupEnumUnitsSelected(group, GetLocalPlayer(), filter)
			local unit = units[index + 1]
			--clear table
			repeat until not table.remove(units)
			return unit
		else
			GroupEnumUnitsSelected(group, GetLocalPlayer(), nil)
			return FirstOfGroup(group)
		end
	end

	--init
	TimerStart(CreateTimer(), 0, false, function()
		local console = BlzGetFrameByName("ConsoleUI", 0)
		local bottomUI = BlzFrameGetChild(console, 1)
		local groupframe = BlzFrameGetChild(bottomUI, 5)
		--globals
		containerFrame = BlzFrameGetChild(groupframe, 0)
		group = CreateGroup()
		-- give this frames a handleId
		for int = 0, BlzFrameGetChildrenCount(containerFrame) - 1 do
			local buttonContainer = BlzFrameGetChild(containerFrame, int)
			frames[int] = BlzFrameGetChild(buttonContainer, 0)
		end
		DestroyTimer(GetExpiredTimer())
	end)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 06.06.2020 0:43
---
function ChangeInterfaceToQuin(data)
	Hide10Buttons()
	--print(1111)
	HideAllCustomAbility(data,false)
	BlzFrameSetScale(BlzFrameGetChild(BlzGetFrameByName("ConsoleUI",0),5), 0.001)
	--print("кнопки скрыты")
	--BlzFrameSetVisible(BlzGetFrameByName("ConsoleUIBackdrop", 0), false)-- черная рамка, нажл пробовать с ней
end

function Hide10Buttons(data)

	for i =0,11 do
		BlzFrameSetSize(BlzGetFrameByName("CommandButton_"..i, 0),0.0001,0.0001) --убирает всё
		if i~=1 then
			if i~=2 then
				--BlzFrameSetSize(BlzGetFrameByName("CommandButton_"..i, 0),0.0001,0.0001) -- оставляет холд и стоп
			end
		end

	end
end


function ResetInterfaceToDefault(data)
	--print("кнопки отображены")
	HideAllCustomAbility(data,true)
	for i =0,11 do
		BlzFrameSetSize(BlzGetFrameByName("CommandButton_"..i, 0),NextPoint,NextPoint)
		--BlzFrameSetVisible(BlzGetFrameByName("CommandButton_"..i, 0), true)
	end
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 24.06.2020 13:08
---
function CreateCooldownIndicator(data)
	local cd= BlzCreateFrameByType("BACKDROP", "Face", data.SelfFrame, "", 0)
	BlzFrameSetTexture(cd, "DDS512".."\\0000000", 0, true)
	BlzFrameSetAlpha(cd,128)
	BlzFrameSetSize(cd, NextPoint, NextPoint)
	BlzFrameSetAbsPoint(cd, FRAMEPOINT_CENTER,data.PosX,data.PosY)
	return cd
end

function StarFrameCooldown(data,cd)
	if data.Timer then
		EndFrameCD(data)
	end
	local frameCount=1024
	data.PercentAmount=(0.05*frameCount)/cd
	data.Full=0
	data.CdIndicatorFrame=CreateCooldownIndicator(data)
	data.OnCD=true
	data.CurrentCDTime=cd
	data.CurrentCD=cd
	data.Timer=CreateTimer()
	TimerStart(data.Timer, 0.05, true, function()
		if not data.OnPaused then
			data.Full=data.Full+data.PercentAmount
			data.CurrentCDTime=data.CurrentCDTime-0.05
		end
		local textShowed=string.format("%02.1f",data.CurrentCDTime)
		if data.CurrentCDTime>=10 then
			textShowed=R2I(data.CurrentCDTime)
		end
		BlzFrameSetText(data.SelfFrame,textShowed)
		BlzFrameSetTexture(data.CdIndicatorFrame, "DDS512".."\\000"..Zero4(R2I(data.Full+data.PercentAmount)), 0, true)
		if data.Full>frameCount-1 then
			EndFrameCD(data)
		end
	end)
end

function Zero4(s)
	local ns=""
	if string.len(s)==1 then
		ns="000"..s
	elseif string.len(s)==2 then
		ns="00"..s
	elseif string.len(s)==3 then
		ns="0"..s
	else
		ns=s
	end
	return ns
end

function PauseFrameCD(data,isPaused)  --true - пауза, false - продолжить
	if isPaused then
		data.OnPaused=true
	else
		data.OnPaused=false
	end
end

function EndFrameCD(data)
	DestroyTimer(data.Timer)
	BlzFrameSetText(data.SelfFrame, "")
	data.Timer=nil
	BlzDestroyFrame(data.CdIndicatorFrame)
	data.Full=0
	data.OnCD=false
	if data.Number==6 then
		BlzFrameSetVisible(data.ReadyIndicator,true)
	end
end

function AddSpeedToFrameCD(data,sec)
	data.CurrentCDTime=data.CurrentCDTime-sec
	--10=2
	--20=1
	local k=1
	if data.CurrentCD==20 then
		k=1
	end
	if data.CurrentCD==10 then
		k=2
	end
	data.Full=data.Full+(k*sec*data.CurrentCD*data.PercentAmount)
	--print(data.Full)
end



function CreateAbilityFrame(mainData,pos,texture,type,HotKeyPos) -- позиция 1 - 12
	local data=mainData.FrameTable[pos]
	data.HotKeyPos=HotKeyPos -- выставление индекса
	CreateAbilityToolTip(mainData,data)-- создание тултипа
	if not texture then
		texture="ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn"
	end

	data.SelfFrame = BlzCreateFrame("GlueWText", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), 0, 0)
	data.IconFrame = BlzFrameGetChild(data.SelfFrame, 0)
	BlzFrameSetTexture(data.IconFrame, texture, 0, true)
	BlzFrameSetText(BlzFrameGetChild(data.SelfFrame, 2), "xgm")
	BlzFrameSetAllPoints(data.IconFrame, data.SelfFrame)
	BlzFrameSetSize(data.SelfFrame,NextPoint,NextPoint)
	BlzFrameSetAbsPoint(data.SelfFrame,FRAMEPOINT_CENTER,data.PosX,data.PosY)

	--Индикатор готовности
	if data.Number==6 then
		data.ReadyIndicator = BlzCreateFrameByType("SPRITE", "justAName", data.SelfFrame, "WarCraftIIILogo", 0)
		BlzFrameSetPoint(data.ReadyIndicator , FRAMEPOINT_BOTTOMLEFT, data.SelfFrame, FRAMEPOINT_BOTTOMLEFT, 0.02, 0.02)
		BlzFrameSetSize(data.ReadyIndicator , 1., 1.)
		BlzFrameSetScale(data.ReadyIndicator , 1.)
		BlzFrameSetModel(data.ReadyIndicator , "SystemGeneric\\selecter3.mdx", 0)
		BlzFrameSetVisible(data.ReadyIndicator,true) -- TODO добавить локального игрока и где то есть ещё второе место такое же
	end

	--print(type)
	if type=="active" then -- События кликов по кнопке
		--print("создана ативная кнопка")
		local  ClickTrig = CreateTrigger()
		BlzFrameSetEnable(BlzGetTriggerFrame(), false)
		BlzFrameSetEnable(BlzGetTriggerFrame(), true)
		BlzTriggerRegisterFrameEvent(ClickTrig, data.SelfFrame, FRAMEEVENT_CONTROL_CLICK)
		TriggerAddAction(ClickTrig, function ()
			--print("Нажата кнопка "..pos)
			BlzFrameSetEnable(BlzGetTriggerFrame(), false)
			BlzFrameSetEnable(BlzGetTriggerFrame(), true)
			if not data.OnCD then
				if pos==10 then --перезарядка огнемёта
					StarFrameCooldown(data,10)
					mainData.FirePillarState=true
					StartFirePillar(mainData)
				end
				if pos==11 then -- старт кактусов
					if CustomAbilityIsReady(mainData,data) and not mainData.StartDrawing then
						EatingCactus(mainData)
						mainData.StartDrawing=true
						mainData.DestroyDrawing=false
					end
				end
				if pos==12 then -- старт отсоса
					--StarFrameCooldown(data,12)
					--print("запускаем функция отсасывания")
					--StartLifeStealArea(mainData,data,500)
					UnitUsedLifeStealAbility(mainData,data)
				end --
				local p=GetOwningPlayer(mainData.UnitHero)
				if pos==1 then
					--print("Клик по move")
					IssueImmediateOrderById(mainData.UnitHero,851976)
					ForceUIKeyBJ(p,"Esc")
					ForceUIKeyBJ(p,"M")
				elseif pos==2 then
					--print("Клик по stop")
					IssueImmediateOrder(mainData.UnitHero,"stop")
				elseif pos==3 then
					--print("Клик по hold")
					IssueImmediateOrder(mainData.UnitHero,"holdposition")
				elseif pos==4 then
					--print("Клик по attack")
					IssueImmediateOrderById(mainData.UnitHero,851976)
					ForceUIKeyBJ(p,"Esc")
					ForceUIKeyBJ(p,"A")
				end
			end
		end)
	end


	if mainData.CustomAbilities[HotKeyPos].MaxCharges then
		data.Charges=R2I(mainData.CustomAbilities[HotKeyPos].MaxCharges/2)
		--print(data.Charges)
		data.ChargesFrame= BlzCreateFrameByType("BACKDROP", "Face",data.SelfFrame, "", 0)
		data.ChargesFrameText = BlzCreateFrameByType("TEXT", "ButtonChargesText", data.ChargesFrame, "", 0)
		BlzFrameSetTexture(data.ChargesFrame, "UI\\Widgets\\Console\\Human\\CommandButton\\human-button-lvls-overlay", 0, true)
		BlzFrameSetSize(data.ChargesFrame, 0.02, 0.015)
		--BlzFrameSetAbsPoint(data.ChargesFrame, FRAMEPOINT_CENTER,0.4+0.02 , 0.6-0.02)
		BlzFrameSetPoint(data.ChargesFrame, FRAMEPOINT_BOTTOMRIGHT, data.SelfFrame, FRAMEPOINT_BOTTOMRIGHT, 0,0)
		BlzFrameSetText(data.ChargesFrameText, data.Charges)
		BlzFrameSetPoint(data.ChargesFrameText, FRAMEPOINT_CENTER, data.ChargesFrame, FRAMEPOINT_CENTER, 0.,0.)
		if HotKeyPos==3 then
			TimerStart(CreateTimer(), 1, true, function()
				if data.Charges<mainData.CustomAbilities[HotKeyPos].MaxCharges then
					data.Charges=data.Charges+1
				end
			end)
			TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
				BlzFrameSetText(data.ChargesFrameText, data.Charges)
				--print(GetHandleId(data.ChargesFrameText))
			end)

		end
	end

	local  TrigMOUSE_ENTER = CreateTrigger()
	BlzTriggerRegisterFrameEvent( TrigMOUSE_ENTER, data.SelfFrame, FRAMEEVENT_MOUSE_ENTER)
	TriggerAddAction( TrigMOUSE_ENTER, function ()
		--print("показать подсказку")
		ShowAbilityTooltip(mainData,data,true)
		data.MouseOnFrame=true
		local pid=GetPlayerId(GetTriggerPlayer())
		--print(GetUnitName())
		if data.Number==9 then--радиус для уворота
			CreateVisualMarkerRadius(data,250,HERO[pid].UnitHero)
		end
		if data.Number==10 then--радиус огнемёта
			CreateVisualMarkerRadius(data,800,HERO[pid].UnitHero,nil,nil,data.Number)
		end
		if data.Number==11 then--радиус сажания кустов
			CreateVisualMarkerRadius(data,2000,HERO[pid].UnitHero,nil,nil,data.Number)
		end
		if data.Number==12 then--радиус отсоса
			CreateVisualMarkerRadius(data,1000,HERO[pid].UnitHero,nil,nil,data.Number)
		end
	end)
	local  TrigMOUSE_LEAVE = CreateTrigger()
	BlzTriggerRegisterFrameEvent( TrigMOUSE_LEAVE, data.SelfFrame, FRAMEEVENT_MOUSE_LEAVE)
	TriggerAddAction( TrigMOUSE_LEAVE, function ()
		data.MouseOnFrame=false
		HideAllToolTips(mainData)
		--print("убрать подсказку")
	end)

end

function HideAllCustomAbility(data,isHide)
	--print("первый вызов")
	if isHide then
		for i=1,12 do
			BlzFrameSetVisible(data.FrameTable[i].SelfFrame,false)
		end
	else
		for i=1,12 do
			if GetLocalPlayer()==Player(data.pid) then
				BlzFrameSetVisible(data.FrameTable[i].SelfFrame,true)
			end
		end
	end
end

function CreateVisualMarkerRadius (data,radius,hero,x,y,number,timed)
	if hero then
		--print(GetUnitName(hero))
		--x,y=GetUnitXY(hero)
	end
	-- circle_fill
	local path="circ"
	path="replaceabletextures\\selection\\rangeindicator"
	if number==10 then
	--	path="circle_fill"
	end


	local CircleImage=CreateImage(path,radius,radius,radius,OutPoint,OutPoint,0,0,0,0,4)
	if timed then
		SetImageColor(CircleImage,255,0,0,255)
	end
	SetImageRenderAlways(CircleImage, true)
	ShowImage(CircleImage,false)

	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		local xs,ys=GetUnitX(hero)-radius/2-16,GetUnitY(hero)-radius/2-16
		if not data then
			SetImagePosition(CircleImage,xs,ys,0)
		end
		if GetLocalPlayer()==GetOwningPlayer(hero) then
			ShowImage(CircleImage,true)
		end

		if timed then
			timed=timed-TIMER_PERIOD
			if timed <=1 then
				SetImageColor(CircleImage,255,0,0,math.floor(255*timed))
			end
		end
		if data then
			if (not data.MouseOnFrame and not timed) or (timed and timed<=0) then
				SetImagePosition(CircleImage,OutPoint,OutPoint,0)
				DestroyImage(CircleImage)
				DestroyTimer(GetExpiredTimer())
			end
		else
			if timed <=0 then
				SetImagePosition(CircleImage,OutPoint,OutPoint,0)
				DestroyImage(CircleImage)
				DestroyTimer(GetExpiredTimer())
			end
		end
	end)
	return CircleImage
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 09.09.2020 23:07
---
OutPoint=6000
TIMER_PERIOD = 0.03125
do --Инициализация
	TimerStart(CreateTimer(), 1, false, function()
		--создаёт триггер отлова клавишь
		AltIsPressed()
		AddSquareArea(-845,-1080,400)
		AddSquareArea(567,-1020,800)
	end)
end

AltPlayers={}
function AltIsPressed()
	-----------------------------------------------------------------OSKEY_ALT
	local gg_trg_EventUpALT = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpALT, Player(i), OSKEY_LALT, 4, true) -- отлов нажатия альт, работает только при метакей 4
	end
	TriggerAddAction(gg_trg_EventUpALT, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		AltPlayers[pid]=true
		--print("Аль нажат")
	end)
	local TrigDepressALT = CreateTrigger()
	for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
		BlzTriggerRegisterPlayerKeyEvent(TrigDepressALT, Player(i), OSKEY_LALT, 0, false)
	end
	TriggerAddAction(TrigDepressALT, function()
		local pid = GetPlayerId(GetTriggerPlayer())
		AltPlayers[pid]=false
		--print("Аль отпущен")
	end)
end

function AddCircleAreaForUnit(unit,radius)
	local path="circ" -- для нестандартных кругов
	path="replaceabletextures\\selection\\rangeindicator" -- путь до дефолтной иконки
	if not radius then
		radius=BlzGetUnitWeaponRealField(unit,UNIT_WEAPON_RF_ATTACK_RANGE,0)*2.3 -- коэффициент 2,3 подобран методом тыка и исходит из размеров текстуры
		--print(radius)
	end
	local CircleImage=CreateImage(path,radius,radius,radius,OutPoint,OutPoint,0,0,0,0,4)
	SetImageRenderAlways(CircleImage, true)
	ShowImage(CircleImage,false)
	SetImagePosition(CircleImage,GetUnitX(unit),GetUnitY(unit),0)

	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
			if AltPlayers[i]==true  then
				if GetLocalPlayer()==Player(i) then
					ShowImage(CircleImage,true)
					local xs,ys=GetUnitX(unit)-radius/2-16,GetUnitY(unit)-radius/2-16
					SetImagePosition(CircleImage,xs,ys,0)
					--print("Показываем круги")
				end
			else
				if GetLocalPlayer()==Player(i) then
					ShowImage(CircleImage,false)
				end
			end
		end
		if not UnitAlive(unit) then
			DestroyTimer(GetExpiredTimer())
			DestroyImage(CircleImage)
			ShowImage(CircleImage,false)
		end
	end)
end

function AddSquareArea(xCenter,yCenter,range)
	local image=CreateImage("Square256",range,range,range,OutPoint,OutPoint,0,0,0,0,4)
	--print("создан новый маркер")
	SetImageRenderAlways(image, true)
	ShowImage(image,false)
	local x,y=xCenter,yCenter
	x,y=x-range/2,y-range/2
	SetImagePosition(image,x,y,0)


	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
			if AltPlayers[i]==true  then
				if GetLocalPlayer()==Player(i) then
					ShowImage(image,true)
					--SetImagePosition(image,x,y,0)
					--print("Показываем круги")
				end
			else
				if GetLocalPlayer()==Player(i) then
					ShowImage(image,false)
				end
			end
		end
	end)
end


---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 03.06.2020 17:02
---

do --Инициализация
	TimerStart(CreateTimer(), 0.1, false, function()
		--if BlzLoadTOCFile("SystemGeneric\\Main.toc") then
		--print("успех")
		--else
			--print("провал загрузки ток кастом бара")
		--end
	end)
end


function CallingBarCreate(u,cd,text,support)
	if not text then text="Подготовка" end
	local amount=5/cd
	local full=0
	local bar = BlzCreateSimpleFrame("MyFakeBar", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), 0)
	BlzFrameSetAbsPoint(bar, FRAMEPOINT_CENTER, 0.4, 0.15)
	BlzFrameSetValue(bar, 0)
	BlzFrameSetTextSizeLimit(bar,1)
	if support then
		CallingBarCancelCond(u,bar)
	end

	if GetLocalPlayer()==GetOwningPlayer(u)  then -- хп бары, они точно в норме
		BlzFrameSetVisible(bar,true)
	end
	BlzFrameSetTexture(bar, "Replaceabletextures\\Teamcolor\\Teamcolor0"..(GetConvertedPlayerId(GetOwningPlayer(u))-1)..".blp", 0, true)
	BlzFrameSetTexture(BlzGetFrameByName("MyFakeBarBorder",0),"SystemGeneric\\MyBarBorder.blp", 0, true)
	BlzFrameSetText(BlzGetFrameByName("MyFakeBarTitle",0), text)--‡ Сердце ™ щит

	local lefttext = BlzGetFrameByName("MyFakeBarLeftText",0)
	local righttext = BlzGetFrameByName("MyFakeBarRightText",0)
	BlzFrameSetText(lefttext, "")
	BlzFrameSetText(righttext, "")

	TimerStart(CreateTimer(), 0.05, true, function()
		full=full+amount
		BlzFrameSetValue(bar, full)
		--print(full)
		if full>=100 then
			--print("destroy")
			CallingBarDestroy(u,bar)
		end
	end)
	return bar
end

function CallingBarDestroy(hero,bar)
	if UnitRemoveAbility(hero,FourCC('Abun')) then
	--	print("атака возвращена")
	end
	DestroyTimer(GetExpiredTimer())
	BlzDestroyFrame(bar)
end

function CallingBarCancelCond(hero,bar) --
	UnitAddAbility(hero,FourCC('Abun'))
	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		CallingBarIsStatus(hero,bar)
	end)
end

function CallingBarIsStatus(hero,bar)
	local status=true
	if IsUnitPaused(hero) or GetUnitCurrentOrder(hero)~=String2OrderIdBJ("")	then -- указываем списо условий который могус сбить каст
		if GetUnitCurrentOrder(hero)~=String2OrderIdBJ("doom") then
			--print(OrderId2String(GetUnitCurrentOrder(hero)))
			--print("Каст сбит")
			UnitRemoveAbility(hero,FourCC('Abun'))
			CallingBarDestroy(hero,bar)
			status=false
		end
	end
	return status
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 12.02.2021 15:24
---
do
    TimerStart(CreateTimer(), .1, false, function()
        HideEverything()
        IsSystemON=true
        InitCamControl()
        InitMouseMoveTrigger()
        --MouseHider(3, 0) -- 0 для красного игрока
        CreateUI()
        RestoreMiniPap()
    end)
end
function HideEverything()
    BlzFrameSetVisible(BlzGetFrameByName("ConsoleUIBackdrop", 0), false)
    for i = 0, 11 do
        --BlzFrameSetVisible(BlzGetFrameByName("CommandButton_"..i, 0), false) --отключить
        BlzFrameSetSize(BlzGetFrameByName("CommandButton_" .. i, 0), 0, 0)--скрыть, но работать будут по хоткеям
    end
    BlzHideOriginFrames(true)--скрыть всё
end

function ShowEverything()
    BlzFrameSetVisible(BlzGetFrameByName("ConsoleUIBackdrop", 0), true)
    for i = 0, 11 do
        --BlzFrameSetVisible(BlzGetFrameByName("CommandButton_"..i, 0), false)
        BlzFrameSetSize(BlzGetFrameByName("CommandButton_" .. i, 0), 0.039, 0.039)
    end
    BlzHideOriginFrames(false)--скрыть всё
end


CamZ = {}
Step = 100 -- шаг подъёма камеры
function InitCamControl()
    local EventUp = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        CreateFogModifierRectBJ(true, Player(i), FOG_OF_WAR_VISIBLE, GetEntireMapRect())

        BlzTriggerRegisterPlayerKeyEvent(EventUp, Player(i), OSKEY_HOME, 0, true)
        CamZ[i] = GetCameraField(CAMERA_FIELD_ZOFFSET)
    end
    local EventDown = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(EventDown, Player(i), OSKEY_END, 0, true)
    end
    TriggerAddAction(EventUp, function()
        CamZ[GetPlayerId(GetTriggerPlayer())] = GetCameraField(CAMERA_FIELD_ZOFFSET) + Step
    end)
    TriggerAddAction(EventDown, function()
        CamZ[GetPlayerId(GetTriggerPlayer())] = GetCameraField(CAMERA_FIELD_ZOFFSET) - Step
    end)

    TimerStart(CreateTimer(), 0.02, true, function()
        for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
            if GetLocalPlayer() == Player(i) then
                SetCameraField(CAMERA_FIELD_ZOFFSET, CamZ[i], 0.1)
            end
        end
    end)
end

GetPlayerMouseX = {}
GetPlayerMouseY = {}
function InitMouseMoveTrigger()
    local MouseMoveTrigger = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        local player = Player(i)
        TriggerRegisterPlayerEvent(MouseMoveTrigger, player, EVENT_PLAYER_MOUSE_MOVE)
        GetPlayerMouseX[i] = 0
        GetPlayerMouseY[i] = 0
    end
    TriggerAddAction(MouseMoveTrigger, function()
        local id = GetPlayerId(GetTriggerPlayer())
        if BlzGetTriggerPlayerMouseX() ~= 0 then
            GetPlayerMouseX[id] = BlzGetTriggerPlayerMouseX()
            GetPlayerMouseY[id] = BlzGetTriggerPlayerMouseY()
        end
    end)
end

function MouseHider(delay, pid)
    local pointer = BlzFrameGetChild(BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), 13)
    local period = 0.02
    local sec = 0
    local showPointer = true
    local preX = GetPlayerMouseX[pid]
    TimerStart(CreateTimer(), period, true, function()
        sec = sec + period
        if preX ~= GetPlayerMouseX[pid] then
            showPointer = true
            sec = 0
            CustomUIShow(showPointer)
            --print("показываем курсор")
            BlzFrameSetAlpha(pointer, 255)
        end
        if sec >= delay and showPointer and not mouseOnFrame then
            showPointer = false
            CustomUIShow(showPointer)
            BlzFrameSetAlpha(pointer, 0)
            ClearTextMessages()
            --print("Скрываем курсор")
        end
        preX = GetPlayerMouseX[pid]
    end)
end

function CreateUI()
    ui={}
    tt={}
    ui[1]=CreateSimpleFrameGlue(0.02, 0.56,"ReplaceableTextures\\CommandButtons\\BTNPurge",1)
    ui[2]=CreateSimpleFrameGlue(0.02+0.039, 0.56,"ReplaceableTextures\\CommandButtons\\BTNSpy",2)
    ui[3]=CreateSimpleFrameGlue(0.02+0.039*2, 0.56,"ReplaceableTextures\\CommandButtons\\BTNCryptFiendUnBurrow",3)
    tt[1],tt[2],tt[3]=CreateToolTipBox()

end

function CreateSimpleFrameGlue(posX, PosY, texture, flag)
    local NextPoint = 0.039
    if not texture then
        texture = "ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn"
    end
    local SelfFrame = BlzCreateFrameByType('GLUEBUTTON', 'FaceButton', BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), 'ScoreScreenTabButtonTemplate', 0)
    local buttonIconFrame = BlzCreateFrameByType('BACKDROP', 'FaceButtonIcon', SelfFrame, '', 0)
    --BlzFrameSetVisible(SelfFrame, false)
    -- BlzFrameSetVisible(SelfFrame, GetLocalPlayer() == player)
    BlzFrameSetAllPoints(buttonIconFrame, SelfFrame)
    BlzFrameSetTexture(buttonIconFrame, texture, 0, true)
    BlzFrameSetSize(SelfFrame, NextPoint, NextPoint)
    BlzFrameSetAbsPoint(SelfFrame, FRAMEPOINT_CENTER, posX, PosY)

    local ClickTrig = CreateTrigger()
    BlzTriggerRegisterFrameEvent(ClickTrig, SelfFrame, FRAMEEVENT_CONTROL_CLICK)
    TriggerAddAction(ClickTrig, function()
        -- print("Нажата кнопка ")
        BlzFrameSetEnable(BlzGetTriggerFrame(), false)
        BlzFrameSetEnable(BlzGetTriggerFrame(), true)
        if flag==1 then
            ClearTextMessages()
        end
        if flag==2 then
            if mapIsVisible then
                mapIsVisible=false
            else
                mapIsVisible=true
            end
            BlzFrameSetVisible(map, mapIsVisible)
        end
        if flag==3 then
            if IsSystemON then
                IsSystemON=false
                mapIsVisible=true
                ShowEverything()
                BlzFrameSetTexture(buttonIconFrame, "ReplaceableTextures\\CommandButtons\\BTNCryptFiendBurrow", 0, true)
            else
                IsSystemON=true
                mapIsVisible=false
                HideEverything()
                BlzFrameSetTexture(buttonIconFrame, texture, 0, true)
            end
        end
    end)

    local TrigMOUSE_ENTER = CreateTrigger()
    BlzTriggerRegisterFrameEvent(TrigMOUSE_ENTER, SelfFrame, FRAMEEVENT_MOUSE_ENTER)

    TriggerAddAction(TrigMOUSE_ENTER, function()
        --print("показать подсказку "..flag)
        mouseOnFrame=true
        BlzFrameSetVisible(tt[1],true)
        if flag==1 then
            SetTooltipText(tt[3],"Очистить экран от сообщений")
        elseif flag==2 then
            SetTooltipText(tt[3],"Включить/выключить миникарту")
        elseif flag==3 then
            SetTooltipText(tt[3],"Включить/выключить интерфейс")
        end

    end)
    local TrigMOUSE_LEAVE = CreateTrigger()
    BlzTriggerRegisterFrameEvent(TrigMOUSE_LEAVE, SelfFrame, FRAMEEVENT_MOUSE_LEAVE)
    TriggerAddAction(TrigMOUSE_LEAVE, function()
        mouseOnFrame=false
        BlzFrameSetVisible(tt[1],false)
    end)
    return SelfFrame
end


function RestoreMiniPap()
    map=BlzGetOriginFrame(ORIGIN_FRAME_MINIMAP, 0)
    mapIsVisible=false
    BlzFrameSetVisible(map, false)
end

function CustomUIShow(show)
    for i=1,#ui do
        BlzFrameSetVisible(ui[i],show)
    end
end

mouseOnFrame=false
--mainTooltip=nil
function CreateToolTipBox()
    local tooltip = BlzCreateFrameByType("FRAME", "TestDialog", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), "StandardFrameTemplate", 0)
    local text = BlzCreateFrameByType("TEXT", "ButtonChargesText", tooltip, "", 0)
    local backdrop = BlzCreateFrame("QuestButtonDisabledBackdropTemplate", tooltip, 0, 0)
    BlzFrameSetAbsPoint(tooltip, FRAMEPOINT_CENTER, 0.04+0.04, 0.6-0.04-0.04)
    BlzFrameSetSize(tooltip, 0.2, 0.04)
    BlzFrameSetSize(backdrop, 0.2, 0.04)
    BlzFrameSetPoint(backdrop, FRAMEPOINT_CENTER, tooltip, FRAMEPOINT_CENTER, 0.0, 0.0)
    BlzFrameSetAlpha(backdrop,100)
    BlzFrameSetText(text,"Первичный текст")
    BlzFrameSetPoint(text, FRAMEPOINT_CENTER, tooltip, FRAMEPOINT_CENTER, 0.0, 0.0)
    BlzFrameSetVisible(tooltip,false)
    return tooltip,backdrop,text
end

function SetTooltipText(text,tips)
    BlzFrameSetText(text,tips)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 26.07.2020 11:40
---
do
	--Инициализация
	TimerStart(CreateTimer(), 0.1, false, function()
		--perebor = CreateGroup() --глобальная группа для перебора всех юнитов 1 единственная на всю игру, больше групп не надо
		--InitManaLoosing()-- чтобы не подгрёб сбощик мусора и + у меня дебаггер прикручен к таймерам и + можно делать отложенный старт системы
	end)
end

ManaLoosingTable = {} --глобальная таблица, аналог хеша, сделана отдельной для изолированности наработки
DeBuffID = FourCC("A000") -- можно сделать на основе ауры замедления торнадо
DeBuffID2 = FourCC("B000") -- бафф иконки ауры торнадо
ImmuneID = FourCC("A001") -- Бафф иммунитет
Porog=0.2 -- пороговое значение для срабатывания дебафа - 20%


function InitManaLoosing()
	-- Для юнитов изначально стоящих на карте
	TrigLESSEQUAL = CreateTrigger() -- триггер для потери маны меньше 20%
	TrigGREATERTHAN = CreateTrigger() -- возврата маны

	local NewEntireOnMap = CreateTrigger() -- триггер проверки новых юнитов, созданных триггерно или суммом, ну или просто любых, которых не захватила инициализация карты
	TriggerRegisterEnterRectSimple(NewEntireOnMap, bj_mapInitialPlayableArea)
	TriggerAddAction(NewEntireOnMap, function()
		local EntireUnit = GetTriggerUnit()
		ChkUnitForManaDeBuffSystem(EntireUnit) -- ChkUnitForManaDeBuffSystem проверка и добавление юнита
	end)

	local e = nil
	GroupEnumUnitsInRect(perebor, bj_mapInitialPlayableArea, nil) -- перебор всех юнитов стоящих на карте заранее
	while true do
		e = FirstOfGroup(perebor)
		if e == nil then
			break
		end
		ChkUnitForManaDeBuffSystem(e) -- и добавление им события для проверки маны
		GroupRemoveUnit(perebor, e)
	end
	-- Триггеры проверки маны
	TriggerAddAction(TrigLESSEQUAL, function()
		local hero = GetTriggerUnit()
		UnitAddAbility(hero, DeBuffID)
		print(GetUnitName(hero) .. " значение маны упало ниже 20%, добавляем наш дебафф")
	end)

	TriggerAddAction(TrigGREATERTHAN, function()
		local hero = GetTriggerUnit()
		if GetUnitAbilityLevel(hero, DeBuffID) > 0 then
			print(GetUnitName(hero) .. " значение маны восстановилось, удаляем дебафы")
			UnitRemoveAbility(hero, DeBuffID)
			UnitRemoveAbility(hero, DeBuffID2)
		else
			print(" Система дебафа еще не настроена, но событие удаления дебафа отработало корректно")
		end
	end)
end

function ChkUnitForManaDeBuffSystem(e) -- а вот и событие наше
	if UnitAlive(e) and not IsUnitType(e, UNIT_TYPE_STRUCTURE) and BlzGetUnitMaxMana(e) > 1 and GetUnitAbilityLevel(e, ImmuneID) == 0 then
		-- условия кому давать или не давать дебафф
		local percent = BlzGetUnitMaxMana(e) * Porog
		print("добавление событий для отлова падения или восстановления маны юнита " .. GetUnitName(e) .. " пороговое значение " .. percent)
		TriggerRegisterUnitManaEvent(TrigLESSEQUAL, e, LESS_THAN_OR_EQUAL, percent)
		TriggerRegisterUnitManaEvent(TrigGREATERTHAN, e, GREATER_THAN_OR_EQUAL, percent) --лучше написать просто  GREATER_THAN, надо проверять
	end
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 10.01.2020 23:44
---
---@param x real
---@param y real
---@return boolean
function InMapXY(x, y)
	return x > GetRectMinX(bj_mapInitialPlayableArea) and x < GetRectMaxX(bj_mapInitialPlayableArea) and y > GetRectMinY(bj_mapInitialPlayableArea) and y < GetRectMaxY(bj_mapInitialPlayableArea)
end

---@param x real
---@param distance real
---@param angle real radian
---@return real
function GetPolarOffsetX(x, distance, angle)
	return x + distance * math.cos(angle)
end

---@param y real
---@param distance real
---@param angle real radian
---@return real
function GetPolarOffsetY(y, distance, angle)
	return y + distance * math.sin(angle)
end

---@param x real
---@param distance real
---@param angle real degrees
---@return real
function MoveX(x, distance, angle)
	return x + distance * math.cos(angle * bj_DEGTORAD)
end

---@param y real
---@param distance real
---@param angle real degrees
---@return real
function MoveY(y, distance, angle)
	return y + distance * math.sin(angle * bj_DEGTORAD)
end


local GetTerrainZ_location = Location(0, 0)
---@param x real
---@param y real
---@return real
function GetTerrainZ(x, y)
	MoveLocation(GetTerrainZ_location, x, y)
	return GetLocationZ(GetTerrainZ_location)
end

---@param target unit
---@return real
function GetUnitZ(target)
	MoveLocation(GetTerrainZ_location, GetUnitX(target), GetUnitY(target))
	return GetLocationZ(GetTerrainZ_location) + GetUnitFlyHeight(target)
end

---@param target unit
---@param z real
function SetUnitZ(target, z)
	UnitAddAbility(target, FourCC('Aave'))
	UnitRemoveAbility(target, FourCC('Aave'))
	MoveLocation(GetTerrainZ_location, GetUnitX(target), GetUnitY(target))
	SetUnitFlyHeight(target, z - GetLocationZ(GetTerrainZ_location), 0)
end

---@param h real максимальная высота в прыжке на середине расстояния (x = d / 2)
---@param d real общее расстояние до цели
---@param x real расстояние от исходной цели до точки, где следует взять высоту по параболе
---@return real
function ParabolaZ (h, d, x)
	return (4 * h / d) * (d - x) * (x / d)
end

---@param zs real начальная высота высота одного края дуги
---@param ze real конечная высота высота другого края дуги
---@param h real максимальная высота на середине расстояния (x = d / 2)
---@param d real общее расстояние до цели
---@param x real расстояние от исходной цели до точки
---@return real
function GetParabolaZ(zs, ze, h, d, x)
	return (2 * (zs + ze - 2 * h) * (x / d - 1) + (ze - zs)) * (x / d) + zs
end

---@param xa real
---@param ya real
---@param xb real
---@param yb real
---@return real
function DistanceBetweenXY(xa, ya, xb, yb)
	local dx = xb - xa
	local dy = yb - ya
	return math.sqrt(dx * dx + dy * dy)
end

---@param xa real
---@param ya real
---@param za real
---@param xb real
---@param yb real
---@param zb real
---@return real
function DistanceBetweenXYZ(xa, ya, za, xb, yb, zb)
	local dx = xb - xa
	local dy = yb - ya
	local dz = zb - za
	return math.sqrt(dx * dx + dy * dy + dz * dz)
end

---@param xa real
---@param ya real
---@param xb real
---@param yb real
---@return real radian
function AngleBetweenXY(xa, ya, xb, yb)
	return math.atan(yb - ya, xb - xa)
end

---@param a real radian
---@param b real radian
---@return real radian
function AngleDifference(a, b)
	local c---@type real
	local d---@type real
	if a > b then
		c = a - b
		d = b - a + 2 * math.pi
	else
		c = b - a
		d = a - b + 2 * math.pi
	end
	return c > d and d or c
end

--@author https://xgm.guru/p/wc3/warden-math
---@param a real degrees
---@param b real degrees
---@return real degrees
function AngleDifferenceDeg(a, b)
	a, b = math.abs(a, 360), math.abs(b, 360)
	local x---@type real
	if (a > b) then
		a, b = b, a
	end
	x = b - 360
	if (b - a > a - x) then
		b = x
	end
	return math.abs(a - b)
end

-- Находит длину перпендикуляра от отрезка, заданного xa, ya, xb, yb к точке, заданной xc, yc
--@author https://xgm.guru/p/wc3/perpendicular
---@param xa real
---@param ya real
---@param xb real
---@param yb real
---@param xc real
---@param yc real
---@return real
function Perpendicular (xa, ya, xb, yb, xc, yc)
	return math.sqrt((xa - xc) * (xa - xc) + (ya - yc) * (ya - yc)) * math.sin(math.atan(yc - ya, xc - xa) - math.atan(yb - ya, xb - xa))
end

--@Hate https://xgm.guru/p/wc3/241479
---@param source unit
---@param x real
---@param y real
function SetUnitPositionSmooth(source, x, y)
	local last_x = GetUnitX(source)
	local last_y = GetUnitY(source)
	local bx
	local by
	--print("Смус выполнена")
	SetUnitPosition(source, x, y)
	if (RAbsBJ(GetUnitX(source) - x) > 0.5) or (RAbsBJ(GetUnitY(source) - y) > 0.5) then
		SetUnitPosition(source, x, last_y)
		bx = RAbsBJ(GetUnitX(source) - x) <= 0.5
		SetUnitPosition(source, last_x, y)
		by = RAbsBJ(GetUnitY(source) - y) <= 0.5

		---
		local dx=math.abs(x-last_x)
		if dx>=100 then
			print("Телепорт бак в функции Smooth"..dx )
		end
		---
		if bx then
			SetUnitPosition(source, x, last_y)
		elseif by then
			SetUnitPosition(source, last_x, y)
		else
			SetUnitPosition(source, last_x, last_y)
		end
	end
end

--Bergi
function GetUnitXY(unit)
	return GetUnitX(unit),GetUnitY(unit)
end

function MoveXY(x,y, distance, angle)
	return x + distance * math.cos(angle * bj_DEGTORAD),y + distance * math.sin(angle * bj_DEGTORAD)
end

function UnitCollisionOFF(unit)
	UnitAddAbility(unit,FourCC('A000'))
	IssueImmediateOrder(unit,"windwalk")
end

function AngleBetweenUnits(caster,target)
	local yb,ya,xb,xa=GetUnitY(target),GetUnitY(caster),GetUnitX(target),GetUnitX(caster)
	return Atan2BJ(yb - ya, xb - xa)
end

function math.clamp (inb, low, high) --
	return math.min( math.max(inb, low ), high )
end

function math.lerp(a, b, t)
	return a + (b - a) * t
end

function repeatN(t, m)
	return math.clamp(t - math.floor(t / m) * m, 0, m)
end

function lerpTheta(a, b, t)
	local dt = repeatN(b - a, 360)
	if dt>180 then	dt=dt-360 end
	return math.lerp(a, a + dt, t)
end

function AngleBetweenXYZ(x1, y1,z1, x2, y2,z2)
	local a=x1*x2+y1*y2+z1*z2
	local b=math.sqrt(x1*x1+y1*y1+z1*z1)
	local c=math.sqrt(x2*x2+y2*y2+z2*z2)
	return math.acos(a/(b*c))
end

-- функия принадлежности точки сектора
-- x1, x2 - координаты проверяемой точки
-- x2, y2 - координаты вершины сектора
-- orientation - ориентация сектора в мировых координатах
-- width - уголовой размер сектора в градусах
-- radius - окружности которой принадлежит сектор
function IsPointInSector(x1,y1,x2,y2,orientation,width,radius)
	local lenght=DistanceBetweenXY(x1,y1,x2,y2)
	local angle=Acos(Cos(orientation*bj_DEGTORAD)*(x1-x2)/lenght+Sin(orientation*bj_DEGTORAD)*(y1-y2)/lenght )*bj_RADTODEG
	return angle<=width and lenght<=radius
end

function GetParabolaPitch(height,distance,i, speed)
	local f = function(x)
		return ParabolaZ(height, distance, x)
	end

	local df = function(x)
		return ParabolaZDerivative(height, distance, x)
	end
	local x0 = i * speed
	local x1 = x0 + speed
	local thisZ = f(x0)
	local someTangentZ = Tangent(f, df, x0, x1)
	return math.atan(someTangentZ - thisZ, x1 - x0)--pitch
end
function Tangent(f, df, x0, x)
	return f(x0) + df(x0) * (x - x0)
end
function ParabolaZDerivative(height, distance, x)
	return 4 * height / distance / distance * (distance - 2 * x)
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 21.08.2020 16:24
---
TIMER_PERIOD = 0.03125
function AngleBetweenXY(xa, ya, xb, yb)
	return math.atan(yb - ya, xb - xa)
end
function MoveX(x, distance, angle)
	return x + distance * math.cos(angle * bj_DEGTORAD)
end

function MoveY(y, distance, angle)
	return y + distance * math.sin(angle * bj_DEGTORAD)
end

function AddQuest(hero, qx, qy,message)
	local x, y = GetUnitX(hero), GetUnitY(hero)
	local model = "AneuCaster"
	local player = GetOwningPlayer(hero)
	local isEnd = false
	if GetLocalPlayer() ~= player then
		model = ""
	else
		--print("звук созданного квеста")
		StartSound(bj_questSecretSound)
	end
	local QuestPointer = AddSpecialEffect(model, x, y)
	BlzSetSpecialEffectPitch(QuestPointer, math.rad(-90))--/bj_DEGTORAD
	print(message)
	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		local z = BlzGetLocalUnitZ(hero)
		local xc, yc = GetUnitX(hero), GetUnitY(hero)
		local angle = AngleBetweenXY(xc, yc, qx, qy)
		BlzSetSpecialEffectPosition(QuestPointer, MoveX(xc, 130, angle / bj_DEGTORAD), MoveY(yc, 130, angle / bj_DEGTORAD), z + 10)
		BlzSetSpecialEffectYaw(QuestPointer, angle)

		if IsUnitInRangeXY(hero, qx, qy, 200) then
			isEnd = true
		end

		if isEnd then
			if GetLocalPlayer() == player then
				StartSound(bj_questCompletedSound)
			end
			DestroyTimer(GetExpiredTimer())
			DestroyEffect(QuestPointer)
			print("квест №" .. "1" .. " выполнен, даём награду")
		end
	end)
	TimerStart(CreateTimer(), 10, true, function()
		if isEnd then
			DestroyTimer(GetExpiredTimer())
			--print("Выключаем мигалку")
		else
			PingMinimapForPlayer(player, qx, qy, 3)
		end
	end)
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 05.09.2020 11:50
---
---
--Настройки
HeartAbility=FourCC("A000") --любая способность
HeartAbilityUnits={}
TIMER_PERIOD = 0.03125

do --Инициализация
	TimerStart(CreateTimer(), 1, false, function()
		perebor = CreateGroup()
		TimerStart(CreateTimer(), 1, true, function()
			FindButchers() -- каждую секунду ищем нового мясника и проверяем не попал ли он в систему
		end)
	end)
end

function FindButchers()
	local  e=nil
	GroupEnumUnitsInRect(perebor,bj_mapInitialPlayableArea,nil)
	while true do
		e = FirstOfGroup(perebor)

		if e == nil then break end
		if UnitAlive(e) then
			if  GetUnitAbilityLevel(e,HeartAbility)>0 and not HeartAbilityUnits[GetHandleId(e)] then
				HeartAbilityUnits[GetHandleId(e)]=e
				HearBit(e)
				--print("Юнит добавлен")
			end
		else
			HeartAbilityUnits[GetHandleId(e)]=nil
			--print("Юнит удалён")
		end
		GroupRemoveUnit(perebor,e)
	end
end

function HearBit(hero)
	local healAmount=50
	local loosingHP=100-(GetUnitState(hero,UNIT_STATE_LIFE)/BlzGetUnitMaxHP(hero)*100)
	local nextBit=3-loosingHP*.02
	ScalingIconTimed(BlzGetAbilityIcon(HeartAbility), 0.2, 5, healAmount,hero) -- 5 определяет позицию иконки 1.1
	local tl = Location(GetUnitX(hero),GetUnitY(hero))
	PlaySoundAtPointBJ(soundBit, 100, tl, 0)
	--print("playsoind")
	RemoveLocation(tl)
	--print("Тут лечим юнита "..loosingHP)
	HealUnit(hero,healAmount)
	TimerStart(CreateTimer(), nextBit, false, function()
		if UnitAlive(hero) then
			HearBit(hero)
		else
			HeartAbilityUnits[GetHandleId(hero)]=nil
		end
	end)
end

--ScalingIconTimed(BlzGetAbilityIcon(SpellIDS), 0.2, 5, data.bonusCD,caster)
function ScalingIconTimed(FrameTexture, secShow, posButton, text,hero)
	if not IsUnitSelected(hero,GetOwningPlayer(hero))  then
		return
	end
	local size = 0
	local sec = 0
	local i = 1
	local turn = true
	local next = 0.039
	local fh = BlzCreateFrameByType("BACKDROP", "FaceButtonIcon", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), "", 0)
	BlzFrameSetSize(fh, next, next)
	BlzFrameSetTexture(fh, FrameTexture, 0, true)
	local CBPoz = BlzGetFrameByName("CommandButton_" .. posButton, 0) -- CommandButton_0
	BlzFrameSetPoint(fh, FRAMEPOINT_CENTER, CBPoz, FRAMEPOINT_CENTER, 0, 0)
	local newText = BlzCreateFrameByType("TEXT", "ButtonChargesText", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), "", 0)
	BlzFrameSetText(newText, text)
	BlzFrameSetPoint(newText, FRAMEPOINT_CENTER, CBPoz, FRAMEPOINT_CENTER, 0, 0)

	if not GetLocalPlayer()==GetOwningPlayer(hero) then
		BlzFrameSetVisible(fh,false)
		BlzFrameSetVisible(fh,false)
	end

	TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
		sec = sec + TIMER_PERIOD
		size = size + (i * 0.005)
		if sec >= secShow and turn then
			turn = false
			i = i * (-1)
		end
		if size <= 0 then
			DestroyTimer(GetExpiredTimer())
			BlzDestroyFrame(fh)
			BlzDestroyFrame(newText)
			size = 0
		end
		BlzFrameSetSize(fh, next + size, next + size)
		BlzFrameSetScale(newText, (next + size) * 50)
	end)
end

function FlyTextTag(text, textSize, x, y, z, red, green, blue, alpha, xvel, yvel, fadepoint, lifespan, player)
	local t = CreateTextTag()
	SetTextTagText(t, text, textSize)
	SetTextTagPos(t, x, y, z)
	SetTextTagColor(t, red, green, blue, alpha)
	SetTextTagVelocity(t, xvel, yvel)
	SetTextTagFadepoint(t, fadepoint)
	SetTextTagLifespan(t, lifespan)
	SetTextTagPermanent(t, false)
	if player ~= nil then
		SetTextTagVisibility(t, player == GetLocalPlayer())
	end
	return t
end
function FlyTextTagHealXY(x,y, text, player)
	return FlyTextTag(text, 0.024, x, y, 150, 88, 250, 13, 255, 0, 0.03, 1, 3, player)
end

function HealUnit(hero,amount,flag,eff)
	--1 или nil Сколько вылчено
	--2 Сверхлечение
	if not eff then eff="Abilities\\Spells\\Human\\Heal\\HealTarget" end
	local p=GetOwningPlayer(hero)
	local MaxHP=BlzGetUnitMaxHP(hero)
	local CurrentHP=GetUnitState(hero,UNIT_STATE_LIFE)
	local LoosingHP=MaxHP-CurrentHP
	local OverHeal=amount-LoosingHP
	local TotalHeal=amount
	if LoosingHP<=amount then TotalHeal=LoosingHP	end
	DestroyEffect(AddSpecialEffectTarget(eff,hero,"overhead"))
	SetUnitState(hero,UNIT_STATE_LIFE,CurrentHP+TotalHeal)
	if TotalHeal>1 then
		FlyTextTagHealXY(GetUnitX(hero),GetUnitY(hero),"+"..R2I(TotalHeal),p)
	end
	if not flag or flag==1 then
		return TotalHeal
	end
	if  flag==2 then
		return OverHeal
	end
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 13.02.2021 18:35
---
function normal_sound (s,x,y)
    local  snd = CreateSound(s, false, true, true, 10, 10, "CombatSoundsEAX")
    SetSoundChannel(snd, 40)
    SetSoundVolume(snd, 127)
    SetSoundPitch(snd, 1)
    SetSoundDistances(snd, 600, 10000)
    SetSoundDistanceCutoff(snd, 2100)
    SetSoundConeAngles(snd, 0.0, 0.0, 127)
    SetSoundConeOrientation(snd, 0.0, 0.0, 0.0)
    SetSoundPosition(snd, x, y, 50)
    StartSound(snd)
    KillSoundWhenDone(snd)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 27.05.2020 13:57
---
stuneff="Abilities\\Spells\\Human\\Thunderclap\\ThunderclapTarget"
StunSystem={}
function StunUnit(hero,dur)
	if not StunSystem[GetHandleId(hero)] then
		--	print("оглушен первый раз")
		StunSystem[GetHandleId(hero)]={
			Time=0,
			Eff=nil,
			Timer=nil
		}
	end
	local data=StunSystem[GetHandleId(hero)]

	local curdur=0
	if data.Time==0 then
		data.Timer=CreateTimer()
		--print("старт нового таймера")
		data.Eff=AddSpecialEffectTarget(stuneff,hero,"overhead")
		BlzPauseUnitEx(hero,true)
	end

	if data.Time<dur  then
		--print("Более сильное оглушение, обновляем время")
		data.Time=dur
	else
		--print("Есть более долгое оглушение")
		return
	end

	TimerStart(data.Timer, 0.1, true, function()
		curdur=curdur+0.1
		data.Time=data.Time-0.1
		--print(data.Time)
		if curdur>=dur or not UnitAlive(hero) then
			--print("Вышел из стана")
			BlzPauseUnitEx(hero,false)
			--BlzPauseUnitEx(hero,false)
			DestroyTimer(GetExpiredTimer())
			data.Time=0
			DestroyEffect(data.Eff)
			data.Timer=nil
		end
	end)
end

function StunArea(hero,x,y,range,duration)
	local e=nil
	--DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster",x,y))
	GroupEnumUnitsInRange(perebor,x,y,range,nil)
	while true do
		e = FirstOfGroup(perebor)

		if e == nil then break end
		if UnitAlive(e) and IsUnitEnemy(e,GetOwningPlayer(hero)) and not IsUnitType(e,UNIT_TYPE_STRUCTURE) then
			--	print(GetUnitName(e))
			StunUnit(e,duration)
		end
		GroupRemoveUnit(perebor,e)
	end
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 27.08.2020 19:03
---

do --Инициализация
	TimerStart(CreateTimer(), 1, true, function()
			--HowChild()
	end)
end

function HowChild()
	local tip=BlzGetOriginFrame(ORIGIN_FRAME_UBERTOOLTIP, 0)
	local k=BlzFrameGetChildrenCount(tip)

	local uberchild=BlzFrameGetChild(tip,0)
	BlzFrameSetAlpha(uberchild,128)
	local k2=BlzFrameGetChildrenCount(uberchild)
	print(BlzFrameGetText(uberchild)..k2)
	--Убер чилд имеет 8 детей
	local eight={}
	for i=0,7 do
		eight[i]=BlzFrameGetChild(uberchild,i)
		BlzFrameSetAlpha(eight[i],128)
		local k3=BlzFrameGetChildrenCount(eight[i])
		print(BlzFrameGetText(eight[i]).." emp"..i.." "..k3) -- Выводит пустоту и показывает что 0 потомков
	end
end
---@param text string
---@param textSize real
---@param x real
---@param y real
---@param z real
---@param red integer
---@param green integer
---@param blue integer
---@param alpha integer
---@param xvel real
---@param yvel real
---@param fadepoint real
---@param lifespan real
---@param player player
---@return texttag
function FlyTextTag(text, textSize, x, y, z, red, green, blue, alpha, xvel, yvel, fadepoint, lifespan, player)
	local t = CreateTextTag()
	SetTextTagText(t, text, textSize)
	SetTextTagPos(t, x, y, z)
	SetTextTagColor(t, red, green, blue, alpha)
	SetTextTagVelocity(t, xvel, yvel)
	SetTextTagFadepoint(t, fadepoint)
	SetTextTagLifespan(t, lifespan)
	SetTextTagPermanent(t, false)
	if player ~= nil then
		SetTextTagVisibility(t, player == GetLocalPlayer())
	end
	return t
end

---@param target widget
---@param text string
---@param player player
---@return texttag
function FlyTextTagGoldBounty(target, text, player)
	return FlyTextTag(text, 0.024, GetWidgetX(target) - 16, GetWidgetY(target), 0, 255, 220, 0, 255, 0, 0.03, 2, 3, player)
end

---@param target widget
---@param text string
---@param player player
---@return texttag
function FlyTextTagLumberBounty(target, text, player)
	return FlyTextTag(text, 0.024, GetWidgetX(target) - 16, GetWidgetY(target), 0, 0, 200, 80, 255, 0, 0.03, 2, 3, player)
end

---@param target widget
---@param text string
---@param player player
---@return texttag
function FlyTextTagMiss(target, text, player)
	return FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 255, 0, 0, 255, 0, 0.03, 1, 3, player)
end

---@param target widget
---@param text string
---@param player player
---@return texttag
function FlyTextTagCriticalStrike(target, text, player)
	return FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 255, 0, 0, 255, 0, 0.04, 2, 5, player)
end

---@param target widget
---@param text string
---@param player player
---@return texttag
function FlyTextTagManaBurn(target, text, player)
	return FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 82, 82, 255, 255, 0, 0.04, 2, 5, player)
end

---@param target widget
---@param text string
---@param player player
---@return texttag
function FlyTextTagShadowStrike(target, text, player)
	return FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 160, 255, 0, 255, 0, 0.04, 2, 5, player)
end

function FlyTextTagHealXY(x,y, text, player)
	return FlyTextTag(text, 0.024, x, y, 150, 88, 250, 13, 255, 0, 0.03, 1, 3, player)
end

function FlyTextTagShieldXY(x,y, text, player)--™
	local xr=GetRandomReal(-0.05,0,05)
	return FlyTextTag(""..text, 0.018, x, y, 150, 128, 128, 128, 255, xr, 0.03, 1, 3, player)
end
do
	Vector = {}
	Vector.__index = Vector
end


function Vector:new(x, y, z)
	local v = {x = x, y = y, z = z}
	setmetatable(v, self)
	return v
end

function Vector:copy()
	return Vector:new(self.x, self.y, self.z)
end

function Vector:dot(other)
	return self.x * other.x + self.y * other.y + self.z * other.z
end

function Vector:length()
	return math.sqrt(self.x * self.x + self.y * self.y + self.z * self.z)
end

function Vector:length2d()
	return math.sqrt(self.x * self.x + self.y * self.y)
end

function Vector:__mul(num)
	return Vector:new(self.x * num, self.y * num, self.z * num)
end

function Vector:__div(num)
	return Vector:new(self.x / num, self.y / num, self.z / num)
end

function Vector:__div(num)
	return Vector:new(self.x / num, self.y / num, self.z / num)
end

function Vector:normalize(clone)
	if clone then
		return self / self:length()
	end
	local l = self:length()
	self.x = self.x / l
	self.y = self.y / l
	self.z = self.z / l
	return self
end

function Vector:angleBetween(other)
	return math.acos(self:dot(other) / other:length() / self:length())
end

function Vector:yaw()
	return math.atan(self.y, self.x)
end

function Vector:pitch()
	return math.atan(self.z, self:length2d())
end

function CreateEffectLighting3D(x1, y1, z1, x2, y2, z2, step, effModel,length)
	local vector = Vector:new(x2 - x1, y2 - y1, z2 - z1)
	local normalized = vector:normalize(true)
	local chainCount = math.floor(vector:length() / step)
	local pitch = vector:pitch()
	local yaw = vector:yaw()
	local eff = {}
	if not length then
		length=chainCount
	end
	if length <1 then
		print("ОШИБКА, СЛИШКОМ МАЛО ЭЛЕМЕНТОВ МЕЖДУ ТОЧКАМИ, ЗАДАЙТЕ ЧИСЛО ВРУЧНУЮ length")
		length=100
	end
	for i = 1, length do
		if i<=chainCount then
			eff[i] = AddSpecialEffect(effModel, 0, 0)
			local v = normalized * (step * i)
			BlzSetSpecialEffectPosition(eff[i], x1 + v.x, y1 + v.y, z1 + v.z)
			BlzSetSpecialEffectPitch(eff[i], -pitch)
			BlzSetSpecialEffectYaw(eff[i], yaw)
		else
			eff[i] = AddSpecialEffect(effModel, OutPoint, OutPoint)
		end
	end
	return eff
end

function MoveEffectLighting3D(x1, y1, z1, x2, y2, z2, step, eff,length,isUnit)
	local vector = Vector:new(x2 - x1, y2 - y1, z2 - z1)
	local normalized = vector:normalize(true)
	local chainCount = math.floor(vector:length() / step)
	local pitch = vector:pitch()
	local yaw = vector:yaw()
	if not length then
		length=#eff
	end
	if isUnit then
		pitch=pitch-math.rad(90)
	end

	for i = 1, length do
		local v = normalized * (step * i)
		if i<=chainCount then
			local z = z1 + v.z
			--print(z)
			BlzSetSpecialEffectPosition(eff[i], x1 + v.x, y1 + v.y, z)
			BlzSetSpecialEffectPitch(eff[i], -pitch)
			BlzSetSpecialEffectYaw(eff[i], yaw)

			if true then --эффет перетекания

			end
		else
			--print("молния удалена")
			BlzSetSpecialEffectPosition(eff[i], OutPoint, OutPoint, 0)
		end

	end
	return pitch
end

function DestroyEffectLighting3D(eff)
	for i = 1, #eff do
		BlzSetSpecialEffectPosition(eff[i], OutPoint, OutPoint, 0)
		DestroyEffect(eff[i])
	end
end

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 12.02.2021 15:51
---
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 21.10.2020 0:13
do
    WLD={ --Белый лист из дестрактаблей
        [1]=FourCC('YTfc'),
        [2]=FourCC('YTLb'),
        [3]=FourCC('YtLc'),
        [4]=FourCC('YTac'),
        [5]=FourCC('YTpc'),
        [6]=FourCC('YTab'),
        [7]=FourCC('YTfb'),
        [8]=FourCC('YTpb'),

    }
end

do
    TimerStart(CreateTimer(), .1, false, function()
        InitMouseMoveTrigger()
        PlayUnitAnimationFromChat()
        --InitWASD(hero) --переместить в первый выбор героя
    end)
end

TIMER_PERIOD64=1/64
HERO={}
function InitHeroTable(hero)
    --perebor=CreateGroup()
    --print("InitHeroTable for "..GetUnitName(hero))
    HERO[GetPlayerId(GetOwningPlayer(hero))]={
        UnitHero=hero,
        ReleaseW=false,
        ReleaseS=false,
        ReleaseD=false,
        ReleaseA=false,
        ReleaseLMB=false,
        ReleaseRMB=false,
        isAttacking=false,
        isCharging=false,
        isMoving=false,
        DropInventory=true,
        isShield=false,
        ShieldEff=nil,
        animStand=0, -- внутренняя переменная для сброса анимеции Stand
        ReleaseSPACE=false,
        DirectionMove=0, -- направление движения для рывка
        ChargingAttack=0,
        AttackCount=0,
        ResetSeriesTime=0,
        DamageInSeries={50,80,100},
        CDSpellQ=0,
        AttackInForce=false
    }
end


function InitWASD(hero)
   -- print("initwasdSTART")
    InitHeroTable(hero)
    CreateWASDActions()
    local data=HERO[GetPlayerId(GetOwningPlayer(hero))]
    BlockMouse(data)
    EnableDragSelect(false, false)
    BlzEnableSelections(false, false)
    SelectUnitForPlayerSingle(data.UnitHero,GetOwningPlayer(hero))
    local angle=0
    local speed=5
    local animWalk=0

    TimerStart(CreateTimer(),0.005, true, function() -- устранение бага залипания
        if UnitAlive(hero) then
            --SelectUnitForPlayerSingle(hero,GetOwningPlayer(hero))
            ForceUIKeyBJ(GetOwningPlayer(hero), "M")
            --IssueImmediateOrder(hero, "stop")
        end
    end)


    TimerStart(CreateTimer(),TIMER_PERIOD64, true, function() -- основной таймер для обработки всего
        --data.UnitHero=mainHero -- костыль для смены героя
        hero=data.UnitHero -- костыль для смены героя
        SetCameraQuickPosition(GetUnitX(hero),GetUnitY(hero))
        SetCameraTargetControllerNoZForPlayer(GetOwningPlayer(hero),hero, 10,10,true) -- не дергается

        if data.PressSpin then
            data.ChargingAttack=data.ChargingAttack+TIMER_PERIOD64
            --print(data.ChargingAttack)
            if data.ChargingAttack>=0.9 and not data.isSpined then

                data.isSpined=true
                --print("start spin")
                StartAndReleaseSpin(data)
            end
        else
            data.ChargingAttack=0
            data.isSpined=false
        end


        if data.ResetSeriesTime>0 then
            data.ResetSeriesTime=data.ResetSeriesTime-TIMER_PERIOD64
        else
            data.ResetSeriesTime=0
            data.AttackCount=0
        end
        animWalk=animWalk+TIMER_PERIOD64
        if animWalk>=0.933 then --длительность анимации WALK
            --print(animWalk)
            animWalk=0
        end

        if GetUnitTypeId(hero)==FourCC("opeo") then   -- пеон
            IndexAnimationWalk=1
            local r={2,3,8}
            IndexAnimationAttack=r[GetRandomInt(2,2)] -- 2 для долгой атаки 8 для сплеша 3  атака рубки дерева
        end


        data.IsMoving=false
        if data.ReleaseW and data.ReleaseD == false and data.ReleaseA == false then
            --print("only w")
            angle = 90
            data.IsMoving = true
        end
        if data.ReleaseW and data.ReleaseD then
            --print("w+d")
            angle = 90 - 45
            data.IsMoving = true
        end
        if data.ReleaseW and data.ReleaseA then
            --print("w+s")
            angle = 90 + 45
            data.IsMoving = true
        end

        if data.ReleaseS and data.ReleaseD == false and data.ReleaseA == false then
            angle = 270
            data.IsMoving = true
        end
        if data.ReleaseS and data.ReleaseD then
            angle = 270 + 45
            data.IsMoving = true
        end
        if data.ReleaseS and data.ReleaseA then
            angle = 270 - 45
            data.IsMoving = true
        end

        if data.ReleaseD and data.ReleaseW == false and data.ReleaseS == false then
            angle = 0
            data.IsMoving = true
        end

        if data.ReleaseA and data.ReleaseW == false and data.ReleaseS == false then
            angle = 180
            data.IsMoving = true
        end

        if not UnitAlive(hero) then
            --data.ReleaseW=false
            --data.ReleaseA=false
            --data.ReleaseS=false
            --data.ReleaseD=false
        end
        if not StunSystem[GetHandleId(hero)] then
            StunUnit(hero,0.2)
        end
        if  StunSystem[GetHandleId(data.UnitHero)].Time==0 and onForces[GetHandleId(hero)] then--and
            if  UnitAlive(hero) and not data.isShield and not data.isAttacking and not data.ReleaseRMB then -- тут было условие атаки
                if data.IsMoving then -- двигается
                    data.DirectionMove=angle

                        speed=5

                    if  data.isAttacking or (data.ReleaseQ and data.CDSpellQ>0) or data.ReleaseRMB then
                        speed=0.5
                    end
                    local x,y=GetUnitXY(hero)
                    local nx,ny=MoveXY(x,y,speed,angle)
                    if not data.isAttacking then
                        SetUnitFacing(hero, angle)-- место для поворота в движении
                    end
                    SetUnitPositionSmooth(hero,nx,ny)-- блок движения

                    if animWalk==0  then-- and not data.ReleaseRMB
                       -- print("сброс анимации")
                            SetUnitAnimationByIndex(hero,IndexAnimationWalk)
                            local r={SoundStep1,SoundStep2,SoundStep3,SoundStep4}
                        data.animStand=3
                    end
                else -- стоит на месте
                    --if animWalk==0 then
                    data.DirectionMove=GetUnitFacing(hero)
                    data.animStand=data.animStand+TIMER_PERIOD64
                    if data.animStand>=2 and not data.ReleaseQ and not data.ReleaseRMB then --длительность анимации WALK
                        --print(animWalk)
                        ResetUnitAnimation(hero) -- сборс в положении стоя
                        --print("дефолтный сборс")
                        data.animStand=0
                    end
                    --end
                    --print("r")--..GetUnitName(mainHero)
                end
            else
                --print("onattaking")
            end
        else-- иначе юнит оглушен
           -- SetUnitAnimationByIndex(hero,5)
            UnitRemoveAbility(hero,FourCC("A003"))
            UnitRemoveAbility(hero,FourCC("A004"))
        end
   end)
end

function CreateWASDActions()
    -----------------------------------------------------------------OSKEY_W
    --print("initwasdactions")
    local gg_trg_EventUpW = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpW, Player(i), OSKEY_W, 0, true)
        BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpW, Player(i), OSKEY_UP, 0, true)
    end
    TriggerAddAction(gg_trg_EventUpW, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        --print("W "..GetUnitName(data.UnitHero))
        if not data.ReleaseW  and  UnitAlive(data.UnitHero) then --and not data.isAttacking
            data.ReleaseW = true
            --print("W2")
            --SelectUnitForPlayerSingle(data.UnitHero,GetTriggerPlayer())
            if  not data.isAttacking and StunSystem[GetHandleId(data.UnitHero)].Time==0 then
                --print("pressW and short anim")
                UnitAddForceSimple(data.UnitHero,90,5, 15)
                data.DirectionMove=90
                data.animStand=1.8 --до полной анимации 2 секунды
                SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)
            end

        end
    end)
    local TrigDepressW = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDepressW, Player(i), OSKEY_W, 0, false)
        BlzTriggerRegisterPlayerKeyEvent(TrigDepressW, Player(i), OSKEY_UP, 0, false)
    end
    TriggerAddAction(TrigDepressW, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        data.ReleaseW = false
    end)
    -----------------------------------------------------------------OSKEY_S
    local gg_trg_EventUpS = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpS, Player(i), OSKEY_S, 0, true)
        BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpS, Player(i), OSKEY_DOWN, 0, true)
    end
    TriggerAddAction(gg_trg_EventUpS, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        if not data.ReleaseS and UnitAlive(data.UnitHero) then
            data.ReleaseS = true
            --SelectUnitForPlayerSingle(data.UnitHero,Player(0))
            if  not data.isAttacking  and StunSystem[GetHandleId(data.UnitHero)].Time==0 then
                data.animStand=1.8 --до полной анимации 2 секунды
                UnitAddForceSimple(data.UnitHero,270,5, 15)
                data.DirectionMove=270
                SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)

            end
        end
    end)
    local TrigDepressS = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDepressS, Player(i), OSKEY_S, 0, false)
        BlzTriggerRegisterPlayerKeyEvent(TrigDepressS, Player(i), OSKEY_DOWN, 0, false)
    end
    TriggerAddAction(TrigDepressS, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        data.ReleaseS = false
    end)
    -----------------------------------------------------------------OSKEY_D
    local TrigPressD = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigPressD, Player(i), OSKEY_D, 0, true)
        BlzTriggerRegisterPlayerKeyEvent(TrigPressD, Player(i), OSKEY_RIGHT, 0, true)
    end
    TriggerAddAction(TrigPressD, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        if not data.ReleaseD   and UnitAlive(data.UnitHero) then
            data.ReleaseD = true
            --SelectUnitForPlayerSingle(data.UnitHero,Player(0))
            if  not data.isAttacking  and StunSystem[GetHandleId(data.UnitHero)].Time==0 then
                data.animStand=1.8 --до полной анимации 2 секунды
                UnitAddForceSimple(data.UnitHero,0,5, 15)
                data.DirectionMove=0
                SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)

            end
        end
    end)
    local TrigDePressD = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDePressD, Player(i), OSKEY_D, 0, false)
        BlzTriggerRegisterPlayerKeyEvent(TrigDePressD, Player(i), OSKEY_RIGHT, 0, false)
    end
    TriggerAddAction(TrigDePressD, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        data.ReleaseD = false

    end)
    -----------------------------------------------------------------OSKEY_A
    local TrigPressA = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigPressA, Player(i), OSKEY_A, 0, true)
        BlzTriggerRegisterPlayerKeyEvent(TrigPressA, Player(i), OSKEY_LEFT, 0, true)
    end
    TriggerAddAction(TrigPressA, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        if not data.ReleaseA  and  UnitAlive(data.UnitHero) and StunSystem[GetHandleId(data.UnitHero)].Time==0 then
            data.ReleaseA = true
            --SelectUnitForPlayerSingle(data.UnitHero,Player(0))
            if  not data.isAttacking  then -- нет проверки на стан
                data.animStand=1.8 --до полной анимации 2 секунды
                data.DirectionMove=180
                UnitAddForceSimple(data.UnitHero,180,5, 15)
                SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)
            end
        end
    end)
    local TrigDePressA = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDePressA, Player(i), OSKEY_A, 0, false)
        BlzTriggerRegisterPlayerKeyEvent(TrigDePressA, Player(i), OSKEY_LEFT, 0, false)
    end
    TriggerAddAction(TrigDePressA, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        data.ReleaseA = false
    end)
    -----------------------------------------------------------------OSKEY_SPACE
    local TrigPressSPACE = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigPressSPACE, Player(i), OSKEY_SPACE, 0, true)
    end
    TriggerAddAction(TrigPressSPACE, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        if not data.ReleaseSPACE   and  UnitAlive(data.UnitHero) and StunSystem[GetHandleId(data.UnitHero)].Time==0 then
            data.ReleaseSPACE = true
            --SelectUnitForPlayerSingle(data.UnitHero,Player(0))
            if not data.SpaceForce then
                data.animStand=1.8 --до полной анимации 2 секунды
                --print("SPACE")
                UnitAddItemById(data.UnitHero,FourCC("I000")) -- предмет виндволк
                BlzSetUnitFacingEx(data.UnitHero,data.DirectionMove)
                UnitAddForceSimple(data.UnitHero,data.DirectionMove,25, 200,"ignore")
                data.SpaceForce=true
                local eff=AddSpecialEffectTarget("Hive\\Windwalk\\Windwalk Necro Soul\\Windwalk Necro Soul",data.UnitHero,"origin")

                TimerStart(CreateTimer(), 0.2, false, function()
                    DestroyEffect(eff)
                    data.SpaceForce=false
                end)
                SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)
            end
        end
    end)
    local TrigDePressSPACE = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDePressSPACE, Player(i), OSKEY_SPACE, 0, false)

    end
    TriggerAddAction(TrigDePressSPACE, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        data.ReleaseSPACE = false
    end)
    -----------------------------------------------------------------OSKEY_Q
    local TrigPressQ = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigPressQ, Player(i), OSKEY_Q, 0, true)
    end
    TriggerAddAction(TrigPressQ, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        if not data.ReleaseQ   and  UnitAlive(data.UnitHero) and StunSystem[GetHandleId(data.UnitHero)].Time==0 then

            --SelectUnitForPlayerSingle(data.UnitHero,Player(0))
            if not data.ReleaseQ and not data.ReleaseLMB and data.CDSpellQ==0 and not data.ReleaseRMB then
                data.CDSpellQ=3
                TimerStart(CreateTimer(), 1, true, function()
                    data.CDSpellQ=data.CDSpellQ-1
                    if data.CDSpellQ<=0 then
                        data.CDSpellQ=0
                        DestroyTimer(GetExpiredTimer())
                    end
                end)
                data.animStand=1.8 --до полной анимации 2 секунды
                --print("Q spell")
                data.ReleaseQ = true
                SetUnitAnimationByIndex(data.UnitHero,3)
                TimerStart(CreateTimer(), 0.35, false, function()
                    SpellSlashQ(data)
                    data.ReleaseQ = false
                end)
            end
        end
    end)
    local TrigDePressQ = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDePressQ, Player(i), OSKEY_Q, 0, false)

    end
    TriggerAddAction(TrigDePressQ, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        --data.ReleaseQ = false
    end)
    -----------------------------------------------------------------LMB
    local TrigPressLMB = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        TriggerRegisterPlayerEvent(TrigPressLMB, Player(i), EVENT_PLAYER_MOUSE_DOWN)
    end
    TriggerAddAction(TrigPressLMB, function()
        --print("any")
        if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_LEFT then
            --это левый клик всё внутри LMB

            local pid = GetPlayerId(GetTriggerPlayer())

            GetPlayerMouseX[pid]=BlzGetTriggerPlayerMouseX()
            GetPlayerMouseY[pid]=BlzGetTriggerPlayerMouseY()

            local data = HERO[pid]
            if  UnitAlive(data.UnitHero) then
                data.PressSpin=true
                if data.ReleaseRMB  then
                    --Charge(data)
                end

                if not data.SpaceForce then
                    attack(data)
                else
                    SetUnitAnimationByIndex(data.UnitHero,9) --стойка вытянут топор
                    --print("Удар в рЫвке")
                    data.AttackInForce=true
                end
            else
                --print("Герой мёртв")
            end
        end
    end)
    local TrigDePressLMB = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        TriggerRegisterPlayerEvent(TrigDePressLMB, Player(i), EVENT_PLAYER_MOUSE_UP)
    end

    TriggerAddAction(TrigDePressLMB, function()
        --print("any")
        if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_LEFT then
            local pid = GetPlayerId(GetTriggerPlayer())
            local data = HERO[pid]
            --data.ReleaseLMB = false
            data.PressSpin=false
        end
    end)
    -----------------------------------------------------------------RMB
    local TrigPressRMB = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        TriggerRegisterPlayerEvent(TrigPressRMB, Player(i), EVENT_PLAYER_MOUSE_DOWN)
    end
    TriggerAddAction(TrigPressRMB, function()
        if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_RIGHT then
            -- это правая кнопка
            local pid = GetPlayerId(GetTriggerPlayer())

            GetPlayerMouseX[pid]=BlzGetTriggerPlayerMouseX()
            GetPlayerMouseY[pid]=BlzGetTriggerPlayerMouseY()

            local data = HERO[pid]
            --data.Shield=true

            if  UnitAlive(data.UnitHero)  and not data.ReleaseRMB and not data.ReleaseQ then --and IsUnitType(data.UnitHero,UNIT_TYPE_HERO)
                if StunSystem[GetHandleId(data.UnitHero)].Time==0 then -- not data.isAttacking  and -- убрал атаку у щита
                    --data.isShield=true
                    --print("попытка выстрела")
                    data.ReleaseRMB = true
                    data.animStand=1.8
                    SetUnitAnimationByIndex(data.UnitHero,2)
                    local angle=AngleBetweenXY(GetUnitX(data.UnitHero),GetUnitY(data.UnitHero), GetPlayerMouseX[pid],GetPlayerMouseY[pid]) / bj_DEGTORAD
                    SetUnitFacing(data.UnitHero,angle)
                    TimerStart(CreateTimer(), 0.38, false, function()

                        data.ReleaseRMB = false

                    end)

                    TimerStart(CreateTimer(), 0.3, false, function()
                        --print("выстрел")
                        local xs,ys=MoveXY(GetUnitX(data.UnitHero),GetUnitY(data.UnitHero),40,angle)
                        CreateAndForceBullet(data.UnitHero,angle,50,"Abilities\\Weapons\\GryphonRiderMissile\\GryphonRiderMissile.mdl",xs,ys)
                    end)
                end

                if data.ReleaseLMB then
                    -- Charge(data)
                end
                if not data.ReleaseRMB then
                   -- data.ReleaseRMB = true
                    --Charge(data)
                end

            end
        end
    end)
    local TrigDePressRMB = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        TriggerRegisterPlayerEvent(TrigDePressRMB, Player(i), EVENT_PLAYER_MOUSE_UP)
    end
    TriggerAddAction(TrigDePressRMB, function()
        --print("depress")
        if BlzGetTriggerPlayerMouseButton() == MOUSE_BUTTON_TYPE_RIGHT then
            local pid = GetPlayerId(GetTriggerPlayer())
            local data = HERO[pid]
            local hero = data.UnitHero
            --data.ReleaseRMB = false

            -- print("мышка отпущена")

            if UnitAlive(hero) and not data.ReleaseRMB then
                if data.ReleaseA or data.ReleaseW or data.ReleaseS or data.ReleaseD then
                     --print("Скольжение2") --
                    SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)
                end
            end
        end
    end)
end
---MouseX,MouseY=0,0
function BlockMouse(data)
    local this=CreateTrigger()
    TriggerRegisterAnyUnitEventBJ(this, EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
    TriggerRegisterAnyUnitEventBJ(this, EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
    TriggerAddAction(this, function()
        --  MouseX,MouseY=GetPlayerMouseX
        --print(OrderId2String(GetUnitCurrentOrder(mainHero)))
        if OrderId2String(GetUnitCurrentOrder(data.UnitHero))=="dropitem" then
            data.DropInventory=false
            TimerStart(CreateTimer(), 2, false, function()
                data.DropInventory=true
            end)
        end

        if OrderId2String(GetUnitCurrentOrder(data.UnitHero))=="smart" or OrderId2String(GetUnitCurrentOrder(data.UnitHero))=="move"  then --Строковый список приказов, которые игрок не может выполнить
            BlzPauseUnitEx(data.UnitHero,true)
            BlzPauseUnitEx(data.UnitHero,false)
        end
    end)
end
function attack(data)
    if not data.ReleaseLMB and  UnitAlive(data.UnitHero) then
        data.ReleaseLMB = true
        if not data.isAttacking  then
            --print("пытаемся атаковать, запускаем кд атаки и прерываем движение")
            --print("a "..GetUnitName(mainHero))
            local cdAttack=0.3
            local indexAnim=3
            data.isAttacking=true
            data.ResetSeriesTime=1
            data.AttackCount=data.AttackCount+1




            if data.AttackCount==1 then -- первый обычный удар
                indexAnim=3
                normal_sound("Sound\\PeonSound\\cut\\Abl",GetUnitXY(data.UnitHero))
            end
            if data.AttackCount==2 then -- второй удар
                local r=GetRandomInt(1,2)

                if r==1 then
                    indexAnim=2
                    cdAttack=0.5
                    UnitAddForceSimple(data.UnitHero,GetUnitFacing(data.UnitHero),10, 60)
                    normal_sound("Sound\\PeonSound\\cut\\Bey",GetUnitXY(data.UnitHero))
                else
                    normal_sound("Sound\\PeonSound\\cut\\SaysNo",GetUnitXY(data.UnitHero))
                end
            end
            if data.AttackCount==3 then -- ТРЕТИЙ удар
                indexAnim=8
                cdAttack=1

                normal_sound("Sound\\PeonSound\\cut\\BloodlustTarget",GetUnitXY(data.UnitHero))
                TimerStart(CreateTimer(), 0.2, false, function()
                    normal_sound("abilities\\weapons\\bristlebackmissile\\bristlebackmissilelaunch3",GetUnitXY(data.UnitHero))
                    UnitAddForceSimple(data.UnitHero,GetUnitFacing(data.UnitHero),20, 120)

                    local damage=data.DamageInSeries[3]
                    --print(damage)
                    local nx,ny=MoveXY(GetUnitX(data.UnitHero),GetUnitY(data.UnitHero),50,GetUnitFacing(data.UnitHero))
                    local is,enemy,k=UnitDamageArea(data.UnitHero,damage,nx,ny,300,true)

                    if is then
                        normal_sound("Sound\\Units\\Combat\\MetalMediumBashStone1",GetUnitXY(data.UnitHero))
                    end
                    --Вот тут создадим эффект
                    nx,ny=MoveXY(GetUnitX(data.UnitHero),GetUnitY(data.UnitHero),50,GetUnitFacing(data.UnitHero))
                    local eff=AddSpecialEffect("Hive\\Culling Slash\\Culling Cleave\\Culling Cleave",nx,ny)
                    BlzSetSpecialEffectYaw(eff, math.rad(GetUnitFacing(data.UnitHero)))
                end)
            end


            SetUnitAnimationByIndex(data.UnitHero,indexAnim)
            local angle=-180+AngleBetweenXY(GetPlayerMouseX[0],GetPlayerMouseY[0],GetUnitX(data.UnitHero),GetUnitY(data.UnitHero))/bj_DEGTORAD
            local damage=data.DamageInSeries[data.AttackCount]
            BlzSetUnitFacingEx(data.UnitHero,angle) --был обычный поворот

            TimerStart(CreateTimer(), cdAttack, false, function() -- кд атаки тут
                local nx,ny=MoveXY(GetUnitX(data.UnitHero),GetUnitY(data.UnitHero),100,GetUnitFacing(data.UnitHero))
                if data.AttackCount~=3 and data.AttackCount>0 and StunSystem[GetHandleId(data.UnitHero)].Time==0 then
                    local is,_,k=UnitDamageArea(data.UnitHero,damage,nx,ny,100)
                    if is then
                        --print("Звук попадания обычной атакой"..data.AttackCount)
                        normal_sound("Sound\\Units\\Combat\\MetalMediumBashStone2",GetUnitXY(data.UnitHero))
                    end

                end
            end)

            TimerStart(CreateTimer(), cdAttack+0.05, false, function()
                data.isAttacking=false

                if data.IsMoving then --быстрый возврат после атаки в последнее состояние
                    SetUnitAnimationByIndex(data.UnitHero,IndexAnimationWalk)
                else
                    ResetUnitAnimation(data.UnitHero) -- после атаки
                end
                data.ReleaseLMB = false
            end)

            if data.AttackCount>=3 then
                data.AttackCount=0
            end
        end
    end
end




----- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
onForces = {}
function UnitAddForceSimple(hero, angle, speed, distance,flag)
    -- псевдо вектор использовать только для юнитов
    local currentdistance = 0
    if onForces[GetHandleId(hero)] == nil then
        onForces[GetHandleId(hero)] = true
    end
    if not IsUnitType(hero, UNIT_TYPE_STRUCTURE) and (onForces[GetHandleId(hero)] or flag=="ignore")  then
        onForces[GetHandleId(hero)]=false
        local m=0
        TimerStart(CreateTimer(), TIMER_PERIOD64, true, function()
            currentdistance = currentdistance + speed
            --print(currentdistance)
            local x, y = GetUnitX(hero), GetUnitY(hero)
            local newX, newY = MoveX(x, speed, angle), MoveY(y, speed, angle)
            SetUnitPositionSmooth(hero, newX, newY)

            if flag=="ignore" and HERO[0].AttackInForce then --FIXME

                --print("попытка нанести урон в рывке")
                if UnitDamageArea(hero,50,newX, newY,200,true) then
                    normal_sound("Sound\\Units\\Combat\\MetalMediumBashStone"..GetRandomInt(1,3),GetUnitXY(HERO[0].UnitHero))
                    -- print("нанесение урона после рывка")

                end
            end

            if flag=="dust" then
                DestroyEffect(AddSpecialEffect( "Objects\\Spawnmodels\\Undead\\ImpaleTargetDust\\ImpaleTargetDust.mdl",newX, newY))
            end

            if currentdistance >= distance then --закончил движение
                --or (data.OnWater and data.OnTorrent==false)
                --data.IsDisabled=false
                --data.OnWater=false

                HERO[0].AttackInForce=false --FIXME
                HERO[0].ResetSeriesTime=0

                if flag==5 then
                    ShowUnit(hero,true)

                end

                if flag==6 then -- башлорд конец бега
                    ResetUnitAnimation(hero)
                    BlzPauseUnitEx(hero,false)
                    SetUnitTimeScale(hero,1)
                end

                if IsUnitType(hero,UNIT_TYPE_HERO) then
                    if HERO[0].isCharging then
                        --print("рывок окончен")
                        --DestroyTimer(GetExpiredTimer())
                        --onForces[GetHandleId(hero)]=true
                        --HERO[0].isCharging=false
                        ResetUnitAnimation(hero)
                    end
                end
                DestroyTimer(GetExpiredTimer())
                onForces[GetHandleId(hero)]=true
                --print("stop cur="..currentdistance.." dist="..distance)
            end
        end)
    end
end

GetPlayerMouseX = {}
GetPlayerMouseY = {}
function InitMouseMoveTrigger()
    local MouseMoveTrigger = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        local player = Player(i)
        TriggerRegisterPlayerEvent(MouseMoveTrigger, player, EVENT_PLAYER_MOUSE_MOVE)
        GetPlayerMouseX[i] = 0
        GetPlayerMouseY[i] = 0
    end
    TriggerAddAction(MouseMoveTrigger, function()
        local id = GetPlayerId(GetTriggerPlayer())
        if BlzGetTriggerPlayerMouseX() ~= 0 then
            GetPlayerMouseX[id] = BlzGetTriggerPlayerMouseX()
            GetPlayerMouseY[id] = BlzGetTriggerPlayerMouseY()
        end
    end)
end

function UnitDamageArea(u,damage,x,y,range,force)
    local isdamage=false
    local e=nil
    local hero=nil
    GroupEnumUnitsInRange(perebor,x,y,range,nil)
    local k=0
    while true do
        e = FirstOfGroup(perebor)
        if e == nil then break end
        if UnitAlive(e) and UnitAlive(u) and (IsUnitEnemy(e,GetOwningPlayer(u)) or GetOwningPlayer(e)==Player(PLAYER_NEUTRAL_PASSIVE)) then
            UnitDamageTarget( u, e, damage, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS)
            isdamage=true
            hero=e
            k=k+1
            if force then
                UnitAddForceSimple(e,AngleBetweenUnits(u,e),10,50)
            end
        end
        GroupRemoveUnit(perebor,e)
    end
    if PointContentDestructable(x,y,range,true,1+damage,u) then	isdamage=true	end
    return isdamage,hero,k
end

GlobalRect=Rect(0,0,0,0)
function PointContentDestructable (x,y,range,iskill,damage,flag)
    local content=false
    if range==nil then range=80 end
    if iskill==nil then iskill=false end
    local d=nil
    SetRect(GlobalRect, x - range, y - range, x + range, y +range)
    EnumDestructablesInRect(GlobalRect,nil,function ()
        d=GetEnumDestructable()
        if GetDestructableLife(d)>0 then
            content=true

            if  (GetDestructableTypeId(d)==FourCC("B005") or GetDestructableTypeId(d)==FourCC("OTip") ) and  flag==1 then -- блокиратор или платформа
                content=false
            end
            if iskill then
                if GetUnitTypeId(flag)==FourCC("Hpal") then
                    local tl = Location(GetUnitXY(flag))
                    local r=GetRandomInt(1,2)
                    if r==1 then
                        --PlaySoundAtPointBJ(SoundAttack5, 100, tl, 0)
                    else
                        --PlaySoundAtPointBJ(SoundAttack6, 100, tl, 0)
                    end
                    RemoveLocation(tl)
                end
                SetDestructableLife(d,GetDestructableLife(d)-damage)
                if GetDestructableLife(d)>=1 then
                    SetDestructableAnimation(d,"Stand Hit")
                end
                --KillDestructable(d)
            end
        end
    end)
    return content,d
end

function PlayUnitAnimationFromChat()
    local this=CreateTrigger()
    TriggerRegisterPlayerChatEvent(this,Player(0),"",true)
    TriggerAddAction(this, function()
        local s=S2I(GetEventPlayerChatString())
        local data=HERO[GetPlayerId(GetTriggerPlayer())]
        if GetEventPlayerChatString()=="w" then
            --CreateForUnitWayToPoint(mainHero,CQX,CQY)
            return
        end
        if GetEventPlayerChatString()=="m" then
            UnitAddItemById(data.UnitHero,FourCC("I00A"))
            --print("получена руна морфа, где форма мышей")
            return
        end
        if GetEventPlayerChatString()=="n" then
            UnitAddItemById(data.UnitHero,FourCC("I00B"))
            return
        end
        if GetEventPlayerChatString()=="l" then
            --PlaySoundNearUnit(data.UnitHero,gg_snd_LightningBolt)
            return
        end
        if GetEventPlayerChatString()=="peon" then
            SetUnitPositionSmooth(data.UnitHero,-5500,-3000)
            return
        end
        SetUnitAnimationByIndex(data.UnitHero,s)
        --print(GetUnitName(mainHero).." "..s)
    end)
end
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 04.07.2020 2:23
---

onForces2 = {}
function UnitAddForceSimple2(hero, angle, speed, distance)
	-- псевдо вектор использовать только для юнитов
	local currentdistance = 0
	if onForces[GetHandleId(hero)] == nil then
		onForces[GetHandleId(hero)] = true
	end
	if not IsUnitType(hero, UNIT_TYPE_STRUCTURE) and onForces[GetHandleId(hero)]  then
		onForces[GetHandleId(hero)]=false
		TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
			currentdistance = currentdistance + speed
			--print(currentdistance)
			local x, y = GetUnitX(hero), GetUnitY(hero)
			local newX, newY = MoveX(x, speed, angle), MoveY(y, speed, angle)

			SetUnitPositionSmooth(hero, newX, newY)

			if currentdistance >= distance then
				--or (data.OnWater and data.OnTorrent==false)
				--data.IsDisabled=false
				--data.OnWater=false
				DestroyTimer(GetExpiredTimer())
				onForces[GetHandleId(hero)]=true
				UnitRemoveAbility(hero,FourCC("BOwk"))
				--print("stop cur="..currentdistance.." dist="..distance)
			end
		end)
	end
end
--CUSTOM_CODE
function InitCustomPlayerSlots()
    SetPlayerStartLocation(Player(0), 0)
    SetPlayerColor(Player(0), ConvertPlayerColor(0))
    SetPlayerRacePreference(Player(0), RACE_PREF_HUMAN)
    SetPlayerRaceSelectable(Player(0), true)
    SetPlayerController(Player(0), MAP_CONTROL_USER)
end

function InitCustomTeams()
    SetPlayerTeam(Player(0), 0)
end

function main()
    SetCameraBounds(-3328.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), -3584.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM), 3328.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), 3072.0 - GetCameraMargin(CAMERA_MARGIN_TOP), -3328.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), 3072.0 - GetCameraMargin(CAMERA_MARGIN_TOP), 3328.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), -3584.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM))
    SetDayNightModels("Environment\\DNC\\DNCLordaeron\\DNCLordaeronTerrain\\DNCLordaeronTerrain.mdl", "Environment\\DNC\\DNCLordaeron\\DNCLordaeronUnit\\DNCLordaeronUnit.mdl")
    NewSoundEnvironment("Default")
    SetAmbientDaySound("LordaeronSummerDay")
    SetAmbientNightSound("LordaeronSummerNight")
    SetMapMusic("Music", true, 0)
    CreateRegions()
    InitBlizzard()
    InitGlobals()
end

function config()
    SetMapName("TRIGSTR_003")
    SetMapDescription("TRIGSTR_005")
    SetPlayers(1)
    SetTeams(1)
    SetGamePlacement(MAP_PLACEMENT_USE_MAP_SETTINGS)
    DefineStartLocation(0, -2368.0, 2112.0)
    InitCustomPlayerSlots()
    SetPlayerSlotAvailable(Player(0), MAP_CONTROL_USER)
    InitGenericPlayerSlots()
end

