---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 31.03.2021 1:09
---

function StartSpiderAI(boss)
    SpiderBoss = boss
    local bsx, bsy = GetUnitXY(boss) --стартовая позиция босса
    BlzSetUnitBaseDamage(boss, 10 * CurrentGameZone, 0)
    BOSS = boss
    BossDamaged2(boss)
    BlzSetUnitMaxHP(boss, 6000)
    UnitAddShield(boss, 8000)
    UnitAddAbility(boss, FourCC("Abun"))
    HealUnit(boss)
    local BossFight = true
    --print("Запущен ИИ Босса")

    local phase = 4 --стартовая фаза
    local sec = 0
    local PhaseOn = true
    local OnAttack = true
    TimerStart(CreateTimer(), 1, true, function()
        --каждую секунду
        local x, y = GetUnitXY(boss)
        if IsUnitHasShield(boss) then
            SetUnitState(boss, UNIT_STATE_MANA, GetUnitState(boss, UNIT_STATE_MANA) + 100) --Реген
        end
        if not UnitAlive(boss) then
            -- Место где босс умер
            StartSound(bj_questCompletedSound)
            DestroyTimer(GetExpiredTimer())
            phase = 0
            CreateGodTalon(x, y, "CodoHeart")
            --print("Даём нарграду? ,босс повержен")
        else
            --Проверяем есть ли живые герои,
            if BossFight then
                if not IsUnitInRangeXY(boss, bsx, bsy, 1500) then
                    BossFight = false
                    phase = 0
                    IssuePointOrder(boss, "move", bsx, bsy)
                    DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", GetUnitXY(boss)))
                    SetUnitPositionSmooth(boss, bsx, bsy)
                    DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", GetUnitXY(boss)))
                    --print("Герой мерт или далеко ушёл, остановка фаз")
                end
            end
        end
        if BossFight then
            -- если идёт бой и каждую фазу
            sec = sec + 1
            if GetUnitLifePercent(boss) <= 25 then
                --UnitAddAbility(boss,FourCC("A00N"))
                local enemy = GetRandomEnemyHero()
                if IsUnitInRange(enemy, boss, 250) and GetRandomInt(1, 2) == 1 then
                    CreateCocoon(x,y)
                end
            else
                -- UnitRemoveAbility(boss,FourCC("A00N"))
            end
            if sec >= 10 then
                sec = 0
                phase = phase + 1
                PhaseOn = true
                --print("phase " .. phase)
                if phase >= 5 then
                    phase = 0
                end
            end
            --фазы
            if phase == 1 and PhaseOn then
                PhaseOn = false
                --призыв паучат
                IssuePointOrder(boss, "move", GetUnitXY(GetRandomEnemyHero()))
                for i = 1, 8 do
                    CreateCreepDelay(FourCC("nspg"), x, y, 1, "summon")
                end
            end
            if phase == 2 and PhaseOn then
                PhaseOn = false
                --print("Плевки кислотой")
                TimerStart(CreateTimer(), 0.6, true, function()
                    local enemy = GetRandomEnemyHero()
                    if not IsUnitStunned(boss) and enemy and not IsUnitType(boss, UNIT_TYPE_POLYMORPHED) then
                        local angle = AngleBetweenUnits(boss, enemy)
                        BlzPauseUnitEx(boss, true)
                        SetUnitAnimation(boss, "attack")
                        --SetUnitTimeScale(unit,0.7)
                        SetUnitFacing(boss, angle)
                        TimerStart(CreateTimer(), 0.3, false, function()
                            CreateAndForceBullet(boss, angle, 30, "Abilities\\Weapons\\DemonHunterMissile\\DemonHunterMissile.mdl", nil, nil, 50, 3000)
                            if GetUnitManaPercent(boss) < 30 then
                                CreateAndForceBullet(boss, angle + 10, 20, "Abilities\\Weapons\\DemonHunterMissile\\DemonHunterMissile.mdl", nil, nil, 50, 3000)
                                CreateAndForceBullet(boss, angle - 10, 20, "Abilities\\Weapons\\DemonHunterMissile\\DemonHunterMissile.mdl", nil, nil, 50, 3000)
                            end
                            BlzPauseUnitEx(boss, false)
                        end)
                    end
                    if phase ~= 2 then
                        DestroyTimer(GetExpiredTimer())
                    end
                end)
            end
            if phase == 3 and PhaseOn then
                PhaseOn = false
                --print("Создание паутины")
                IssuePointOrder(boss, "move", GetUnitXY(GetRandomEnemyHero()))
                TimerStart(CreateTimer(), 3, true, function()
                    --тут нужно какое-то действие
                    local angle = GetRandomInt(0, 360)
                    local xn, yn = MoveXY(x, y, angle + 200, angle)
                    CreateWeb(boss, x, y)
                    IssuePointOrder(boss, "move", xn, yn)

                    if phase ~= 3 then
                        -- print("фаза "..phase.." завершена")
                        DestroyTimer(GetExpiredTimer())
                        --BlzPauseUnitEx(boss,false)
                    end
                end)
            end

            if phase == 4 and PhaseOn then
                --print("Создание коконов")
                PhaseOn = false
                IssuePointOrder(boss, "move", GetUnitXY(GetRandomEnemyHero()))
                TimerStart(CreateTimer(), 1, true, function()
                    --тут нужно какое-то действие
                    local angle = GetRandomInt(0, 360)
                    local xn, yn = MoveXY(x, y, 300, angle)
                    CreateCocoon(x, y)
                    IssuePointOrder(boss, "move", xn, yn)

                    if phase ~= 4 then
                        -- print("фаза "..phase.." завершена")
                        DestroyTimer(GetExpiredTimer())
                        --BlzPauseUnitEx(boss,false)
                    end
                end)
            end
        else
            -- перезапуск боссфайта

        end--конец
    end)
end

function CreateCocoon(x, y)
    CreateDestructable(FourCC("DTes"), x, y, GetRandomInt(0, 360), GetRandomReal(0.5, 1.5), 1)
end
function CreateWeb(boss, x, y)
    CreateUnit(GetOwningPlayer(boss), FourCC("h002"), x, y, GetRandomInt(0, 360))
    local eff = AddSpecialEffect("SystemGeneric\\web2", x, y)
    BlzSetSpecialEffectYaw(eff, math.rad(GetRandomInt(0, 360)))
    BlzSetSpecialEffectScale(eff, GetRandomReal(2, 3))
end