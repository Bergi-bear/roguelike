---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 17.02.2021 16:07
---

do
    local InitGlobalsOrigin = InitGlobals
    function InitGlobals()
        InitGlobalsOrigin()
        TimerStart(CreateTimer(), 2, false, function()
            ReplaceALLUnitId2PointExit(FourCC("hdhw"))
            InitHealPoint()
            InitMagazine()
            InitFireBallPoint() --это не экшен поинт
            CreateEActions()
            CreateActionsG()
            InitFinObjectInArea()
            CreateABSQuest()
            AllActionsEnabled(true)
            PauseTimer(GetExpiredTimer())
            DestroyTimer(GetExpiredTimer())
        end)
    end
    InfoSlots = 0
end

ActionList = {}
ActionListIndex = 1
PreViewIcon = { -- Таблица случайных иконок которые могу быть дарами, установлены у входа
    --"HeroArchMage",
    --"HeroBloodElfPrince",
    "HeroMountainKing",
    --"HeroPaladin",
    "HeroBlademaster",
    "HeroTaurenChieftain",
    "ShadowHunter",
    "Trall",
    "CodoHeart",
    "GoldReward",
    "ChaosGrom",
    "Life",
    "Alchemist",
    "Cheese",
}

function InitFinObjectInArea()
    CreateEnterPoint(5300, -9000, L("Подняться на борт", "Climb aboard"), "StartSheep", true)--зона корабля
    CreateEnterPoint(2100, -13250, L("Выйти наружу", "Go outside"), "ExitSheep", true)
    CreateEnterPoint(5400, -8300, L("Исследовать лодку", "Explore the boat"), "Board", true)
    CreateEnterPoint(10000, -19250, L("Исследовать лодку", "Explore the boat"), "Board", true)
    CreateEnterPoint(6120, -8724, L("Исследовать лодку", "Explore the boat"), "Board", true)
    CreateEnterPoint(5500, -6900, L("Войти", "Enter"), "BackDor", true) --Вечно закрытые ворота
    CreateEnterPoint(7700, -8000, L("Преисполниться", "Fill up"), "StartBonus", true) --Синий огонь
    CreateEnterPoint(7800, -6600, L("Посмотреть вдаль", "Look into the distance"), "SoFar", true) --на краю берега справа
    CreateEnterPoint(7000, -9200, L("Рыбачить", "Fishing"), "Fish", true) -- внизу на берегу
    CreateEnterPoint(7200, -7600, L("Отдохнуть", "Take a break"), "NoWorking", true) -- возле деревьев
    CreateEnterPoint(18329, -3724, L("Прочитать", "Reading"), "Read1", false) --первый обелиск
    CreateEnterPoint(13400, -9448, L("Открыть", "Open"), "Open1", false)
    CreateEnterPoint(10680, -15902, L("Открыть", "Open"), "Open2", false)
    CreateEnterPoint(19487, -4224, L("Прыгнуть вниз", "Jump into culvert"), "Culvert", false)
    CreateGodTalon(6100, -7547, "WeaponShield")
    CreateGodTalon(6560, -7524, "WeaponPickAxe")
    CreateGodTalon(6560 + 450, -7524, "WeaponBow")

    CreateGodTalon(19762, -20198, "NagaBiom", 3000 * GetActiveCountPlayer())
    --[[
    --Переходы между зонами
    FinObjectInArea(6600, -6300, "Войти через главный вход", "Goto", true, "Trall") --Начать приключение
    FinObjectInArea(14710, -11735, "        Продолжить", "Goto", false)
    FinObjectInArea(15665, -12743, "        Продолжить", "Goto", false)
    FinObjectInArea(18545, -12487, "        Продолжить", "Goto", false)
    FinObjectInArea(12913, -8415, "        Продолжить", "Goto", false)
    FinObjectInArea(13940, -8415, "        Продолжить", "Goto", false)

    FinObjectInArea(15089, -5911, "        Продолжить", "Goto", false)
    FinObjectInArea(16338, -6629, "        Продолжить", "Goto", false)
    FinObjectInArea(18036, -10000, "       Продолжить", "Goto", false)
    FinObjectInArea(18931, -10000, "        Продолжить", "Goto", false)
    FinObjectInArea(19442, -6286, "        Продолжить", "Goto", false)
    FinObjectInArea(20214, -7145, "        Продолжить", "Goto", false)
    ]]
    --FinObjectInArea(0,-0,"   Продолжить","Goto",false)
end

function ReplaceALLUnitId2PointExit(id)
    local _, _, unitTable = FindUnitOfType(id)
    local k = #unitTable
    --print(k)
    local d = GetRandomInt(1, k)-- рандомизатор молота дидала
    local d2 = GetRandomInt(1, k)-- рандомизатор молота дидала
    local m = GetRandomInt(1, k)-- рандомизатор магазина
    local r = GetRandomInt(1, k)-- рандомизатор  рексара1
    local r2 = GetRandomInt(1, k)-- рандомизатор  рексара1
    if m == d then
        m = GetRandomInt(1, k)
        --print("Супер ошибка, вы выиграли в лотерею, расскажите автору об этом случае")
    end
    for i = 1, k do
        local u = unitTable[i]
        local x, y = GetUnitXY(u)
        SetUnitInvulnerable(u, true)
        --UnitAddAbility(u,FourCC("Aloc"))
        --ShowUnit(u,false)
        if i == d or i == d2 then
            CreateEnterPoint(x, y, L("Продолжить", "Continue"), 'Goto', false, "PeonDidal", u)
            -- print("создана 1 награда с пеоном дидалом")
        elseif i == m then
            CreateEnterPoint(x, y, L("Продолжить", "Continue"), 'Goto', false, "Merchant", u)
        elseif i == r then
            CreateEnterPoint(x, y, L("Продолжить", "Continue"), 'Goto', false, "HeroBeastMaster", u)
        elseif i == r2 then
            CreateEnterPoint(x, y, L("Продолжить", "Continue"), 'Goto', false, "HeroBeastMaster", u)
        else
            CreateEnterPoint(x, y, L("Продолжить", "Continue"), 'Goto', false, nil, u)
        end
    end
end

EnterPointTable = {}

function CreateEnterPoint(x, y, message, actionFlag, isActive, reward, tempUnit)
    if not tempUnit then
        --print("юнит не определён, создаём "..actionFlag)
        tempUnit = CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE), FourCC("hdhw"), x, y, 0)
        SetUnitInvulnerable(tempUnit, true)
        --UnitAddAbility(tempUnit,FourCC("Aloc"))
    end
    if not EnterPointTable[GetHandleId(tempUnit)] then
        EnterPointTable[GetHandleId(tempUnit)] = {}
    end
    local dataPoint = EnterPointTable[GetHandleId(tempUnit)]
    if not reward then
        reward = PreViewIcon[GetRandomInt(1, #PreViewIcon)]
        if not reward then
            reward = "GoldReward"
        end
    end

    local preView = nil
    if actionFlag == "Goto" then
        preView = AddSpecialEffect("SystemGeneric\\GodModels\\" .. reward, x, y)
        BlzSetSpecialEffectYaw(preView, math.rad(90))
        BlzSetSpecialEffectScale(preView, 2)
        BlzSetSpecialEffectColor(preView, 255, 255, 255)
        --print(" Лист действий"..ActionListIndex.." награда записана "..reward) -- эта строчка точно верная 100
        --GLOBAL_REWARD=reward
    end
    local effModel = nil
    --print(SubString(actionFlag,0,5))
    if SubString(actionFlag, 0, 5) == "Write" then
        local s = SubString(actionFlag, 5, 6)
        --print("читаемый символ",s)
        effModel = "SystemGeneric\\ABS\\ABS_" .. s
        --preView = AddSpecialEffect(effModel, x, y)
    end

    ActionList[ActionListIndex] = {
        x = x,
        y = y,
        actionFlag = actionFlag,
        reward = reward
    }

    ActionListIndex = ActionListIndex + 1
    local activeNumber = ActionListIndex - 1
    --local range = 200
    --local rect = Rect(x - range, y - range, x + range, y + range)
    --local tooltip, backdrop, text = CreateActionBox(message)

    ActionList[activeNumber].isActive = isActive
    ActionList[activeNumber].self = dataPoint
    --dataPoint.tooltip = tooltip
    dataPoint.UseAction = actionFlag
    dataPoint.isActive = isActive
    dataPoint.CurrentReward = reward
    dataPoint.preView = preView
    dataPoint.Unit = tempUnit
    dataPoint.OriginalModel = "SystemGeneric\\GodModels\\" .. reward
    dataPoint.Model = effModel

    if actionFlag == "Goto" then
        local _, k, tempTable = FindUnitOfType(FourCC("hdhw"), 1500, x, y)
        if k >= 2 then
            for i = 1, k do
                local dataPoint2 = EnterPointTable[GetHandleId(tempTable[i])]
                if dataPoint2 then
                    if dataPoint2.CurrentReward == reward and tempTable[i] ~= tempUnit then
                        local temTableReward = PreViewIcon
                        if temTableReward and reward ~= "Merchant" then
                            --table.insert(temTableReward,"Merchant")
                            if GetLocalPlayer() == Player(0) then
                                --print("есть дубликат у",reward,#temTableReward)
                            end
                            local pos2remove = FinPosInTable(temTableReward, reward)--FIXME иногда бывает ошибка на эту строку
                            if pos2remove > #temTableReward then
                                print("Error", #temTableReward, pos2remove)
                            else
                                table.remove(temTableReward, pos2remove)
                            end

                        end
                        local newReward = temTableReward[GetRandomInt(1, #temTableReward)]
                        DestroyEffect(dataPoint.preView)
                        dataPoint.CurrentReward = newReward

                        if not newReward then
                            newReward = temTableReward[GetRandomInt(1, #temTableReward)]
                            --print("Ошибка при удалени дубликата дара, пробуем ещё раз"..newReward)
                            if not newReward then
                                --print("полный провал, перезапускайте игру")
                                newReward = 'Merchant'
                                AddSpecialEffect("SystemGeneric\\LightPillar", x, y)
                            end
                        end
                        preView = AddSpecialEffect("SystemGeneric\\GodModels\\" .. newReward, x, y)
                        BlzSetSpecialEffectYaw(preView, math.rad(90))
                        BlzSetSpecialEffectScale(preView, 2)
                        dataPoint.preView = preView
                        dataPoint.OriginalModel = "SystemGeneric\\GodModels\\" .. newReward

                        --print("Найден дубликат дара "..reward.."заменяем его на "..newReward)
                        --AddSpecialEffect("SystemGeneric\\LightPillar", x, y)
                    end
                end
            end
        end
    end
    return tempUnit
end
function FinPosInTable(t, f)
    local pos = 0
    for i = 1, #t do
        if t[i] == f then
            pos = i
            return pos
        end
    end
    --print(pos)
    return pos
end

function AllActionsEnabled(enable)
    for i = 1, #ActionList do
        if ActionList[i].actionFlag == "Goto" or ActionList[i].actionFlag == "Read1" or ActionList[i].actionFlag == "Open1" or ActionList[i].actionFlag == "Open2" or ActionList[i].actionFlag == "Culvert" then
            local dataPoint = ActionList[i].self
            dataPoint.isActive = enable
            ActionList[i].isActive = enable
            --local table=dataPoint.TripleTalon
            local x, y = BlzGetLocalSpecialEffectX(dataPoint.preView), BlzGetLocalSpecialEffectY(dataPoint.preView)
            if not enable then
                TimerStart(CreateTimer(), 3, false, function()
                    DestroyEffect(dataPoint.preView)
                    BlzSetSpecialEffectPosition(dataPoint.preView, OutPoint, OutPoint, 0)
                    dataPoint.preView = AddSpecialEffect("SystemGeneric\\GodModels\\Cancel", x, y)
                    BlzSetSpecialEffectYaw(dataPoint.preView, math.rad(90))
                    BlzSetSpecialEffectScale(dataPoint.preView, 2)
                    BlzSetSpecialEffectColor(dataPoint.preView, 255, 255, 255)
                    DestroyTimer(GetExpiredTimer())
                end)
                -- print("выходы заблокированы "..i)
            else
                --print("выходы разблокированы "..i)
                DestroyEffect(dataPoint.preView)
                BlzSetSpecialEffectPosition(dataPoint.preView, OutPoint, OutPoint, 0)
                dataPoint.preView = AddSpecialEffect(dataPoint.OriginalModel, x, y)
                BlzSetSpecialEffectYaw(dataPoint.preView, math.rad(90))
                BlzSetSpecialEffectScale(dataPoint.preView, 2)
                BlzSetSpecialEffectColor(dataPoint.preView, 255, 255, 255)
            end
        end
    end
end

function CreateActionBox(message, key)
    --функция отключена
    if not key then
        key = "SystemGeneric\\HadesE"
    end

    local tooltip = BlzCreateFrameByType("FRAME", "TestDialog", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), "StandardFrameTemplate", 0)
    local backdrop = BlzCreateFrame("QuestButtonDisabledBackdropTemplate", tooltip, 0, 0)
    local text = BlzCreateFrameByType("TEXT", "ButtonChargesText", tooltip, "", 0)
    local size = #message * 0.006
    if size <= 0.1 then
        size = 0.1
    end
    BlzFrameSetAbsPoint(tooltip, FRAMEPOINT_CENTER, 0.4, 0.08)
    BlzFrameSetSize(tooltip, 0.2, 0.04)
    BlzFrameSetSize(backdrop, size, 0.04)
    BlzFrameSetPoint(backdrop, FRAMEPOINT_CENTER, tooltip, FRAMEPOINT_CENTER, 0.0, 0.0)
    BlzFrameSetAlpha(backdrop, 200)
    BlzFrameSetText(text, message)
    BlzFrameSetScale(text, 1.2)
    BlzFrameSetPoint(text, FRAMEPOINT_CENTER, backdrop, FRAMEPOINT_CENTER, 0, 0.0)
    BlzFrameSetVisible(tooltip, false)
    local hotkey = BlzCreateFrameByType('BACKDROP', 'FaceButtonIcon', tooltip, '', 0)
    BlzFrameSetTexture(hotkey, key, 0, true)
    BlzFrameSetSize(hotkey, NextPoint, NextPoint)
    BlzFrameSetPoint(hotkey, FRAMEPOINT_LEFT, backdrop, FRAMEPOINT_LEFT, -NextPoint, 0.0)
    return tooltip, backdrop, text, hotkey
end

function CreateEActions()
    -----------------------------------------------------------------OSKEY_E
    local gg_trg_EventUpE = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(gg_trg_EventUpE, Player(i), OSKEY_E, 0, true)
    end
    TriggerAddAction(gg_trg_EventUpE, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]

        if not data.ReleaseE and UnitAlive(data.UnitHero) and not data.ECD then
            data.ReleaseE = true
            data.ECD = true
            local dataPoint = EnterPointTable[GetHandleId(data.EPointUnit)]
            --TimerStart(CreateTimer(), 1, false, function() --Всё событие Е имеет задержку 1 секунда
            data.ECD = false
            --print("e is pressed")
            --ТУТ ПЕРЕЧИСЛЯЕМ ДЕЙСТВИЯ ЧЕРЕЗ ИФ
            if data.UseAction == "StartSheep" then
                local message = L("Кто-то убрал трап, я не могу подняться сейчас на борт", "Someone removed the ladder, I can't get on board now")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                if false then
                    local x, y = 1750, -12500 --2100,-13250 На выход
                    SetUnitPositionSmooth(data.UnitHero, x, y)
                end
            end

            if data.UseAction == "ExitSheep" then
                local message = L("На свежий воздух", "Get some fresh air")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                if true then
                    local x, y = 5300, -9000 --2100,-13250 На выход
                    SetUnitPositionSmooth(data.UnitHero, x, y)
                end
            end

            if data.UseAction == "Board" then
                if dataPoint.RewardBordGold then
                    local rm = {
                        L("Здесь ничего нет", "There's nothing here"),
                        L("Тут пусто", ""),
                        L("Пустышка", ""),
                        L("Разграблено", ""),
                        L("Всё уже украдено до нас", ""),
                        L("Ничего", ""),
                        L("Пусто", ""),
                        L("Я уже здесь смотрел", ""),
                        L("Тут кто-то побывал", ""),
                        L("Если я поищу ещё раз, то тут ничего не появится", ""),
                        L("Нельзя сотворить здесь", ""),
                        L("И что я хотел тут найти?", ""),
                        L("Мммм?", ""),
                    }

                    CreateInfoBoxForAllPlayerTimed(data, rm[GetRandomInt(1, #rm)], 3)
                    data.Completed = true
                    data.DoAction = false
                    data.UseAction = ""
                else
                    local rm = {
                        L("Звонкая монета", "Ringing Coin"),
                        L("Чеканная монета", "Minted coin"),
                        L("Деньги - смысл жизни", "Money is the meaning of life"),
                        L("Мои карманы переполнены", "My pockets are full"),
                        L("А почему так мало?", "Why so little?"),
                        L("Где я всё это хранить буду?", "Where will I keep all this?"),
                        L("Нужно больше золота", "Need more gold"),
                        L("Я как бы больше по древесине", "I'm kind of more into wood"),
                        L("Этот мелкий гоблин забирает забирает всё награбленное", "This little goblin takes takes all the loot"),
                        L("У кого деньги тот и прав", "Who the money is right"),
                        L("Куплю себе новый корабль", "Buy a new ship"),
                        L("А какой нынче курс валют?", "And what exchange rate?"),
                        L("Я люблю деньги", "I love money"),
                        L("Ведьмаку заплатите...", "Pay the Witcher.."),
                        L("Куплю поесть...", "Buy food.."),
                        L("Куплю себе азбуку и научусь читать", "Buy myself an ABC and learn to read"),
                        L("Деньги, деньги, деньги, деньги", "Money, money, money, money"),
                    }

                    CreateInfoBoxForAllPlayerTimed(data, rm[GetRandomInt(1, #rm)], 3)
                    UnitAddGold(data.UnitHero, GetRandomInt(1, 50))
                    DestroyEffect(AddSpecialEffect("SystemGeneric\\PileofGold.mdl", GetUnitXY(data.EPointUnit)))
                    dataPoint.RewardBordGold = true
                end

            end
            if data.UseAction == "BackDor" then
                local message = L("Даже не похоже, что эту дверь можно открыть снаружи", "It doesnt even look like this door can be opened from the outside")
                CreateInfoBoxForAllPlayerTimed(data, message, 4)
                data.DoAction = false
                data.UseAction = ""
            end
            -----------------------------------------------------
            -----------------------------------------------------
            -----------------------------------------------------
            if data.UseAction == "Goto" and ChkAllPlayerTalonClosedWindow() then
                if not InFight then
                    --local dataPoint = EnterPointTable[GetHandleId(data.EPointUnit)]
                    local rm = {
                        L("Что нас ждёт внутри?", "What awaits us inside?"),
                        L("Надеюсь, что будет полегче", "I hope it will be easier"),
                        L("Откройся, Сезам", "Open up, Sesame"),
                        L("А что же там?", "And what is there?"),
                        L("Надеюсь, там не заставят работать", "I hope they won't make you work there"),
                        L("Это лучшая работа в мире", "This is the best job in the world"),
                        L("Эти проклятые скелеты", "Those damned skeletons"),
                        L("И знать не хочу что там", "I don't want to know what's in there"),
                        L("Вот здесь я и умру", "This is where I'll die"),
                        L("В глазах темнеет", "It's getting dark in my eyes"),
                        L("Не время умирать здесь", "No time to die here"),
                        L("Опять работать", "Work again"),
                        L("Что там за дверью, сладости?", "What's behind the door, sweets?"),
                        L("Идём дальше", "Moving on"),
                        L("Уходим", "We're leaving"),
                        L("Надо сюда", "We need to get here"),
                        L("Скольких я унесу на тот свет, прежде чем я туда пойду", "")

                        --L("","")

                    }
                    --print(dataPoint.CurrentReward)
                    --GLOBAL_REWARD = data.CurrentReward
                    ----------Случайные фразы конкретных зон
                    --[[
                    "HeroBlademaster",
                    "HeroTaurenChieftain",
                    "ShadowHunter",
                    "Trall",
                    "CodoHeart",
                    "GoldReward",
                    "ChaosGrom",
                    "Life",
                    "Alchemist"]]
                    if GetRandomInt(1, 2) == 1 then
                        if dataPoint.CurrentReward == "CodoHeart" then
                            rm = {
                                L("И чьё это сердце?", "And whose heart is it?"),
                                L("О дополнительное здоровье!", "Oh, extra health!"),
                                L("Это придаст мне сил", "It will give me strength"),
                                L("Сердце кодоя", "The heart of Kodoi"),
                                L("Моя любовь? Хельга?", "My love? Helga? "),
                            }
                        end
                        if dataPoint.CurrentReward == "Life" then
                            rm = {
                                L("Крест возрождения", "The Cross of Rebirth"),
                                L("Это позволит мне возродиться", "This will allow me to be reborn"),
                                L("Всегда полезно", "Always helpful"),
                                L("Да я и так бессмертный", "I'm already immortal"),
                                L("Лишний раз можно будет умереть", "Once again, you can die"),
                            }
                        end
                        if dataPoint.CurrentReward == "HeroBlademaster" then
                            rm = {
                                L("Мастер клинка", "Master of Blade"),
                                L("Самуро?", "Samuro?"),
                                L("Самурай-мечник", "Samurai Swordsman"),
                                L("Да я и так бессмертный", "I'm already immortal"),
                                L("Джаггернаут", "Juggernaut"),
                            }
                        end
                        if dataPoint.CurrentReward == "HeroTaurenChieftain" then
                            rm = {
                                L("Бык?", "A bull?"),
                                L("Пойду к быку", "I'll go to the bull"),
                                L("Могучий бык", "Mighty Bull"),
                                L("Корова в поле", "Cow in the field"),
                                L("Бык тупогуб", "Bull blunt-mouthed"),
                            }
                        end
                        if dataPoint.CurrentReward == "ShadowHunter" then
                            rm = {
                                L("Теневой шаман", "Shadow Shaman"),
                                L("Говорящий с духами", "The Spirit Speaker"),
                                L("Хиллер", "Hiller"),
                                L("Иду мстить", "I'm going for revenge"),
                                L("Моё уважение за этот путь", "My respect for this path"),
                            }
                        end

                    end
                    ------------
                    if dataPoint.CurrentReward == "Merchant" then
                        -- print("Переход к торговцу")
                        Enter2NewZone("Merchant")
                    else
                        Enter2NewZone()
                    end
                    if data.ColdAfterWork then
                        UnitAddGold(data.UnitHero, data.ColdAfterWork)
                    end
                    local r = GetRandomInt(1, #rm)
                    local message = rm[r]
                    CreateInfoBoxForAllPlayerTimed(data, message, 3)
                    if not FirstGoto then
                        FirstGoto = true
                        TimerStart(CreateTimer(), 2, false, function()
                            --SetDayNightModels("DNCLordaeron","DNCLordaeron")
                            -- SetDayNightModels("dncdalaranterrain","dncdalaranterrain")
                            SetTimeOfDay(2)
                            SetTimeOfDayScalePercentBJ(0)
                            SetDayNightModels("", "")
                            PauseTimer(GetExpiredTimer())
                            DestroyTimer(GetExpiredTimer())
                        end)
                    else
                        DestroyDecorInArea(data, 400)
                    end
                    --print("звук открытия ворот")
                    normal_sound("Sound\\Interface\\BattlenetBirth1", GetUnitXY(data.UnitHero))
                    data.Completed = true
                    data.DoAction = false
                    data.UseAction = ""
                    KillUnit(data.EPointUnit)
                    DestroyGotoPoint(dataPoint)
                    --local dataPoint=EnterPointTable[GetHandleId(data.EPointUnit)]
                    --print("переходим в зону с этой наградой "..dataPoint.CurrentReward)
                    GLOBAL_REWARD = dataPoint.CurrentReward
                    AllActionsEnabled(false)-- блокируем все новые переходы
                else
                    print("Сначала победите всех врагов")
                    AllActionsEnabled(false)
                end
            end

            if data.UseAction == "StartBonus" then
                --local message1 = L("Я в своём познании настолько преисполнился, что как будто бы уже 100", "I'm so full of my knowledge that it's like I'm already 100")
                --local message2 = L("триллионов миллиардов лет проживаю на триллионах и триллионах таких же планет", "I've lived on trillions and trillions of similar planets for trillions and trillions of years")
                CreateInfoBoxForAllPlayerTimed(data, L("Преисполняюсь", "Full of my knowledge"), 3)
                --CreateInfoBoxForAllPlayerTimed(data, message1, 7)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                local x, y = GetUnitXY(data.EPointUnit)
                KillUnit(data.EPointUnit)
                TimerStart(CreateTimer(), 7, false, function()
                    CreateGodTalon(x, y, "PeonDidal")
                    PauseTimer(GetExpiredTimer())
                    DestroyTimer(GetExpiredTimer())
                end)
            end
            if data.UseAction == "SoFar" then
                local message = L("Ничего не видно без оптического прибора", "Ничего не видно без оптического прибора")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""

            end
            if data.UseAction == "Fish" then
                local message = L("Руками, без удочки, сам-то попробуй", "With your hands, without a fishing rod, try it yourself")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""

            end
            if data.UseAction == "NoWorking" then
                local rm = {
                    L("Я здесь не для отдыха", "I'm not here to rest"),
                    L("Кусты - не мой фетиш", "Bushes are not my fetish"),
                    L("А колу там не прячут?", "And they don't hide the coke there?"),
                    L("Куст каждому пеону зелёный", "The bush is green for every Peon"),
                    L("Это не дерево!", "It's not a tree!"),
                    L("Я ещё не устал для такого отдыха", "I'm not tired yet for this vacation"),
                    L("Золота там не замечу", "I won't see any gold there"),
                    L("Он пустой!", "It's empty!"),
                    L("Выглядит как неплохая маскировка", "It looks like a good disguise"),
                    L("Колется!", "Ouch, it really stings"),
                }
                CreateInfoBoxForAllPlayerTimed(data, rm[GetRandomInt(1, #rm)], 3)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Read1" then
                local message = L("Не могу понять, что тут написано", "?????")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Open1" then
                local message = L("Победите всех врагов", "Defeat all enemies")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                StartEnemyWave(44)-- волна с жуками
                KillUnit(data.EPointUnit)
            end
            if data.UseAction == "Open2" then
                local message = L("Победите всех врагов", "Defeat all enemies")
                CreateInfoBoxForAllPlayerTimed(data, message, 5)
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                StartEnemyWave(45)-- волна с огоньками
                KillUnit(data.EPointUnit)
            end
            if data.UseAction == "Culvert" then
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                --print("переход в канализацию")
                CinematicFadeBJ(bj_CINEFADETYPE_FADEOUT, 1.5, "ReplaceableTextures\\CameraMasks\\Black_mask.blp", 0, 0, 0, 0.00)
                TimerStart(CreateTimer(), 2, false, function()
                    DestroyTimer(GetExpiredTimer())
                    MoveAllHeroAndBound(gg_rct_InCulvert, gg_rct_BoundCulvert)
                    CinematicFadeBJ(bj_CINEFADETYPE_FADEIN, 1.5, "ReplaceableTextures\\CameraMasks\\Black_mask.blp", 0, 0, 0, 0.00)
                end)
                KillUnit(data.EPointUnit)
            end

            if data.UseAction == "RotationFire" then
                --local message = L("Я здесь не для отдыха","I'm not here to rest")
                --CreateInfoBoxForAllPlayerTimed(data, message, 5)
                --data.Completed = true
                --data.DoAction = false
                --data.UseAction = ""
                --SetUnitOwner(dataPoint.UnitFireRotation, GetOwningPlayer(data.UnitHero))
                dataPoint.AngleFireRotation = dataPoint.AngleFireRotation + 90
                local x, y = GetUnitXY(data.UnitHero)
                FlyTextTagShieldXY(x, y, L("Поворачиваем", "Rotate"), GetOwningPlayer(data.UnitHero))
                --print("Поворачиваем")
            end
            if data.UseAction == "WeaponPickAxe" then
                --local message = L("Я здесь не для отдыха","I'm not here to rest")
                --CreateInfoBoxForAllPlayerTimed(data, message, 5)
                SwitchWeaponTo(data, "pickaxe")
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                local x, y = GetUnitXY(data.UnitHero)
                FlyTextTagShieldXY(x, y, L("Кирка", "pickaxe"), GetOwningPlayer(data.UnitHero))
            end
            if data.UseAction == "WeaponShield" then
                --local message = L("Я здесь не для отдыха","I'm not here to rest")
                --CreateInfoBoxForAllPlayerTimed(data, message, 5)
                SwitchWeaponTo(data, "shield")
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                local x, y = GetUnitXY(data.UnitHero)
                FlyTextTagShieldXY(x, y, L("Щит", "Shield"), GetOwningPlayer(data.UnitHero))
            end
            if data.UseAction == "WeaponBow" then
                --local message = L("Я здесь не для отдыха","I'm not here to rest")
                --CreateInfoBoxForAllPlayerTimed(data, message, 5)
                SwitchWeaponTo(data, "bow")
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
                local x, y = GetUnitXY(data.UnitHero)
                FlyTextTagShieldXY(x, y, L("Лук", "Bow"), GetOwningPlayer(data.UnitHero))
            end

            ----------------------------------------------------/
            --------------------Буквы---------------------------/
            ----------------------------------------------------/
            if data.UseAction == "Writex" then
                if Type("X") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writeg" then
                if Type("G") >= 5 then

                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writem" then
                if Type("M") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writee" then
                if Type("E") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writea" then
                if Type("A") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writel" then
                if Type("L") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writey" then
                if Type("Y") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end
            if data.UseAction == "Writeh" then
                if Type("H") >= 5 then
                    local x, y = GetUnitXY(data.UnitHero)
                    CreateCreepDelay(FourCC("uban"), x, y, 2, "summon")
                end
                data.Completed = true
                data.DoAction = false
                data.UseAction = ""
            end

            ----------------------------------------------------/
            ---------------ДАРЫ БОГОВ---------------------------/
            ----------------------------------------------------/
            if ChkAllPlayerTalonClosedWindow() then
                if data.UseAction == "Trall" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = L("Провидец, я выбираю тебя", "Seer, I choose you")
                        CreateInfoBoxForAllPlayerTimed(data, message, 3)
                        data.Completed = true
                        AllActionsEnabled(true)--активация всех переходов
                        CreateDialogTalon("Trall") -- Сюда передаётся trall
                        normal_sound("Units\\Orc\\HeroFarseer\\HeroFarseerWhat" .. GetRandomInt(1, 4), GetUnitXY(data.UnitHero))
                        DestroyGodTalon(dataPoint.TripleTalon)
                        data.DoAction = false
                        data.UseAction = ""
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                    --GetTerrainZ()
                end
                if data.UseAction == "HeroBlademaster" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = L("Надели меня силой своего клинка", "Give me the power of your blade")
                        CreateInfoBoxForAllPlayerTimed(data, message, 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("HeroBlademaster")
                        normal_sound("Units\\Orc\\HeroBladeMaster\\HeroBladeMasterPissed" .. GetRandomInt(1, 4), GetUnitXY(data.UnitHero))

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end
                if data.UseAction == "HeroTaurenChieftain" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = L("Держите оборону", "Hold the line")
                        CreateInfoBoxForAllPlayerTimed(data, message, 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("HeroTaurenChieftain")
                        normal_sound("Units\\Orc\\HeroTaurenChieftain\\HeroTaurenChieftainPissed" .. GetRandomInt(1, 6), GetUnitXY(data.UnitHero))

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end
                if data.UseAction == "ShadowHunter" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = {
                            L("Я отомщу за тебя", "I will avenge you"),
                            L("Да кто такой ваш этот Зул'Джин?", "Who is this Itch of yours, Zul'jin?"),
                            L("Полечишь?", "Would you healing me?"),
                            L("Я тебя помню", "I remember you"),
                            L("Странный у тебя акцент", "You have a strange accent"),
                            L("Ты меня не тролль", "You don't troll me"),
                        }
                        CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("ShadowHunter")
                        normal_sound("Units\\Orc\\HeroShadowHunter\\ShadowHunterPissed" .. GetRandomInt(1, 9), GetUnitXY(data.UnitHero))

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end
                if data.UseAction == "ChaosGrom" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = {
                            L("Проклятый", "Cursed"),
                            L("Рррааыа", ""),
                            L("Главное не покраснеть", ""),
                            L("У этого парня всё толковое", ""),
                            L("Как гром среди ясного неба", ""),
                            L("Сожру любого", ""),
                        }
                        CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("ChaosGrom")
                        --normal_sound("Units\\Orc\\HeroShadowHunter\\ShadowHunterPissed"..GetRandomInt(1,9),GetUnitXY(data.UnitHero))
                        --активация всех переходов

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end

                if data.UseAction == "Alchemist" then
                    --TODO перевод
                    if data.gold >= dataPoint.TalonPrice then
                        local message = {
                            L("Я вижу ты тут главный", ""),
                            L("Изучаю алхимию", ""),
                            L("Готов превращать всё в золото", ""),
                            L("Как бы самом не превратится в золото", ""),
                            L("И ещё больше золота", ""),
                            L("Теперь точно разбогатею", ""),
                        }
                        CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("Alchemist")
                        --normal_sound("Units\\Orc\\HeroShadowHunter\\ShadowHunterPissed"..GetRandomInt(1,9),GetUnitXY(data.UnitHero))
                        --активация всех переходов

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end

                if data.UseAction == "HeroBeastMaster" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = "Хочу повелевать твоими зверями"
                        CreateInfoBoxForAllPlayerTimed(data, message, 3)
                        data.Completed = true
                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("HeroBeastMaster")
                        AllActionsEnabled(true)
                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                    --normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1",GetUnitXY(data.UnitHero))
                end
                if data.UseAction == "PeonDidal" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = L("Сила братьев", "Power of Brothers")
                        CreateInfoBoxForAllPlayerTimed(data, message, 3)
                        data.Completed = true
                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("PeonDidal")
                        AllActionsEnabled(true)
                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                    --normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1",GetUnitXY(data.UnitHero))
                end

                if data.UseAction == "Cheese" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = {
                            L("Я вижу ты тут главный", ""),
                            L("Изучаю алхимию", ""),
                            L("Готов превращать всё в золото", ""),
                            L("Как бы самом не превратится в золото", ""),
                            L("И ещё больше золота", ""),
                            L("Теперь точно разбогатею", ""),
                        }
                        --CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        --print("Активация сыра")
                        CreateDialogTalon("Cheese")

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end

                if data.UseAction == "HeroMountainKing" then
                    if data.gold >= dataPoint.TalonPrice then
                        local message = {
                            L("Сила молотов", ""),
                            L("Изучаю кузнечное дело", ""),

                        }
                        CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                        data.Completed = true
                        AllActionsEnabled(true)

                        DestroyGodTalon(dataPoint.TripleTalon)
                        CreateDialogTalon("HeroMountainKing")

                        data.DoAction = false
                        data.UseAction = ""
                        data.ShowActionWindows = false
                        KillUnit(data.EPointUnit)
                        if dataPoint.TalonPrice > 0 then
                            normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                            AddGold(data, -dataPoint.TalonPrice)
                        end
                    else
                        normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                    end
                end

            end
            ----------------------------------------------------/
            ---------------Прочие дары--------------------------/
            ----------------------------------------------------/
            if data.UseAction == "NagaBiom" then
                if data.gold >= dataPoint.TalonPrice then
                    --print("полный выкуп уплочен")
                    --data.Completed = true

                    DestroyGodTalon(dataPoint.TripleTalon)

                    local x, y = GetUnitXY(dataPoint.Unit)
                    CreateEnterPoint(x, y, L("Продолжить", "Continue"), 'Goto', false, "PeonDidal")
                    AllActionsEnabled(true)--активация всех переходов

                    data.DoAction = false
                    data.UseAction = ""
                    data.ShowActionWindows = false
                    KillUnit(data.EPointUnit)
                    if dataPoint.TalonPrice > 0 then
                        normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                        AddGold(data, -dataPoint.TalonPrice)
                    end
                else
                    data.DoAction = false
                    data.UseAction = ""
                    data.ShowActionWindows = false
                    dataPoint.TalonPrice = dataPoint.TalonPrice - data.gold
                    --print("отдано", "осталось", dataPoint.TalonPrice)
                    if not infLimit then
                        infLimit = 1
                    end
                    infLimit = infLimit + 1
                    for i = 1, infLimit do
                        CreateCreepDelay(FourCC("n005"), 0, 0, 1, "summon")
                    end
                    SetTextTagText(dataPoint.priceTag, R2I(dataPoint.TalonPrice), 0.03)
                    normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                    AddGold(data, -data.gold)
                end
            end
            if data.UseAction == "CodoHeart" then
                if data.gold >= dataPoint.TalonPrice then
                    local message = {
                        L("Сила кодоя", "Cursed"),
                        L("Я стал мощнее", ""),
                        L("Я стал крепче", ""),
                        L("Чувствую мощь", ""),
                        L("Меня переполняет смысол", ""),
                        L("Насыщаюсь здоровьем", ""),
                    }
                    CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                    data.Completed = true

                    DestroyGodTalon(dataPoint.TripleTalon)
                    AllActionsEnabled(true)--активация всех переходов

                    data.DoAction = false
                    data.UseAction = ""
                    data.ShowActionWindows = false
                    KillUnit(data.EPointUnit)
                    GiveForAll("CodoHeart") -- Дайём всем награду
                    if dataPoint.TalonPrice > 0 then
                        normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                        AddGold(data, -dataPoint.TalonPrice)
                    end
                else
                    normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                end
            end
            if data.UseAction == "GoldReward" then
                local rm = {
                    L("Звонкая монета", "Ringing Coin"),
                    L("Чеканная монета", "Minted coin"),
                    L("Деньги - смысл жизни", "Money is the meaning of life"),
                    L("Мои карманы переполнены", "My pockets are full"),
                    L("А почему так мало?", "Why so little?"),
                    L("Где я всё это хранить буду?", "Where will I keep all this?"),
                    L("Нужно больше золота", "Need more gold"),
                    L("Я как бы больше по древесине", "I'm kind of more into wood"),
                    L("Этот мелкий гоблин забирает забирает всё награбленное", "This little goblin takes takes all the loot"),
                    L("У кого деньги тот и прав", "Who the money is right"),
                    L("Куплю себе новый корабль", "Buy a new ship"),
                    L("А какой нынче курс валют?", "And what exchange rate?"),
                    L("Я люблю деньги", "I love money"),
                    L("Ведьмаку заплатите...", "Pay the Witcher.."),
                    L("Куплю поесть...", "Buy food.."),
                    L("Куплю себе азбуку и научусь читать", "Buy myself an ABC and learn to read"),
                    L("Деньги, деньги, деньги, деньги", "Money, money, money, money"),
                }
                CreateInfoBoxForAllPlayerTimed(data, rm[GetRandomInt(1, #rm)], 3)
                data.Completed = true
                DestroyGodTalon(dataPoint.TripleTalon)
                AllActionsEnabled(true)

                --активация всех переходов
                GiveForAll("GoldReward")

                data.DoAction = false
                data.UseAction = ""
                data.ShowActionWindows = false
                KillUnit(data.EPointUnit)
                normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
            end
            if data.UseAction == "Life" then
                if data.gold >= dataPoint.TalonPrice then
                    local message = {
                        L("Запасная жизнь", "Spare life"),
                        L("Перерождение", "Rebirth"),
                        L("Умирать - не работать", "Die-don't work"),
                        L("Время жить", "Time to live"),
                        L("И какой ценой я это получил?", "And at what price did I get it?"),
                        L("Вкус к жизни уже не вернуть", "The taste of life can not be returned"),
                        L("В хозяйстве всегда пригодится", "The farm is always useful"),
                        L("Пригодится ли это вне храма?", "Will it be useful outside the temple?"),
                        L("Предохраняться не помешает", "It doesn't hurt to protect yourself"),
                        L("И почему я каждый раз воскресаю?", "И почему я каждый раз воскресаю?"),
                    }
                    CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                    data.Completed = true
                    DestroyGodTalon(dataPoint.TripleTalon)
                    AllActionsEnabled(true)
                    AddLife(data)

                    data.DoAction = false
                    data.UseAction = ""
                    data.ShowActionWindows = false
                    KillUnit(data.EPointUnit)
                    if dataPoint.TalonPrice > 0 then
                        normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                        AddGold(data, -dataPoint.TalonPrice)
                    end
                    normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1", GetUnitXY(data.UnitHero))
                else
                    normal_sound("Sound\\Interface\\Error", GetUnitXY(data.UnitHero))
                end
            end

            if data.UseAction == "Heal" then
                if not dataPoint.CD2Ready then
                    dataPoint.CD2Ready = 0
                end
                if dataPoint.CD2Ready <= 0 then
                    ------Кдшим фонтан
                    --print("запускаем кд фонтана")
                    dataPoint.CD2Ready = 20
                    if not InFight then
                        dataPoint.CD2Ready = 2
                    end
                    local bar = AddSpecialEffect("SystemGeneric\\Progressbar", GetUnitXY(hero))
                    BlzSetSpecialEffectColor(bar, 255, 255, 255)
                    BlzPlaySpecialEffect(bar, ANIM_TYPE_BIRTH)
                    BlzSetSpecialEffectTimeScale(bar, 1 / dataPoint.CD2Ready)
                    BlzSetSpecialEffectScale(bar, 2)
                    --BlzSetSpecialEffectAlpha(bar, 0)
                    BlzSetSpecialEffectColorByPlayer(bar, Player(9))
                    local x, y = GetUnitXY(dataPoint.Unit)
                    local z = BlzGetUnitZ(dataPoint.Unit) + 220
                    BlzSetSpecialEffectPosition(bar, x, y - 60, z)

                    TimerStart(CreateTimer(), 1, true, function()

                        dataPoint.CD2Ready = dataPoint.CD2Ready - 1
                        if dataPoint.CD2Ready <= 0 then
                            --print("фонтан готов")
                            BlzSetSpecialEffectPosition(bar, OutPoint, OutPoint, z)
                            DestroyEffect(bar)
                            DestroyTimer(GetExpiredTimer())
                        end
                    end)

                    -------------
                    local message = {
                        L("Целебно", "Curative"),
                        L("Я полон сил", "I'm full of energy"),
                        L("Холодная", "Cold"),
                        L("Как заново родился", "How was I born again"),
                        L("Готов к битве", "Ready for battle"),
                        L("Кажется я уже переполнен", "I think I'm already full"),
                        L("На вкус как кола", "It tastes like cola"),
                        L("Сладкий Бубалех", "Sweet Bubaleh"),

                    }
                    CreateInfoBoxForAllPlayerTimed(data, message[GetRandomInt(1, #message)], 3)
                    if UnitHasAnyEnemyInRange(data.UnitHero, 500) then
                        HealUnit(data.UnitHero, 50)
                        normal_sound("Abilities\\Spells\\NightElf\\Tranquility\\TranquilityHealLoop1", GetUnitXY(data.UnitHero))
                    else
                        HealUnit(data.UnitHero, 9999)
                        normal_sound("Abilities\\Spells\\NightElf\\Tranquility\\TranquilityTarget1", GetUnitXY(data.UnitHero))
                    end
                    data.Completed = true
                    data.DoAction = false
                    data.UseAction = ""
                    data.ShowActionWindows = false
                    if data.DeathFountain then
                        --print("заражаем фонтан")
                        local x, y = GetUnitXY(data.EPointUnit)
                        KillUnit(data.EPointUnit)
                        CreateBloodFountain(data, x, y)
                    end
                else
                    -- print("Фонтан ещё не готов")
                end
            end
            if data.UseAction == "Buying" then
                local message = L("Не спеши, выбирай с умом", "Take your time, choose wisely")
                CreateInfoBoxForAllPlayerTimed(data, message, 3)
                data.Completed = true
                --DestroyGodTalon(dataPoint.TripleTalon)
                --CreateDialogTalon("Merchant")
                --AllActionsEnabled(true)
                data.DoAction = false
                data.UseAction = ""
                dataPoint.isActive = false
                TimerStart(CreateTimer(), 1.6, false, function()
                    CreateMerchantAndGoods(GetUnitX(dataPoint.Unit), GetUnitY(dataPoint.Unit), 3)
                    DestroyTimer(GetExpiredTimer())
                end)
                --Торговец не умирает
                --KillUnit(data.EPointUnit)
                --normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1",GetUnitXY(data.UnitHero))
            end
            if data.UseAction == "Merchant" then
                local message = L("Не спеши, выбирай с умом", "Take your time, choose wisely")
                CreateInfoBoxForAllPlayerTimed(data, message, 3)
                data.Completed = true
                DestroyGodTalon(dataPoint.TripleTalon)
                --CreateDialogTalon("Merchant")
                --AllActionsEnabled(true)
                data.DoAction = false
                data.UseAction = ""
                dataPoint.isActive = false
                TimerStart(CreateTimer(), 1.6, false, function()
                    CreateMerchantAndGoods(GetUnitXY(dataPoint.Unit))
                    DestroyTimer(GetExpiredTimer())
                end)
                KillUnit(data.EPointUnit)
                --normal_sound("Abilities\\Spells\\Other\\Transmute\\AlchemistTransmuteDeath1",GetUnitXY(data.UnitHero))
            end

            -- end) --конец задержки


        end
    end)
    local TrigDepressE = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        BlzTriggerRegisterPlayerKeyEvent(TrigDepressE, Player(i), OSKEY_E, 0, false)
    end
    TriggerAddAction(TrigDepressE, function()
        local pid = GetPlayerId(GetTriggerPlayer())
        local data = HERO[pid]
        data.ReleaseE = false
    end)
end

function CreateInfoBoxForAllPlayerTimed(data, message, timed)
    if not bj_isSinglePlayer then
        --print(message)
        if not data.TagDelay then
            FlyTextTagHealXY(GetUnitX(data.UnitHero), GetUnitY(data.UnitHero), message, GetOwningPlayer(data.UnitHero))
            data.TagDelay = true
            TimerStart(CreateTimer(), 1, false, function()
                DestroyTimer(GetExpiredTimer())
                data.TagDelay = false
            end)
        end
    else
        --local tooltip = BlzCreateFrameByType("FRAME", "TestDialog", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), "StandardFrameTemplate", 0)
        --local backdrop = BlzCreateFrame("QuestButtonDisabledBackdropTemplate", tooltip, 0, 0)
        if InfoSlots <= 3 then
            local tooltip = BlzCreateFrameByType("BACKDROP", "TalonTooltip", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), "EscMenuControlBackdropTemplate", 0)
            local text = BlzCreateFrameByType("TEXT", "ButtonChargesText", tooltip, "", 0)
            local size = #message * 0.007
            if size <= 0.12 then
                size = 0.12
            end
            BlzFrameSetAbsPoint(tooltip, FRAMEPOINT_CENTER, 0.4, 0.08 + 0.03 * InfoSlots)
            BlzFrameSetSize(tooltip, size, 0.03)
            BlzFrameSetText(text, message)
            BlzFrameSetScale(text, 1.2)
            BlzFrameSetPoint(text, FRAMEPOINT_CENTER, tooltip, FRAMEPOINT_CENTER, 0, 0.0)
            TimerStart(CreateTimer(), timed, false, function()
                DestroyTimer(GetExpiredTimer())
                BlzDestroyFrame(tooltip)
                InfoSlots = InfoSlots - 1
            end)
            InfoSlots = InfoSlots + 1
        end
    end
end

function DestroyDecorInArea(data, range)
    local x, y = GetUnitXY(data.UnitHero)
    SetRect(GlobalRect, x - range, y - range, x + range, y + range)
    EnumDestructablesInRect(GlobalRect, nil, function()
        if GetDestructableTypeId(GetEnumDestructable()) == FourCC('B000') then
            --каменная дверь для точек выхода
            KillDestructable(GetEnumDestructable())
        end
    end)
end
