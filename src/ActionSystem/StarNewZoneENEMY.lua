---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 18.02.2021 18:37
---
do
    local InitGlobalsOrigin = InitGlobals
    function InitGlobals()
        InitGlobalsOrigin()
        TimerStart(CreateTimer(), 2, false, function()
            EnemyList = {
                FourCC("nsko"), -- скелет
                FourCC("ucs1"), -- мелкий жук
                FourCC("u000"), -- большой жук
                FourCC("uabo"), -- пудж
                FourCC("unec"), -- некромант
                FourCC("n000"), -- мимик
                FourCC("ugar"), -- гаргулья
            }

            GameZone = {
                recEnter = nil,
                rectBound = nil,
                rectSpawn = nil,
                reward = nil
            }
            InitAllZones()

        end)
    end
end

function InitAllZones()
    SetZone(1, gg_rct_E1A, gg_rct_B1A, gg_rct_S1A)
    SetZone(2, gg_rct_E2A, gg_rct_B2A, gg_rct_S2A)
    SetZone(3, gg_rct_E3A, gg_rct_B3A, gg_rct_S3A)
    SetZone(4, gg_rct_E4A, gg_rct_B4A, gg_rct_S4A)
    SetZone(5, gg_rct_E5A, gg_rct_B5A, gg_rct_S5A)
    SetZone(6, gg_rct_E6A, gg_rct_B6A, gg_rct_S6A)
    ---------------------------------------------------
    SetZone(7, gg_rct_E7A, gg_rct_B7A, gg_rct_S7A)
    SetZone(8, gg_rct_E8A, gg_rct_B8A, gg_rct_S8A)
    SetZone(9, gg_rct_E9A, gg_rct_B9A, gg_rct_S9A)
    SetZone(10, gg_rct_E10A, gg_rct_B10A, gg_rct_S10A)
    SetZone(11, gg_rct_E11A, gg_rct_B11A, gg_rct_S11A)
    SetZone(12, gg_rct_E12A, gg_rct_B12A, gg_rct_S12A)
    -------------------------------------------------------
    SetZone(13, gg_rct_E13A, gg_rct_B13A, gg_rct_S13A)
    SetZone(14, gg_rct_E14A, gg_rct_B14A, gg_rct_S14A)
    SetZone(15, gg_rct_E15A, gg_rct_B15A, gg_rct_S15A)
    SetZone(16, gg_rct_E16A, gg_rct_B16A, gg_rct_S16A)
    SetZone(17, gg_rct_E17A, gg_rct_B17A, gg_rct_S17A)
    -------------------------------------------------------
    SetZone(18, gg_rct_E18A, gg_rct_B18A, gg_rct_S18A)
    SetZone(19, gg_rct_E19A, gg_rct_B19A, gg_rct_S19A)
    SetZone(20, gg_rct_E20A, gg_rct_B20A, gg_rct_S20A)
    --Переход в зону наг
    SetZone(21, gg_rct_E21A, gg_rct_B21A, gg_rct_S21A)
    SetZone(22, gg_rct_E22A, gg_rct_B22A, gg_rct_S22A)
    SetZone(23, gg_rct_E23A, gg_rct_B23A, gg_rct_S23A)
    SetZone(24, gg_rct_E24A, gg_rct_B24A, gg_rct_S24A)
    -- 2 зоны в которых выпрыгивают из воды юниты
    SetZone(25, gg_rct_E25A, gg_rct_B25A, gg_rct_S25A)
    SetZone(26, gg_rct_E26A, gg_rct_B26A, gg_rct_S26A)
    SetZone(27, gg_rct_E27A, gg_rct_B27A, gg_rct_S27A)
    SetZone(28, gg_rct_E28A, gg_rct_B28A, gg_rct_S28A)


    --SetZone(4,gg_rct_E4A,gg_rct_B4A,gg_rct_S4A)
    Destiny = GetRandomIntTable(1, 20, 20) -- судьба и распределение порядка игровых зон #GameZone
    --Destiny[21] = 21
    --DestinyEnemies = GetRandomIntTable(1, 20, 20) -- отключено
    for i = 1, #Destiny do
        --print(Destiny[i])
    end

end

function SetZone(number, recEnter, rectBound, rectSpawn)
    if recEnter and rectBound and rectSpawn then
        GameZone[number] = {
            recEnter = recEnter,
            rectBound = rectBound,
            rectSpawn = rectSpawn,
            x = {},
            y = {},
        }
        AddSpawnPoint2TableXY(GameZone[number])
    else
        --print("Ошибка, игровая зона №"..number.." ещё не создана в WE")
    end
end

function AddSpawnPoint2TableXY(data)
    local e = nil
    local k = 1
    local id = FourCC("e001")
    data.x = {}
    data.y = {}
    data.angle = {}
    GroupEnumUnitsInRect(perebor, data.rectSpawn, nil)
    while true do
        e = FirstOfGroup(perebor)
        if e == nil then
            break
        end
        if UnitAlive(e) and GetUnitTypeId(e) == id then
            data.x[k] = GetUnitX(e)
            data.y[k] = GetUnitY(e)
            if GetUnitLifePercent(e) <= 99 then
                --print("есть потерянное хп",GetUnitFacing(e))
                data.angle[k] = GetUnitFacing(e)
            end
            RemoveUnit(e)
            k = k + 1
            --print("наполнение k"..k-1)
        end
        GroupRemoveUnit(perebor, e)
    end
end
CurrentGameZone = 1 -- Стартовая зона -1, 0 для первого биома, 19 для второго биома WhosYourDaddy црщы
function Enter2NewZone(flag)
    CurrentGameZone = CurrentGameZone + 1
    GWinPercent=GWinPercent+3
    if CurrentGameZone == 1 or CurrentGameZone == 20 then
        --print("убираем обучение")
        DestroyAllLearHelpers()
    end
    --print(" вошел в зону .. "..CurrentGameZone.. " для судьбы это зона "..Destiny[CurrentGameZone].. " а награда то какая? наверное ")
    SaveCodeForAllPLayers()
    CinematicFadeBJ(bj_CINEFADETYPE_FADEOUT, 1.5, "ReplaceableTextures\\CameraMasks\\Black_mask.blp", 0, 0, 0, 0.00)
    TimerStart(CreateTimer(), 2, false, function()
        --print("Перемещаемся в игровую зону "..CurrentGameZone)
        if CurrentGameZone ~= 20 then
            if Destiny[CurrentGameZone] then

                --StartEnemyWave(Destiny[CurrentGameZone])
                --print("запускаем волну № ", Destiny[CurrentGameZone])
                if not flag then
                    MoveAllHeroAndBound(GameZone[Destiny[CurrentGameZone]].recEnter, GameZone[Destiny[CurrentGameZone]].rectBound)
                    --StartEnemyWave(DestinyEnemies[CurrentGameZone]) --случайные волны
                    StartEnemyWave(CurrentGameZone) --волны по порядку CurrentGameZone
                    ClearGoodsViaExit()
                    --StartEnemyWave(401) -- Босс обсидиановых статуй
                end
                if flag == "Merchant" then
                    --print("Создаём торговца и предметы для торговли") --TODO
                    CurrentGameZone = CurrentGameZone-1 --с этим надо очень акуратно
                    MoveAllHeroAndBound(gg_rct_MerchantE1, gg_rct_MerchantB1)
                    local x = 12981
                    local y = -6569 --GetRectCenterY(GameZone[Destiny[CurrentGameZone]].rectSpawn)
                    CreateMerchantAndGoods(x, y)
                    --print("Переход в зону с магазином")
                    AllActionsEnabled(true)
                    TimerStart(CreateTimer(), 3, false, function()
                        AllActionsEnabled(true)
                    end)
                end
                --StartEnemyWave(5)
            else
                -- следующей зоны не существует
                TimerStart(CreateTimer(), 3, false, function()
                    TimerStart(CreateTimer(), 3, false, function()
                        local SaveCode = 0
                        for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
                            if PlayerIsPlaying[i] then
                                local gdata = HERO[i]
                                if GetLocalPlayer() == Player(i) then
                                    SaveCode = GetSaveCode(gdata)
                                end
                                print(GetPlayerName(Player(i)) .. " унёс с собой " .. R2I(gdata.gold) .. " золота ")

                                TimerStart(CreateTimer(), 2, false, function()
                                    CustomVictoryBJ(Player(i), true, true)
                                end)
                            end
                        end
                        SaveResult(SaveCode)
                    end)

                end)
                -- print(CurrentGameZone .. " эта зона не существует, перемещение туда невозможно, обратитесь к автору карты")

            end
        else
            MoveAllHeroAndBound(GameZone[Destiny[CurrentGameZone]].recEnter, GameZone[Destiny[CurrentGameZone]].rectBound)
            StartEnemyWave(401)

            --print("в этой зоне должен быть босс")
        end
        CinematicFadeBJ(bj_CINEFADETYPE_FADEIN, 1.5, "ReplaceableTextures\\CameraMasks\\Black_mask.blp", 0, 0, 0, 0.00)
    end)
end

function GetRandomIntTable(min, max, count)
    local keys = {}
    local out = {}
    if min == max then
        return { min }
    end
    if max < min then
        min, max = max, min
    end
    local limit = math.abs(max - min) + 1
    count = count == nil and limit or math.min(limit, count)
    if limit <= count then
        local ints = {}
        for i = min, max do
            table.insert(ints, i)
        end
        for _ = 1, limit do
            table.insert(out, table.remove(ints, math.random(1, #ints)))
        end
        return out
    else
        while #out < count do
            local i = math.random(min, max)
            if keys[i] == nil then
                keys[i] = true
                table.insert(out, i)
            end
        end
        return out
    end
end

function MoveAllHeroAndBound(recEnter, rectBound)
    local x, y = GetRectCenterX(recEnter), GetRectCenterY(recEnter)
    local x2, y2 = GetRectCenterX(rectBound), GetRectCenterY(rectBound)
    EnumDestructablesInRect(recEnter, nil, function()
        if GetDestructableTypeId(GetEnumDestructable()) == FourCC('B000') then
            --каменная дверь для точек выхода
            KillDestructable(GetEnumDestructable())
        end
    end)
    BoundZoneForAllPlayers(rectBound)
    --BoundZoneForAllPlayers(gg_rct_B19B)

    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        if PlayerIsPlaying[i] then
            local data = HERO[i]
            SetUnitPosition(data.UnitHero, x, y)
        end
    end
    ReviveAllHero()
    --CreateGodTalon(x2,y2,"Trall",80,80,255)
end

function BoundZoneForAllPlayers(rectBound)
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        if PlayerIsPlaying[i] then
            SetCameraBoundsToRectForPlayerBJ(Player(i), rectBound)
        end
    end
end

function StartEnemyWave(waveNumber)
    local listID = {}
    local maxOnWave = 1
    if waveNumber == 1 then
        local r = GetRandomInt(1, 6)
        if r == 1 then
            listID = {--скелеты
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
            }
            maxOnWave = 1
        elseif r == 2 then
            listID = {--жуки
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            }
            maxOnWave = 2
        elseif r == 3 then
            listID = {--пуджи
                FourCC("uabo"), FourCC("uabo"), FourCC("uabo"),
            }
            maxOnWave = 1
        elseif r == 4 then
            listID = { -- некроманты
                FourCC("unec"), FourCC("unec"),
                FourCC("unec"), FourCC("unec"),
            }
            maxOnWave = 2
        elseif r == 5 then
            listID = { --мимики
                FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"),
                FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"),
            }
            maxOnWave = 5
        elseif r == 6 then
            listID = { --гули
                FourCC("ugar"), FourCC("ugar"), FourCC("ugar"), FourCC("ugar"),
            }
            maxOnWave = 2
        end

    end

    if waveNumber == 2 then
        local r = GetRandomInt(1, 3)
        if r == 1 then
            listID = {
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("uabo"), FourCC("uabo"), FourCC("uabo"),
            }
            maxOnWave = 1
        elseif r == 2 then
            listID = {
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
            }
            maxOnWave = 2
        elseif r == 3 then
            listID = {
                FourCC("unec"), FourCC("unec"),
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("unec"), FourCC("unec"),
            }
            maxOnWave = 2
        end
    end
    if waveNumber == 3 then
        local r = GetRandomInt(1, 3)
        if r == 1 then
            listID = {
                FourCC("uabo"), FourCC("uabo"), FourCC("uabo"), FourCC("uabo"), FourCC("uabo"),
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("uabo"), FourCC("uabo"), FourCC("nsko"), FourCC("unec"), FourCC("unec"),
            }
            maxOnWave = 3
        elseif r == 2 then
            listID = {
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
                FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"), FourCC("nsko"),
            }
            maxOnWave = 4
        elseif r == 3 then
            listID = {
                FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"),
                FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"),
                FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"),
                FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"), FourCC("n000"),
            }
            maxOnWave = 4
        end
    end

    if waveNumber == 4 then
        local r = GetRandomInt(1, 2)
        if r == 1 then
            listID = {  -- Очень много жуков
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
                FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            }
            maxOnWave = 8
        elseif r == 2 then
            listID = { --Тестоый босс
                FourCC("u001"),
            }
            maxOnWave = 1
        end
    end
    if waveNumber == 44 then
        listID = {  -- Очень много жуков
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
            FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"), FourCC("ucs1"),
        }
        maxOnWave = 20
    end
    if waveNumber == 45 then
        listID = {  -- огоньки
            FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"),
            FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"),
            FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"),
            FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"), FourCC("n003"),
        }
        maxOnWave = 5
    end
    if waveNumber == 46 then
        listID = {  -- паучиха
            FourCC("nsbm")
        }
        maxOnWave = 1
    end
    if waveNumber == 5 then
        local r = GetRandomInt(1, 4)
        if r == 1 then
            listID = {  -- Пуджи
                FourCC("uabo"), FourCC("uabo"), FourCC("uabo"),
                FourCC("uabo"), FourCC("uabo"), FourCC("uabo"),

            }
            maxOnWave = 3
        elseif r == 2 then
            listID = {
                FourCC("uzig"), FourCC("uzig")
            }
            maxOnWave = 2
        elseif r == 3 then
            listID = {
                FourCC("unec"), FourCC("unec"), FourCC("unec"),
                FourCC("unec"), FourCC("unec"), FourCC("unec"),
                FourCC("unec"), FourCC("unec"), FourCC("unec")
            }
            maxOnWave = 3
        elseif r == 4 then
            listID = {
                FourCC("ugar"), FourCC("ugar"), FourCC("ugar"), FourCC("ugar"), FourCC("ugar"), FourCC("ugar")

            }
            maxOnWave = 3
        end
    end
    if waveNumber >= 6 and waveNumber <= 20 then
        --рандомизатор
        listID = {}
        local zig = false
        local skel = false
        for i = 1, R2I(waveNumber * 2.6) do
            listID[i] = EnemyList[GetRandomInt(1, #EnemyList)]
            local r = GetRandomInt(1, 10)
            local r2 = GetRandomInt(1, 4)
            if waveNumber <= 11 then
                if listID[i] == FourCC("ugar") then
                    listID[i] = FourCC("unec")
                end
            end

            if waveNumber >= 12 then
                if not zig and r == 1 then
                    zig = true
                    listID[i] = FourCC("uzig")
                end
            end
            if waveNumber == 10 or waveNumber == 15 then
                if not skel and r2 == 1 then
                    skel = true
                    listID[i] = FourCC("u001")
                end
            end

        end
        maxOnWave = waveNumber // 2
        if maxOnWave >= 16 then
            maxOnWave = 16
        end
    end


    --

    if waveNumber == 14 then
        local r = GetRandomInt(1, 2)
        if r == 1 then
            listID = { --баньши и некры
                FourCC("uban"), FourCC("unec"), FourCC("uban"), FourCC("unec"),
                FourCC("uban"), FourCC("unec"), FourCC("uban"), FourCC("unec"),
                FourCC("uban"), FourCC("unec"), FourCC("uban"), FourCC("unec"),
                FourCC("uban"), FourCC("unec"), FourCC("uban"), FourCC("unec"),
                FourCC("uban"), FourCC("unec"), FourCC("uban"), FourCC("unec"),
                FourCC("uban"), FourCC("unec"), FourCC("uban"), FourCC("unec"),
            }
            maxOnWave = 7
        elseif r == 2 then
            listID = {
                FourCC("uzig"), FourCC("uzig"), FourCC("uban"), FourCC("uban"), FourCC("uban"),
                FourCC("uban"), FourCC("uban"), FourCC("uban"), FourCC("uban"), FourCC("uban"),
                FourCC("uban"), FourCC("uban"), FourCC("uban"), FourCC("uban"), FourCC("uban"),
            }
            maxOnWave = 6
        end
    end

    if waveNumber == 15 then
        local r = GetRandomInt(1, 3)
        if r == 1 then
            listID = {
                FourCC("ucs1"), FourCC("u000"), FourCC("ucs1"), FourCC("u000"), FourCC("ucs1"), FourCC("u000"),
                FourCC("ucs1"), FourCC("u000"), FourCC("ucs1"), FourCC("u000"), FourCC("ucs1"), FourCC("u000"),
                FourCC("ucs1"), FourCC("u000"), FourCC("ucs1"), FourCC("u000"), FourCC("ucs1"), FourCC("u000"),
            }
            maxOnWave = 7
        elseif r == 2 then
            listID = {
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
            }
            maxOnWave = 6
        elseif r == 3 then
            listID = {
                FourCC("uzig"), FourCC("uzig"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
                FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"), FourCC("u000"),
            }
            maxOnWave = 6
        end
    end

    --[[
    n001 мурлок
    n002 сирена
    n005 гвардеец
    n004 черепаха
    ]]

    if waveNumber == 21 then
        -- Новый биом
        local r = GetRandomInt(1, 4)
        if r == 1 then
            listID = { --мурлок
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            }
            maxOnWave = 6
        elseif r == 2 then
            listID = { -- нага
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            }
            maxOnWave = 6
        elseif r == 3 then
            listID = { -- нага гвардеец
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
            }
            maxOnWave = 5
        elseif r == 4 then
            listID = { -- черепаха
                FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"),
                FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"),
                FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"),
            }
            maxOnWave = 4
        end
        --print("если вывидите это сообщение, то вы в принципе уже победили")
    end

    if waveNumber == 22 then
        local r = GetRandomInt(1, 2)
        if r == 1 then
            listID = {
                FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            }
            maxOnWave = 6
        elseif r == 2 then
            listID = {
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            }
            maxOnWave = 6
        end
        --print("если вывидите это сообщение, то вы в принципе уже победили")
    end
    if waveNumber == 23 then
        local r = GetRandomInt(1, 2)
        if r == 1 then
            listID = { -- нага
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            }
            maxOnWave = 6
        elseif r == 2 then
            listID = {
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"), FourCC("n006"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            }
            maxOnWave = 6

        end

    end

    if waveNumber == 24 then
        local r = GetRandomInt(1, 3)
        if r == 1 then
            listID = {
                FourCC("n006"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
            }
            maxOnWave = 6
        elseif r == 2 then
            listID = {
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
                FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
                FourCC("n006"),
            }
            maxOnWave = 6
        elseif r == 3 then
            listID = {
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
                FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
                FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"), FourCC("n005"),
            }
            maxOnWave = 6
        end
    end

    if waveNumber == 25 then
        listID = { -- нага
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"), FourCC("n004"),
        }
        maxOnWave = 6
    end

    if waveNumber == 26 then
        listID = { -- нага
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
        }
        maxOnWave = 6
    end
    if waveNumber == 27 then
        listID = { -- нага
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
            FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"), FourCC("n001"),
            FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"), FourCC("n002"),
        }
        maxOnWave = 6
    end
    if waveNumber == 28 then

        local r = GetRandomInt(1, 3)
        if r == 1 then
            listID = {
                FourCC("n005"), FourCC("n005"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n006"), FourCC("n006"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n005"), FourCC("n005"),

            }
            maxOnWave = 7
        elseif r == 2 then
            listID = {
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n004"), FourCC("n004"),
            }
            maxOnWave = 7
        elseif r == 3 then
            listID = {
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n005"), FourCC("n005"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n002"), FourCC("n002"),
                FourCC("n002"), FourCC("n002"),
            }
            maxOnWave = 7
        end
    end

    if waveNumber == 401 then
        listID = {
            FourCC("uobs"), FourCC("uobs")
        }
        maxOnWave = 2
    end

    if listID[1] then
        StartWave(GameZone[Destiny[CurrentGameZone]], listID, maxOnWave)
    else
        listID = { FourCC("nsko") }
        StartWave(GameZone[Destiny[CurrentGameZone]], listID, 1)
        --print("В волне врагов "..waveNumber..", нет ни одного ID, так и задумано?")
    end
end

LiveOnWave = 0-- живые на волне
CurrentOnWave = 0

function GetActiveCountPlayer()
    local k = 0
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        if PlayerIsPlaying[i] then
            local data = HERO[i]
            local hero = data.UnitHero
            --local x,y=GetUnitXY(hero)
            if UnitAlive(hero) or data.life > 0 then
                k = k + 1
            end

        end
    end
    return k
end

function StartWave(dataGZ, listID, max)
    local angle = nil
    InFight = true
    -- print("start wave "..max)
    local rect = dataGZ.rectSpawn
    local CountPlayers = GetActiveCountPlayer()
    G_CountPlayers = CountPlayers
    if CountPlayers >= 2 then
        for _ = 2, CountPlayers do
            for i = 1, #listID do
                --table.insert(listID, listID[i]) -- отключено из за большо числа врагов
            end
        end
    end

    local MaxOnWave = #listID
    GMaxOnWave=MaxOnWave
    GLostOnWave=MaxOnWave
    LiveOnWave = 0
    --CurrentOnWave=max
    local k = 1
    --print(0)
    for i = 1, max do
        local loc = GetRandomLocInRect(rect)
        local x, y = GetLocationX(loc), GetLocationY(loc)
        if dataGZ.x[1] then
            --существует хотя бы первый элемент
            --print("есть ручные точки спавна "..#(dataGZ.x))
            local m = GetRandomInt(1, #(dataGZ.x))
            if dataGZ.x[m] then
                x, y = dataGZ.x[m], dataGZ.y[m]
                if dataGZ.angle[m] then
                    angle = dataGZ.angle[m]
                    --print("назначение угла", angle)
                else
                    --print("не могу получить угол для выпрыгивания из воды", m)
                end
            else
                print("Ошибка, не могу получить координаты " .. m)
            end
        end
        CreateCreepDelay(listID[k], x, y, 0.9, k, angle)
        --MaxOnWave=MaxOnWave-1
        k = k + 1
    end
    TimerStart(CreateTimer(), 1, true, function()
        --if LiveOnWave<max-1 and k<=MaxOnWave then


        --local loc=GetRandomLocInRect(rect)
        --local x,y=GetLocationX(loc),GetLocationY(loc)
        --CreateCreepDelay(listID[k],x,y,1.5,k)
        --k=k+1
        for i = 1, max do
            if LiveOnWave <= max - 1 and k <= MaxOnWave then
                --print("убит из пачки, создаём следующего"..k)
                local loc = GetRandomLocInRect(rect)
                local x, y = GetLocationX(loc), GetLocationY(loc)
                if dataGZ.x[1] then
                    --существует хотя бы первый элемент
                    local m = GetRandomInt(1, #(dataGZ.x))
                    x, y = dataGZ.x[m], dataGZ.y[m]
                    if dataGZ.angle[m] then
                        angle = dataGZ.angle[m]
                        --print("назначение угла 2", angle)

                    else
                        angle = nil
                        --print("не могу получить угол для выпрыгивания из воды", m)
                    end
                end
                CreateCreepDelay(listID[k], x, y, 0.9, k, angle)
                --MaxOnWave=MaxOnWave-1
                k = k + 1
            end
        end
        -- end
        if LiveOnWave <= 0 and k >= max then
            --print("все убиты даём награду")
            InFight = false
            local x, y = GetRectCenterX(rect), GetRectCenterY(rect)
            CreateGodTalon(x, y, GLOBAL_REWARD)
            ReviveAllHero()
            DestroyTimer(GetExpiredTimer())

            if CurrentGameZone == 20 then
                --print("переход в новый биом")
                Destiny = GetRandomIntTable(21, 24, 20)
                Destiny[21] = 21
                Destiny[22] = 22
                Destiny[23] = 23
                Destiny[24] = 24
                Destiny[25] = 25
                Destiny[26] = 26
                Destiny[27] = 27
                Destiny[28] = 28
                for i = 1, #Destiny do
                    -- print(Destiny[i])
                end
            end
        end
    end)
end
InFight = false

function CreateCreepDelay(id, x, y, delay, flag, angle)
    local eff = AddSpecialEffect("Hive\\Magic CirclePentagram\\Magic CirclePentagram Fire\\MagicCircle_Fire.mdl", x, y)

    local dataGZ = GameZone[Destiny[CurrentGameZone]]
    if flag ~= "summon" then
        LiveOnWave = LiveOnWave + 1
    else
        -- этот блок только для суммона

        if dataGZ then
            if dataGZ.x[1] then
                --существует хотя бы первый элемент
                -- print("есть ручные точки спавна " .. #(dataGZ.x))
                local m = GetRandomInt(1, #(dataGZ.x))
                if dataGZ.x[m] then
                    x, y = dataGZ.x[m], dataGZ.y[m]
                    --print("Проверка перед назначением угла", dataGZ.angle[m])
                    if not angle then
                        angle = dataGZ.angle[m]
                    end
                else
                    print("Ошибка, не могу получить координаты " .. m)
                end
            end
        else
            print(" данные для зоны не существуют", Destiny[CurrentGameZone])
        end
    end

    TimerStart(CreateTimer(), delay, false, function()
        --print("create new")
        local new = CreateUnit(Player(10), id, x, y, GetRandomInt(0, 360))
        local a = BlzGetUnitMaxHP(new)
        local k = 1.5
        if angle then
            --print("Прыжок из воды", angle)
            JumpOutWater(new, angle)
        end
        if G_CountPlayers >= 2 then

            BlzSetUnitMaxHP(new, R2I(a * k * G_CountPlayers))
            HealUnit(new)
        end
        if CurrentGameZone >= 9 then
            local r = GetRandomInt(1, 22 - CurrentGameZone)--
            if r == 1 then
                UnitAddShield(new, R2I(a * k * 2))
            end
        end

        if flag ~= "summon" then
            DestroyEffect(eff)
            TimerStart(CreateTimer(), delay, true, function()
                if not UnitAlive(new) then
                    DestroyTimer(GetExpiredTimer())
                    LiveOnWave = LiveOnWave - 1
                    GLostOnWave=GLostOnWave-1
                end
                --print(LiveOnWave[k])
            end)
        end
    end)
end

function JumpOutWater(unit, angle)
    local eff = AddSpecialEffect("SystemGeneric\\Torrent", GetUnitXY(unit))
    UnitDamageArea(unit, 50, GetUnitX(unit), GetUnitY(unit), 150)
    DestroyEffect(eff)
    BlzPauseUnitEx(unit, true)
    UnitAddJumpForce(unit, angle, 10, 500, 500)
end

function UnitAddJumpForce(hero, angle, speed, distance, MaxHeight)
    local currentdistance = 0
    local i = 0
    local ZStart = GetUnitZ(hero)
    if not MaxHeight then
        MaxHeight = 0
    end
    --SetUnitPathing(hero,false)
    UnitDisablePath(hero)
    TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
        currentdistance = currentdistance + speed
        local x, y = GetUnitXY(hero)
        local f = ParabolaZ(MaxHeight / 2, distance, i * speed) + ZStart
        SetUnitZ(hero, f)
        i = i + 1
        local newX, newY = MoveX(x, speed, angle), MoveY(y, speed, angle)
        --local perepad = GetUnitZ(hero) - GetTerrainZ(MoveXY(x, y, speed * 3, angle))
        SetUnitX(hero, newX)
        SetUnitY(hero, newY)

        if i > 3 and f <= GetTerrainZ(GetUnitXY(hero)) then
            DestroyTimer(GetExpiredTimer())
            BlzPauseUnitEx(hero, false)
            SetUnitTimeScale(hero, 1)
            --SetUnitPathing(hero,true)
            SetUnitZ(hero, 0)
            --print("приземлился")
            if UnitAlive(hero) then
                ResetUnitAnimation(hero)
            end

            if GetUnitTypeId(hero) == FourCC("n005") then
                if UnitDamageArea(hero, 150, newX, newY, 150) then
                    DestroyEffect(AddSpecialEffect("SystemGeneric\\ThunderclapCasterClassic", newX, newY))
                end
            end
        end
    end)
end

function UnitDisablePath(unit)
    UnitAddAbility(hero, FourCC("AInv"))
    UnitAddItemById(unit, FourCC("I000")) -- предмет виндволк
end
