---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 19.03.2021 2:07
---


function AddQuest(hero, qx, qy, message)
    local x, y = GetUnitX(hero), GetUnitY(hero)
    local model = "AneuCaster"
    local player = GetOwningPlayer(hero)
    local isEnd = false
    if GetLocalPlayer() ~= player then
        model = ""
    else
        --print("звук созданного квеста")
        StartSound(bj_questSecretSound)
    end
    --local QuestPointer = AddSpecialEffect(model, x, y)
    --BlzSetSpecialEffectPitch(QuestPointer, math.rad(-90))--/bj_DEGTORAD
    print(message)
    TimerStart(CreateTimer(), 0.5, false, function()
        CreateForUnitWayToPoint(hero, qx, qy)
    end)
    TimerStart(CreateTimer(), TIMER_PERIOD, true, function()
        local z = BlzGetLocalUnitZ(hero)
        local xc, yc = GetUnitX(hero), GetUnitY(hero)
        local angle = AngleBetweenXY(xc, yc, qx, qy)
        --BlzSetSpecialEffectPosition(QuestPointer, MoveX(xc, 130, angle / bj_DEGTORAD), MoveY(yc, 130, angle / bj_DEGTORAD), z + 10)
        --BlzSetSpecialEffectYaw(QuestPointer, angle)

        if IsUnitInRangeXY(hero, qx, qy, 200) then
            isEnd = true
        end

        if isEnd then
            if GetLocalPlayer() == player then
                StartSound(bj_questCompletedSound)
            end
            DestroyTimer(GetExpiredTimer())
            --DestroyEffect(QuestPointer)
            -- print("квест №" .. "1" .. " выполнен, даём награду")
        end
    end)
    TimerStart(CreateTimer(), 10, true, function()
        if isEnd then
            DestroyTimer(GetExpiredTimer())
            --print("Выключаем мигалку")
        else
            PingMinimapForPlayer(player, qx, qy, 3)
        end
    end)
end

--lastX=0
ShowWay=true
function CreateForUnitWayToPoint(hero, xEnd, yEnd)
    if not ShowWay then return end
    ShowWay=false
    local dummy = CreateUnit(GetOwningPlayer(hero), FourCC("ewsp"), GetUnitX(hero), GetUnitY(hero), AngleBetweenXY(GetUnitX(hero), GetUnitY(hero), xEnd, yEnd) / bj_DEGTORAD)
    if UnitAddAbility(dummy, FourCC("Aloc")) then
        --print("добавлено")
    else
        -- print("Нет")
    end
    SetUnitMoveSpeed(dummy, 1000)
    IssuePointOrder(dummy, "move", xEnd, yEnd)
    local i = 1
    local sec = 0
    local eff = {}
    local p = 0.12
    local lastX = GetUnitX(hero)
    local stay = false
    local t = CreateTimer()
    TimerStart(t, p, true, function()
        local x, y = GetUnitXY(dummy)
        local angle = GetUnitFacing(dummy)
        sec = sec + p
        if not IsUnitHidden(dummy) and not IsUnitInRangeXY(dummy, xEnd, yEnd, 30) then
            eff[i] = AddSpecialEffect("AneuCaster", x, y)  --"Abilities\\Spells\\Items\\AIco\\CrownOfCmndTarget.mdl"
            -- local angle=AngleBetweenXY(x,y,point[i-1].x,point[i-1].y)/bj_DEGTORAD
            BlzSetSpecialEffectYaw(eff[i], math.rad(angle))
            BlzSetSpecialEffectPitch(eff[i], math.rad(-90))
            BlzSetSpecialEffectZ(eff[i], BlzGetLocalUnitZ(hero) + 40)
            --print("eff "..i)
            i = i + 1
            if i == 4 then
                ShowUnit(dummy, false)
                ShowUnit(dummy, true)
            end
        end

        for k = 1, #eff do
            if IsUnitInRangeXY(hero, BlzGetLocalSpecialEffectX(eff[k]), BlzGetLocalSpecialEffectY(eff[k]), 50) then

                BlzSetSpecialEffectPosition(eff[k], 5000, 5000, 0)
            end
        end

        if lastX ~= GetUnitX(hero) then
            stay = true
            TimerStart(CreateTimer(), 6, false, function() -- время через которое удаляется квест, после того как юнит сдвинулся
                --print("Дамми дошёл до точки на скорости "..GetUnitMoveSpeed(dummy).." за "..sec.." секунд и за "..i.." шагов")
                for k = 1, #eff do
                    DestroyEffect(eff[k])
                end
                eff = {}
                i = 1
                ShowWay=true
                ShowUnit(dummy, false)
                DestroyTimer(t)
            end)
            --DestroyTimer(GetExpiredTimer())
        end

        if lastX == GetUnitX(hero) then
            if stay and false then
                stay = false
                KillUnit(dummy)
                dummy = CreateUnit(GetOwningPlayer(hero), FourCC("ewsp"), GetUnitX(hero), GetUnitY(hero), AngleBetweenXY(GetUnitX(hero), GetUnitY(hero), xEnd, yEnd) / bj_DEGTORAD)
                BlzSetUnitFacingEx(dummy, GetUnitFacing(hero))
                UnitAddAbility(dummy, FourCC("Aloc"))
                SetUnitMoveSpeed(dummy, 1000)
                SetUnitPosition(dummy, MoveXY(GetUnitX(hero), GetUnitY(hero), 60, GetUnitFacing(hero)))
                IssuePointOrder(dummy, "move", xEnd, yEnd)
            end
        end
        lastX = GetUnitX(hero)

        --print("записано "..GetUnitX(hero))
    end)
end